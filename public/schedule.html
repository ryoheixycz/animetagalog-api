<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Tagalog Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f8fafc;
        }
        
        /* Style for the schedule timeline */
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 50px;
            margin-bottom: 30px;
        }
        
        .timeline-item:before {
            content: '';
            position: absolute;
            top: 0;
            left: 15px;
            height: 100%;
            width: 2px;
            background: #e2e8f0;
        }
        
        .timeline-item:last-child:before {
            height: 50%;
        }
        
        .timeline-point {
            position: absolute;
            left: 0;
            top: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5 0%, #7e22ce 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            z-index: 2;
        }
        
        .timeline-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }
        
        .schedule-card {
            transition: all 0.3s;
            border: none;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .schedule-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .schedule-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .countdown {
            font-weight: 600;
        }
        
        .timer-section {
            display: inline-block;
            text-align: center;
            margin: 0 5px;
            font-weight: 700;
            min-width: 40px;
        }
        
        .timer-value {
            background-color: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
            padding: 5px 10px;
            border-radius: 6px;
            display: block;
            margin-bottom: 3px;
        }
        
        .timer-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #6b7280;
            font-weight: 500;
        }
        
        .airing-soon {
            border-left: 5px solid #f97316 !important;
        }
        
        .airing-today {
            border-left: 5px solid #10b981 !important;
        }
        
        .empty-schedule {
            text-align: center;
            padding: 50px 20px;
            background-color: #f9fafb;
            border-radius: 12px;
            border: 2px dashed #e5e7eb;
        }
    </style>
</head>
<body>
    <div id="schedule-view">
        <div class="page-header">
            <h1 class="page-title">Anime Schedule</h1>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" id="add-schedule-btn">
                    <i class="bi bi-plus-lg me-1"></i> Add Schedule
                </button>
                <button type="button" class="btn btn-light" id="refresh-schedule-btn">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                </button>
            </div>
        </div>
        
        <div class="row g-4 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="card stat-card primary-card h-100">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase text-muted mb-2 small">Upcoming</h6>
                                <h2 class="mb-0 fs-3 fw-semibold" id="upcoming-count">0</h2>
                            </div>
                            <div class="stat-icon stat-primary">
                                <i class="bi bi-calendar-event"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card stat-card success-card h-100">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase text-muted mb-2 small">Today</h6>
                                <h2 class="mb-0 fs-3 fw-semibold" id="today-count">0</h2>
                            </div>
                            <div class="stat-icon stat-success">
                                <i class="bi bi-calendar-check"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card stat-card info-card h-100">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase text-muted mb-2 small">This Week</h6>
                                <h2 class="mb-0 fs-3 fw-semibold" id="week-count">0</h2>
                            </div>
                            <div class="stat-icon stat-info">
                                <i class="bi bi-calendar-week"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card stat-card h-100" style="border-left: 5px solid #f59e0b;">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase text-muted mb-2 small">Scheduled Series</h6>
                                <h2 class="mb-0 fs-3 fw-semibold" id="series-count">0</h2>
                            </div>
                            <div class="stat-icon" style="background-color: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                                <i class="bi bi-collection"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar3 me-2"></i> Upcoming Episodes</span>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="show-compact-view" checked>
                    <label class="form-check-label" for="show-compact-view">Timeline View</label>
                </div>
            </div>
            <div class="card-body">
                <!-- Timeline View for schedules -->
                <div id="timeline-view">
                    <div class="timeline" id="schedule-timeline">
                        <!-- Schedule items will be populated here -->
                    </div>
                </div>
                
                <!-- Grid View for schedules -->
                <div id="grid-view" style="display: none;">
                    <div class="row g-4" id="schedule-grid">
                        <!-- Schedule cards will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Schedule Modal -->
    <div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addScheduleModalLabel">Add New Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addScheduleForm">
                        <div class="mb-3">
                            <label for="scheduleAnimeSelector" class="form-label">Select Anime</label>
                            <select class="form-select" id="scheduleAnimeSelector" required>
                                <option value="">Choose an anime...</option>
                                <!-- Anime options will be populated here -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="scheduleEpisodeNumber" class="form-label">Episode Number</label>
                            <input type="number" class="form-control" id="scheduleEpisodeNumber" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="scheduleAiringDate" class="form-label">Airing Date & Time</label>
                            <input type="datetime-local" class="form-control" id="scheduleAiringDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveScheduleBtn">
                        <i class="bi bi-calendar-plus me-1"></i> Add Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Schedule Modal -->
    <div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editScheduleModalLabel">Edit Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editScheduleForm">
                        <input type="hidden" id="editScheduleId">
                        <div class="mb-3">
                            <label for="editScheduleAnime" class="form-label">Anime</label>
                            <input type="text" class="form-control" id="editScheduleAnime" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="editScheduleEpisodeNumber" class="form-label">Episode Number</label>
                            <input type="number" class="form-control" id="editScheduleEpisodeNumber" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="editScheduleAiringDate" class="form-label">Airing Date & Time</label>
                            <input type="datetime-local" class="form-control" id="editScheduleAiringDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditScheduleBtn">
                        <i class="bi bi-check-lg me-1"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Schedule Confirmation Modal -->
    <div class="modal fade" id="deleteScheduleModal" tabindex="-1" aria-labelledby="deleteScheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteScheduleModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i> Are you sure you want to delete this schedule?
                    </div>
                    <p class="fw-medium" id="deleteScheduleInfo"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteScheduleBtn">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Schedule-specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle between timeline and grid view
            document.getElementById('show-compact-view').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('timeline-view').style.display = 'block';
                    document.getElementById('grid-view').style.display = 'none';
                } else {
                    document.getElementById('timeline-view').style.display = 'none';
                    document.getElementById('grid-view').style.display = 'block';
                }
            });
            
            // Add Schedule button
            document.getElementById('add-schedule-btn').addEventListener('click', function() {
                // Load anime list for the selector
                loadAnimeForScheduleSelector();
                // Clear form
                document.getElementById('addScheduleForm').reset();
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
                modal.show();
            });
            
            // Refresh Schedule button
            document.getElementById('refresh-schedule-btn').addEventListener('click', function() {
                showLoading();
                // Call refresh endpoint
                fetch(`${API_URL}/schedule/refresh`, {
                    method: 'POST'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to refresh schedule');
                    }
                    return response.json();
                })
                .then(result => {
                    showSuccess(`Schedule refreshed successfully. Found ${result.count} upcoming episodes.`);
                    loadScheduleData();
                })
                .catch(error => {
                    console.error('Error refreshing schedule:', error);
                    showError('Failed to refresh schedule: ' + error.message);
                })
                .finally(() => {
                    hideLoading();
                });
            });
            
            // Save new schedule
            document.getElementById('saveScheduleBtn').addEventListener('click', function() {
                const animeId = document.getElementById('scheduleAnimeSelector').value;
                const episodeNumber = document.getElementById('scheduleEpisodeNumber').value;
                const airingDate = document.getElementById('scheduleAiringDate').value;
                
                if (!animeId || !episodeNumber || !airingDate) {
                    showError('Please fill all required fields');
                    return;
                }
                
                const scheduleData = {
                    animeId,
                    episodeNumber,
                    airingDate: new Date(airingDate).toISOString()
                };
                
                showLoading();
                fetch(`${API_URL}/schedule`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scheduleData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to add schedule');
                    }
                    return response.json();
                })
                .then(newSchedule => {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addScheduleModal'));
                    modal.hide();
                    
                    showSuccess('Schedule added successfully');
                    loadScheduleData();
                })
                .catch(error => {
                    console.error('Error adding schedule:', error);
                    showError('Failed to add schedule: ' + error.message);
                })
                .finally(() => {
                    hideLoading();
                });
            });
            
            // Load anime options for schedule selector
            function loadAnimeForScheduleSelector() {
                showLoading();
                fetch(`${API_URL}/anime`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch anime list');
                        }
                        return response.json();
                    })
                    .then(animeList => {
                        const animeSelector = document.getElementById('scheduleAnimeSelector');
                        animeSelector.innerHTML = '<option value="">Choose an anime...</option>';
                        
                        animeList.forEach(anime => {
                            const option = document.createElement('option');
                            option.value = anime.id;
                            option.textContent = anime.title;
                            animeSelector.appendChild(option);
                        });
                        
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Error loading anime for schedule:', error);
                        showError('Failed to load anime list: ' + error.message);
                        hideLoading();
                    });
            }
            
            // Load schedule data
            function loadScheduleData() {
                showLoading();
                fetch(`${API_URL}/schedule`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch schedule');
                        }
                        return response.json();
                    })
                    .then(scheduleList => {
                        updateScheduleStats(scheduleList);
                        displayScheduleTimeline(scheduleList);
                        displayScheduleGrid(scheduleList);
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Error loading schedule:', error);
                        showError('Failed to load schedule: ' + error.message);
                        hideLoading();
                    });
            }
            
            // Update schedule statistics
            function updateScheduleStats(scheduleList) {
                const now = new Date();
                const todayEnd = new Date(now);
                todayEnd.setHours(23, 59, 59, 999);
                
                const weekEnd = new Date(now);
                weekEnd.setDate(now.getDate() + 7);
                
                const todayCount = scheduleList.filter(item => {
                    const airingDate = new Date(item.airingAt);
                    return airingDate >= now && airingDate <= todayEnd;
                }).length;
                
                const weekCount = scheduleList.filter(item => {
                    const airingDate = new Date(item.airingAt);
                    return airingDate >= now && airingDate <= weekEnd;
                }).length;
                
                const uniqueAnime = new Set(scheduleList.map(item => item.animeId)).size;
                
                document.getElementById('upcoming-count').textContent = scheduleList.length;
                document.getElementById('today-count').textContent = todayCount;
                document.getElementById('week-count').textContent = weekCount;
                document.getElementById('series-count').textContent = uniqueAnime;
            }
            
            // Display schedule in timeline format
            function displayScheduleTimeline(scheduleList) {
                const timelineContainer = document.getElementById('schedule-timeline');
                timelineContainer.innerHTML = '';
                
                if (scheduleList.length === 0) {
                    timelineContainer.innerHTML = `
                        <div class="empty-schedule">
                            <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
                            <h5>No Upcoming Episodes</h5>
                            <p class="text-muted">No scheduled episodes found. Add some or refresh from AniList.</p>
                        </div>
                    `;
                    return;
                }
                
                // Group by day
                const schedulesByDay = {};
                const now = new Date();
                
                scheduleList.forEach(schedule => {
                    const airingDate = new Date(schedule.airingAt);
                    const dateStr = airingDate.toDateString();
                    
                    if (!schedulesByDay[dateStr]) {
                        schedulesByDay[dateStr] = [];
                    }
                    
                    schedulesByDay[dateStr].push(schedule);
                });
                
                // Sort days
                const sortedDays = Object.keys(schedulesByDay).sort((a, b) => {
                    return new Date(a) - new Date(b);
                });
                
                // Display each day's schedules
                sortedDays.forEach(day => {
                    const dayDate = new Date(day);
                    const isToday = dayDate.toDateString() === now.toDateString();
                    const isTomorrow = dayDate.toDateString() === new Date(now.getTime() + 86400000).toDateString();
                    
                    let dayLabel = dayDate.toLocaleDateString(undefined, {
                        weekday: 'long',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    if (isToday) {
                        dayLabel = `Today - ${dayLabel}`;
                    } else if (isTomorrow) {
                        dayLabel = `Tomorrow - ${dayLabel}`;
                    }
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'mb-4';
                    dayHeader.innerHTML = `
                        <h5 class="fw-bold">
                            <i class="bi bi-calendar-date me-2"></i>
                            ${dayLabel}
                        </h5>
                    `;
                    timelineContainer.appendChild(dayHeader);
                    
                    // Sort schedules within the day by time
                    schedulesByDay[day].sort((a, b) => {
                        return new Date(a.airingAt) - new Date(b.airingAt);
                    });
                    
                    // Create timeline items for each schedule
                    schedulesByDay[day].forEach(schedule => {
                        const airingDate = new Date(schedule.airingAt);
                        const timeUntil = airingDate - now;
                        const isAiringSoon = timeUntil < 86400000; // 24 hours
                        
                        const formattedTime = airingDate.toLocaleTimeString(undefined, {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        const timelineItem = document.createElement('div');
                        timelineItem.className = `timeline-item ${isAiringSoon ? 'airing-soon' : ''} ${isToday ? 'airing-today' : ''}`;
                        timelineItem.innerHTML = `
                            <div class="timeline-point">
                                ${schedule.episodeNumber}
                            </div>
                            <div class="card schedule-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-auto">
                                            <h5 class="card-title mb-1">${schedule.animeTitle}</h5>
                                            <div class="text-muted small">Episode ${schedule.episodeNumber}</div>
                                        </div>
                                        <span class="badge bg-primary timeline-badge">
                                            <i class="bi bi-clock me-1"></i> ${formattedTime}
                                        </span>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <img src="${schedule.thumbnail}" class="schedule-thumbnail" alt="${schedule.animeTitle}">
                                        </div>
                                        <div class="col-md-8">
                                            <div class="mb-3 countdown" data-airing-at="${schedule.airingAt}">
                                                <div class="mb-2">Airing in:</div>
                                                <div class="d-flex align-items-center countdown-timer">
                                                    <div class="timer-section">
                                                        <span class="timer-value days">00</span>
                                                        <span class="timer-label">days</span>
                                                    </div>
                                                    <div class="timer-section">
                                                        <span class="timer-value hours">00</span>
                                                        <span class="timer-label">hours</span>
                                                    </div>
                                                    <div class="timer-section">
                                                        <span class="timer-value minutes">00</span>
                                                        <span class="timer-label">mins</span>
                                                    </div>
                                                    <div class="timer-section">
                                                        <span class="timer-value seconds">00</span>
                                                        <span class="timer-label">secs</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-end gap-2">
                                                <button class="btn btn-sm btn-outline-primary edit-schedule-btn" data-schedule-id="${schedule.id}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger delete-schedule-btn" 
                                                    data-schedule-id="${schedule.id}" 
                                                    data-anime-title="${schedule.animeTitle}" 
                                                    data-episode-number="${schedule.episodeNumber}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        timelineContainer.appendChild(timelineItem);
                    });
                });
                
                // Start countdown timers
                startCountdowns();
                
                // Add event listeners to edit and delete buttons
                addScheduleEventListeners();
            }
            
            // Display schedule in grid format
            function displayScheduleGrid(scheduleList) {
                const gridContainer = document.getElementById('schedule-grid');
                gridContainer.innerHTML = '';
                
                if (scheduleList.length === 0) {
                    gridContainer.innerHTML = `
                        <div class="col-12">
                            <div class="empty-schedule">
                                <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
                                <h5>No Upcoming Episodes</h5>
                                <p class="text-muted">No scheduled episodes found. Add some or refresh from AniList.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Sort schedules by airing date
                scheduleList.sort((a, b) => {
                    return new Date(a.airingAt) - new Date(b.airingAt);
                });
                
                const now = new Date();
                
                scheduleList.forEach(schedule => {
                    const airingDate = new Date(schedule.airingAt);
                    const timeUntil = airingDate - now;
                    const isAiringSoon = timeUntil < 86400000; // 24 hours
                    const isToday = airingDate.toDateString() === now.toDateString();
                    
                    const formattedDate = airingDate.toLocaleDateString(undefined, {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    const formattedTime = airingDate.toLocaleTimeString(undefined, {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const scheduleCard = document.createElement('div');
                    scheduleCard.className = 'col-xl-3 col-lg-4 col-md-6';
                    scheduleCard.innerHTML = `
                        <div class="card h-100 schedule-card ${isAiringSoon ? 'airing-soon' : ''} ${isToday ? 'airing-today' : ''}">
                            <img src="${schedule.thumbnail}" class="card-img-top" alt="${schedule.animeTitle}" 
                                style="height: 200px; object-fit: cover;">
                            <div class="card-body">
                                <h5 class="card-title">${schedule.animeTitle}</h5>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-primary">Episode ${schedule.episodeNumber}</span>
                                    <small class="text-muted">${formattedDate} at ${formattedTime}</small>
                                </div>
                                <div class="countdown mb-3" data-airing-at="${schedule.airingAt}">
                                    <div class="mb-2">Airing in:</div>
                                    <div class="d-flex align-items-center countdown-timer">
                                        <div class="timer-section">
                                            <span class="timer-value days">00</span>
                                            <span class="timer-label">days</span>
                                        </div>
                                        <div class="timer-section">
                                            <span class="timer-value hours">00</span>
                                            <span class="timer-label">hours</span>
                                        </div>
                                        <div class="timer-section">
                                            <span class="timer-value minutes">00</span>
                                            <span class="timer-label">mins</span>
                                        </div>
                                        <div class="timer-section">
                                            <span class="timer-value seconds">00</span>
                                            <span class="timer-label">secs</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end gap-2">
                                    <button class="btn btn-sm btn-outline-primary edit-schedule-btn" data-schedule-id="${schedule.id}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-schedule-btn" 
                                        data-schedule-id="${schedule.id}" 
                                        data-anime-title="${schedule.animeTitle}" 
                                        data-episode-number="${schedule.episodeNumber}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    gridContainer.appendChild(scheduleCard);
                });
                
                // Start countdown timers
                startCountdowns();
                
                // Add event listeners to edit and delete buttons
                addScheduleEventListeners();
            }
            
            // Start countdown timers for all schedule items
            function startCountdowns() {
                const countdowns = document.querySelectorAll('.countdown');
                
                // Update all countdowns immediately
                updateCountdowns();
                
                // Then update every second
                setInterval(updateCountdowns, 1000);
                
                function updateCountdowns() {
                    const now = new Date().getTime();
                    
                    countdowns.forEach(countdown => {
                        const airingAt = new Date(countdown.getAttribute('data-airing-at')).getTime();
                        const distance = airingAt - now;
                        
                        if (distance < 0) {
                            countdown.innerHTML = '<div class="alert alert-success mb-0">Now Airing!</div>';
                            return;
                        }
                        
                        // Time calculations
                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        
                        // Update the countdown display
                        countdown.querySelector('.days').textContent = days.toString().padStart(2, '0');
                        countdown.querySelector('.hours').textContent = hours.toString().padStart(2, '0');
                        countdown.querySelector('.minutes').textContent = minutes.toString().padStart(2, '0');
                        countdown.querySelector('.seconds').textContent = seconds.toString().padStart(2, '0');
                    });
                }
            }
            
            // Add event listeners to schedule edit and delete buttons
            function addScheduleEventListeners() {
                // Edit schedule buttons
                document.querySelectorAll('.edit-schedule-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const scheduleId = this.getAttribute('data-schedule-id');
                        openEditScheduleModal(scheduleId);
                    });
                });
                
                // Delete schedule buttons
                document.querySelectorAll('.delete-schedule-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const scheduleId = this.getAttribute('data-schedule-id');
                        const animeTitle = this.getAttribute('data-anime-title');
                        const episodeNumber = this.getAttribute('data-episode-number');
                        
                        // Set modal info
                        document.getElementById('deleteScheduleInfo').textContent = 
                            `${animeTitle} - Episode ${episodeNumber}`;
                        
                        // Set delete button data
                        document.getElementById('confirmDeleteScheduleBtn').setAttribute('data-schedule-id', scheduleId);
                        
                        // Show modal
                        const deleteModal = new bootstrap.Modal(document.getElementById('deleteScheduleModal'));
                        deleteModal.show();
                    });
                });
            }
            
            // Open edit schedule modal
            function openEditScheduleModal(scheduleId) {
                showLoading();
                fetch(`${API_URL}/schedule/${scheduleId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch schedule details');
                        }
                        return response.json();
                    })
                    .then(schedule => {
                        // Populate form
                        document.getElementById('editScheduleId').value = schedule.id;
                        document.getElementById('editScheduleAnime').value = schedule.animeTitle;
                        document.getElementById('editScheduleEpisodeNumber').value = schedule.episodeNumber;
                        
                        // Format the date for datetime-local input
                        const airingDate = new Date(schedule.airingAt);
                        const formattedDate = airingDate.toISOString().slice(0, 16);
                        document.getElementById('editScheduleAiringDate').value = formattedDate;
                        
                        // Show modal
                        const editModal = new bootstrap.Modal(document.getElementById('editScheduleModal'));
                        editModal.show();
                        
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Error fetching schedule details:', error);
                        showError('Failed to load schedule details: ' + error.message);
                        hideLoading();
                    });
            }
            
            // Save edited schedule
            document.getElementById('saveEditScheduleBtn').addEventListener('click', function() {
                const scheduleId = document.getElementById('editScheduleId').value;
                const episodeNumber = document.getElementById('editScheduleEpisodeNumber').value;
                const airingDate = document.getElementById('editScheduleAiringDate').value;
                
                if (!episodeNumber || !airingDate) {
                    showError('Please fill all required fields');
                    return;
                }
                
                const scheduleData = {
                    episodeNumber: parseInt(episodeNumber),
                    airingAt: new Date(airingDate).getTime()
                };
                
                showLoading();
                fetch(`${API_URL}/schedule/${scheduleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scheduleData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update schedule');
                    }
                    return response.json();
                })
                .then(updatedSchedule => {
                    // Close modal
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editScheduleModal'));
                    editModal.hide();
                    
                    showSuccess('Schedule updated successfully');
                    loadScheduleData();
                })
                .catch(error => {
                    console.error('Error updating schedule:', error);
                    showError('Failed to update schedule: ' + error.message);
                })
                .finally(() => {
                    hideLoading();
                });
            });
            
            // Delete schedule
            document.getElementById('confirmDeleteScheduleBtn').addEventListener('click', function() {
                const scheduleId = this.getAttribute('data-schedule-id');
                
                showLoading();
                fetch(`${API_URL}/schedule/${scheduleId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete schedule');
                    }
                    return response.json();
                })
                .then(result => {
                    // Close modal
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteScheduleModal'));
                    deleteModal.hide();
                    
                    showSuccess('Schedule deleted successfully');
                    loadScheduleData();
                })
                .catch(error => {
                    console.error('Error deleting schedule:', error);
                    showError('Failed to delete schedule: ' + error.message);
                })
                .finally(() => {
                    hideLoading();
                });
            });
            
            // Load schedule data on page load
            loadScheduleData();
        });
    </script>
</body>
</html>
