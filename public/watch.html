<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Anime - AnimeStream</title>
    <meta http-equiv="refresh" content="1800"> <!-- Refresh every 30 minutes to keep connection -->
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- Vidstack Player -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/vidstack@1.9.8/dist/vidstack.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vidstack@1.9.8/player/styles/default/theme.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vidstack@1.9.8/player/styles/default/layouts/video.min.css">
    
    <style>
        /* Base Styles */
        :root {
            --font-sans: 'Inter', ui-sans-serif, system-ui, sans-serif;
            
            /* Light Theme Colors */
            --background-light: 0 0% 100%;
            --foreground-light: 240 10% 3.9%;
            --card-light: 0 0% 100%;
            --card-foreground-light: 240 10% 3.9%;
            --popover-light: 0 0% 100%;
            --popover-foreground-light: 240 10% 3.9%;
            --primary-light: 240 5.9% 10%;
            --primary-foreground-light: 0 0% 98%;
            --secondary-light: 240 4.8% 95.9%;
            --secondary-foreground-light: 240 5.9% 10%;
            --muted-light: 240 4.8% 95.9%;
            --muted-foreground-light: 240 3.8% 46.1%;
            --accent-light: 240 4.8% 95.9%;
            --accent-foreground-light: 240 5.9% 10%;
            --destructive-light: 0 84.2% 60.2%;
            --destructive-foreground-light: 0 0% 98%;
            --border-light: 240 5.9% 90%;
            --input-light: 240 5.9% 90%;
            --ring-light: 240 5.9% 10%;
            
            /* Dark Theme Colors */
            --background-dark: 240 10% 3.9%;
            --foreground-dark: 0 0% 98%;
            --card-dark: 240 10% 3.9%;
            --card-foreground-dark: 0 0% 98%;
            --popover-dark: 240 10% 3.9%;
            --popover-foreground-dark: 0 0% 98%;
            --primary-dark: 0 0% 98%;
            --primary-foreground-dark: 240 5.9% 10%;
            --secondary-dark: 240 3.7% 15.9%;
            --secondary-foreground-dark: 0 0% 98%;
            --muted-dark: 240 3.7% 15.9%;
            --muted-foreground-dark: 240 5% 64.9%;
            --accent-dark: 240 3.7% 15.9%;
            --accent-foreground-dark: 0 0% 98%;
            --destructive-dark: 0 62.8% 30.6%;
            --destructive-foreground-dark: 0 0% 98%;
            --border-dark: 240 3.7% 15.9%;
            --input-dark: 240 3.7% 15.9%;
            --ring-dark: 240 4.9% 83.9%;
            
            /* Animations & Sizes */
            --radius: 0.5rem;
            --header-height: 4rem;
            --animation-duration: 0.2s;
        }
        
        /* Apply theme variables */
        :root {
            --background: var(--background-light);
            --foreground: var(--foreground-light);
            --card: var(--card-light);
            --card-foreground: var(--card-foreground-light);
            --popover: var(--popover-light);
            --popover-foreground: var(--popover-foreground-light);
            --primary: var(--primary-light);
            --primary-foreground: var(--primary-foreground-light);
            --secondary: var(--secondary-light);
            --secondary-foreground: var(--secondary-foreground-light);
            --muted: var(--muted-light);
            --muted-foreground: var(--muted-foreground-light);
            --accent: var(--accent-light);
            --accent-foreground: var(--accent-foreground-light);
            --destructive: var(--destructive-light);
            --destructive-foreground: var(--destructive-foreground-light);
            --border: var(--border-light);
            --input: var(--input-light);
            --ring: var(--ring-light);
        }
        
        .dark {
            --background: var(--background-dark);
            --foreground: var(--foreground-dark);
            --card: var(--card-dark);
            --card-foreground: var(--card-foreground-dark);
            --popover: var(--popover-dark);
            --popover-foreground: var(--popover-foreground-dark);
            --primary: var(--primary-dark);
            --primary-foreground: var(--primary-foreground-dark);
            --secondary: var(--secondary-dark);
            --secondary-foreground: var(--secondary-foreground-dark);
            --muted: var(--muted-dark);
            --muted-foreground: var(--muted-foreground-dark);
            --accent: var(--accent-dark);
            --accent-foreground: var(--accent-foreground-dark);
            --destructive: var(--destructive-dark);
            --destructive-foreground: var(--destructive-foreground-dark);
            --border: var(--border-dark);
            --input: var(--input-dark);
            --ring: var(--ring-dark);
        }
        
        html {
            font-family: var(--font-sans);
            scroll-behavior: smooth;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-family: var(--font-sans);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* Header Styles */
        .header {
            position: sticky;
            top: 0;
            background-color: hsl(var(--background));
            backdrop-filter: blur(8px);
            border-bottom: 1px solid hsl(var(--border));
            height: var(--header-height);
            z-index: 50;
            transition: background-color var(--animation-duration) ease,
                        border-color var(--animation-duration) ease;
        }
        
        .header-container {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            font-weight: 700;
            font-size: 1.25rem;
            color: hsl(var(--foreground));
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo i {
            color: hsl(var(--primary));
            font-size: 1.5rem;
        }
        
        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            font-weight: 500;
            font-size: 0.875rem;
            line-height: 1;
            height: 2.5rem;
            padding: 0 1rem;
            transition: all var(--animation-duration) ease;
            cursor: pointer;
            text-decoration: none;
            white-space: nowrap;
            gap: 0.5rem;
            border: 1px solid transparent;
        }
        
        .btn-icon {
            font-size: 1rem;
        }
        
        .btn-sm {
            height: 2rem;
            padding: 0 0.75rem;
            font-size: 0.8125rem;
        }
        
        .btn-lg {
            height: 3rem;
            padding: 0 1.5rem;
            font-size: 1rem;
        }
        
        .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        
        .btn-primary:hover {
            background-color: hsl(var(--primary) / 0.9);
        }
        
        .btn-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }
        
        .btn-secondary:hover {
            background-color: hsl(var(--secondary) / 0.8);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid hsl(var(--border));
            color: hsl(var(--foreground));
        }
        
        .btn-outline:hover {
            background-color: hsl(var(--secondary));
        }
        
        .btn-ghost {
            background-color: transparent;
            color: hsl(var(--foreground));
        }
        
        .btn-ghost:hover {
            background-color: hsl(var(--secondary));
        }
        
        /* Navigation */
        .nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .nav-link {
            text-decoration: none;
            color: hsl(var(--foreground));
            font-weight: 500;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: color var(--animation-duration) ease,
                        background-color var(--animation-duration) ease;
        }
        
        .nav-link:hover {
            color: hsl(var(--primary));
            background-color: hsl(var(--secondary) / 0.5);
        }
        
        .nav-link.active {
            font-weight: 600;
            color: hsl(var(--primary));
            background-color: hsl(var(--secondary));
        }
        
        /* Icon Buttons */
        .icon-button {
            background: none;
            border: none;
            cursor: pointer;
            color: hsl(var(--foreground));
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            transition: background-color var(--animation-duration) ease,
                        color var(--animation-duration) ease;
        }
        
        .icon-button:hover {
            background-color: hsl(var(--secondary));
            color: hsl(var(--primary));
        }
        
        .icon-button i {
            font-size: 1.25rem;
        }
        
        /* Mobile Navigation */
        .mobile-nav-toggle {
            display: none;
        }
        
        .mobile-nav {
            display: none;
        }
        
        /* Video Player Styles */
        media-player {
            --media-brand: hsl(var(--primary) / 0.8);
            --media-focus-ring: 0 0 0 3px hsl(var(--ring) / 0.4);
            width: 100%;
            aspect-ratio: 16 / 9;
            border-radius: var(--radius);
            overflow: hidden;
            background-color: black;
            box-shadow: 0 4px 20px -5px hsl(var(--foreground) / 0.2);
        }
        
        media-player::part(controls) {
            --media-control-background: rgba(0, 0, 0, 0.5);
            --media-control-hover-background: rgba(0, 0, 0, 0.7);
        }
        
        .video-container {
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
            margin-bottom: 2rem;
        }
        
        /* Server Selection Tabs */
        .server-tabs {
            display: flex;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        
        .server-tab {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all var(--animation-duration) ease;
        }
        
        .server-tab.active {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        
        .server-tab:hover:not(.active) {
            background-color: hsl(var(--secondary) / 0.8);
            border-color: hsl(var(--border));
        }
        
        .server-tab[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Anime Details Section */
        .anime-details-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .anime-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .anime-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
        }
        
        .anime-meta-item i {
            font-size: 1rem;
            color: hsl(var(--primary) / 0.8);
        }
        
        .genres-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .genre-tag {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .tag-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }
        
        .tagalog-badge {
            background-color: hsl(250 95% 60%);
            color: white;
        }
        
        .anime-description {
            color: hsl(var(--foreground) / 0.9);
            line-height: 1.7;
            margin-bottom: 2rem;
        }
        
        /* Episode List */
        .episode-section {
            background-color: hsl(var(--card));
            border-radius: var(--radius);
            border: 1px solid hsl(var(--border));
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .episode-header {
            padding: 1rem;
            border-bottom: 1px solid hsl(var(--border));
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: hsl(var(--secondary) / 0.5);
        }
        
        .episode-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .episode-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .episode-item {
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 0.75rem;
            cursor: pointer;
            transition: all var(--animation-duration) ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .episode-item:hover {
            background-color: hsl(var(--secondary));
            transform: translateY(-2px);
            border-color: hsl(var(--ring) / 0.3);
        }
        
        .episode-item.active {
            border-color: hsl(var(--primary));
            background-color: hsl(var(--primary) / 0.1);
        }
        
        .episode-number {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .episode-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .episode-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .episode-date {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
        }
        
        .episode-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            font-size: 0.7rem;
            font-weight: 500;
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }
        
        .episode-tag.tagalog {
            background-color: hsl(250 95% 60%);
            color: white;
        }
        
        /* Loader */
        .loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            gap: 1rem;
        }
        
        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid hsl(var(--secondary));
            border-radius: 50%;
            border-top-color: hsl(var(--primary));
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .debug-message {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            text-align: center;
            max-width: 90%;
        }
        
        /* Footer */
        .footer {
            background-color: hsl(var(--background));
            border-top: 1px solid hsl(var(--border));
            padding: 2rem 0;
            margin-top: 4rem;
        }
        
        .footer-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }
        
        .footer-section h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: hsl(var(--foreground));
        }
        
        .footer-links {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .footer-link {
            color: hsl(var(--muted-foreground));
            text-decoration: none;
            font-size: 0.875rem;
            transition: color var(--animation-duration) ease;
        }
        
        .footer-link:hover {
            color: hsl(var(--foreground));
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 2rem;
            margin-top: 2rem;
            border-top: 1px solid hsl(var(--border));
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
        }
        
        /* Utilities */
        .hidden {
            display: none !important;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .anime-details-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .episode-section {
                max-height: 400px;
            }
        }
        
        @media (max-width: 768px) {
            .header-container {
                justify-content: space-between;
            }
            
            .nav {
                display: none;
            }
            
            .search-container {
                display: none;
            }
            
            .mobile-nav-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                background: none;
                border: none;
                color: hsl(var(--foreground));
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 50%;
                cursor: pointer;
                transition: background-color var(--animation-duration) ease;
            }
            
            .mobile-nav-toggle:hover {
                background-color: hsl(var(--secondary));
            }
            
            .mobile-nav-toggle i {
                font-size: 1.5rem;
            }
            
            .mobile-nav {
                display: block;
                position: fixed;
                top: var(--header-height);
                left: 0;
                right: 0;
                bottom: 0;
                background-color: hsl(var(--background));
                padding: 1.5rem;
                transform: translateX(100%);
                transition: transform var(--animation-duration) ease;
                z-index: 40;
                border-top: 1px solid hsl(var(--border));
                overflow-y: auto;
            }
            
            .mobile-nav.show {
                transform: translateX(0);
            }
            
            .mobile-nav-links {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            
            .mobile-nav-link {
                color: hsl(var(--foreground));
                text-decoration: none;
                font-size: 1.125rem;
                font-weight: 500;
                padding: 0.75rem;
                border-radius: var(--radius);
                display: flex;
                align-items: center;
                gap: 0.75rem;
                transition: background-color var(--animation-duration) ease;
            }
            
            .mobile-nav-link:hover {
                background-color: hsl(var(--secondary));
            }
            
            .mobile-nav-link i {
                font-size: 1.25rem;
                color: hsl(var(--primary));
            }
            
            .episode-item {
                padding: 0.5rem;
                gap: 0.5rem;
            }
            
            .episode-number {
                width: 2rem;
                height: 2rem;
                font-size: 0.875rem;
            }
            
            .anime-meta {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
        }
        
        @media (max-width: 480px) {
            .server-tabs {
                flex-wrap: wrap;
            }
            
            .server-tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body class="dark">
    <!-- Header -->
    <header class="header">
        <div class="container header-container">
            <a href="/" class="logo">
                <i class="ph ph-play-circle"></i>
                <span>AnimeStream</span>
            </a>
            
            <nav class="nav">
                <a href="/" class="nav-link">Home</a>
                <a href="/#popular-section" class="nav-link">Popular</a>
                <a href="/#latest-section" class="nav-link">Latest</a>
                <a href="/#tagalog-section" class="nav-link">Tagalog Dub</a>
                <a href="/#upcoming-section" class="nav-link">Upcoming</a>
            </nav>
            
            <div class="header-actions flex items-center gap-4">
                <button class="icon-button" id="theme-toggle" aria-label="Toggle theme">
                    <i class="ph ph-sun"></i>
                </button>
                
                <button class="mobile-nav-toggle" id="mobile-nav-toggle" aria-label="Toggle mobile menu">
                    <i class="ph ph-list"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Mobile Navigation -->
    <div class="mobile-nav" id="mobile-nav">
        <div class="mobile-nav-links">
            <a href="/" class="mobile-nav-link">
                <i class="ph ph-house"></i>
                <span>Home</span>
            </a>
            <a href="/#popular-section" class="mobile-nav-link">
                <i class="ph ph-star"></i>
                <span>Popular</span>
            </a>
            <a href="/#latest-section" class="mobile-nav-link">
                <i class="ph ph-clock"></i>
                <span>Latest</span>
            </a>
            <a href="/#tagalog-section" class="mobile-nav-link">
                <i class="ph ph-microphone"></i>
                <span>Tagalog Dub</span>
            </a>
            <a href="/#upcoming-section" class="mobile-nav-link">
                <i class="ph ph-calendar"></i>
                <span>Upcoming</span>
            </a>
        </div>
    </div>
    
    <main class="container py-6">
        <!-- Player Section -->
        <section>
            <div class="loader-container" id="video-loader">
                <div class="loader"></div>
                <div class="debug-message" id="debug-message">Loading video player...</div>
            </div>
            
            <div class="video-container hidden" id="video-container">
                <div class="server-tabs" id="server-switch">
                    <button class="server-tab active" id="server1-btn">
                        <i class="ph ph-globe"></i> Server 1
                    </button>
                    <button class="server-tab" id="server2-btn">
                        <i class="ph ph-play"></i> Server 2
                    </button>
                </div>
                
                <!-- Vidstack Player -->
                <div id="player-container">
                    <media-player
                        id="media-player"
                        view-type="video"
                        stream-type="on-demand"
                        crossorigin
                        playsinline
                        autoplay
                        controls
                    >
                        <media-provider>
                            <media-poster class="vds-poster" id="media-poster"></media-poster>
                            <source src="" type="video/mp4" id="video-source" />
                            <!-- Tracks will be added dynamically if needed -->
                        </media-provider>
                        <media-video-layout></media-video-layout>
                    </media-player>
                </div>
                
                <!-- Fallback iframe for embedded player if needed -->
                <iframe 
                    id="embed-iframe" 
                    class="hidden" 
                    width="100%" 
                    height="480" 
                    frameborder="0" 
                    allowfullscreen
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                ></iframe>
            </div>
        </section>
        
        <!-- Anime Details -->
        <div class="anime-details-container">
            <!-- Anime Info -->
            <section>
                <div class="loader-container" id="anime-info-loader">
                    <div class="loader"></div>
                </div>
                
                <div class="hidden" id="anime-info-content">
                    <h1 class="text-3xl font-bold mb-4" id="anime-title"></h1>
                    
                    <div class="anime-meta">
                        <div class="anime-meta-item">
                            <i class="ph ph-film-strip"></i>
                            <span id="episode-count"></span>
                        </div>
                        <div class="anime-meta-item">
                            <i class="ph ph-star"></i>
                            <span id="anime-rating"></span>
                        </div>
                        <div class="anime-meta-item">
                            <i class="ph ph-clock"></i>
                            <span id="episode-duration"></span>
                        </div>
                        <div class="anime-meta-item">
                            <i class="ph ph-calendar"></i>
                            <span id="anime-year"></span>
                        </div>
                        <div class="anime-meta-item">
                            <i class="ph ph-flag"></i>
                            <span id="anime-status"></span>
                        </div>
                    </div>
                    
                    <div class="genres-list" id="anime-genres">
                        <!-- Genres will be added here -->
                    </div>
                    
                    <div class="tag-badge tagalog-badge hidden" id="tagalog-badge">
                        <i class="ph ph-microphone"></i>
                        <span>Tagalog Dub</span>
                    </div>
                    
                    <p class="anime-description" id="anime-description"></p>
                    
                    <div class="flex gap-4 flex-wrap">
                        <a href="/" class="btn btn-outline">
                            <i class="ph ph-arrow-left btn-icon"></i>
                            Back to Home
                        </a>
                        <button class="btn btn-primary" id="share-btn">
                            <i class="ph ph-share-network btn-icon"></i>
                            Share
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- Episode List -->
            <section class="episode-section">
                <div class="episode-header">
                    <h2><i class="ph ph-list-numbers"></i> Episodes</h2>
                </div>
                
                <div class="loader-container" id="episode-list-loader">
                    <div class="loader"></div>
                </div>
                
                <div class="episode-list" id="episode-list">
                    <!-- Episodes will be added here -->
                </div>
            </section>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-container">
                <div class="footer-section">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="ph ph-play-circle text-2xl"></i>
                        <h3 class="text-xl font-bold">AnimeStream</h3>
                    </div>
                    <p class="text-sm text-muted-foreground mb-4">Your ultimate destination for anime streaming with Tagalog dubbed content.</p>
                </div>
                
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <div class="footer-links">
                        <a href="/" class="footer-link">Home</a>
                        <a href="/#popular-section" class="footer-link">Popular Anime</a>
                        <a href="/#latest-section" class="footer-link">Latest Episodes</a>
                        <a href="/#tagalog-section" class="footer-link">Tagalog Dub</a>
                        <a href="/#upcoming-section" class="footer-link">Upcoming Releases</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>Genres</h3>
                    <div class="footer-links">
                        <a href="#" class="footer-link">Action</a>
                        <a href="#" class="footer-link">Romance</a>
                        <a href="#" class="footer-link">Comedy</a>
                        <a href="#" class="footer-link">Drama</a>
                        <a href="#" class="footer-link">Fantasy</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>Legal</h3>
                    <div class="footer-links">
                        <a href="#" class="footer-link">Privacy Policy</a>
                        <a href="#" class="footer-link">Terms of Service</a>
                        <a href="#" class="footer-link">DMCA</a>
                        <a href="#" class="footer-link">Contact Us</a>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 AnimeStream. All rights reserved.</p>
            </div>
        </div>
    </footer>
    
    <!-- Scripts -->
    <script src="/js/persistence.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize persistence manager to keep data even on Render free tier restarts
            const persistenceManager = new AnimePersistenceManager('');
            persistenceManager.startKeepAlive();
            
            // Get anime ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const animeId = urlParams.get('id');
            const episodeId = urlParams.get('ep');
            
            if (!animeId) {
                window.location.href = '/'; // Redirect to home if no anime ID
                return;
            }
            
            // Register custom elements if needed (for older browsers)
            if (customElements && !customElements.get('media-player')) {
                console.log('Waiting for Vidstack custom elements to register...');
            }
            
            // Setup theme toggle
            setupThemeToggle();
            
            // Setup mobile navigation
            setupMobileNav();
            
            // Setup server switching
            setupServerSwitching();
            
            // Setup share button
            setupShareButton();
            
            // Fetch anime details and episodes
            fetchAnimeDetails(animeId);
            fetchAnimeEpisodes(animeId, episodeId);
        });
        
        // Fetch anime details
        function fetchAnimeDetails(animeId) {
            const animeInfoLoader = document.getElementById('anime-info-loader');
            const animeInfoContent = document.getElementById('anime-info-content');
            
            fetch(`/api/anime/${animeId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Anime not found');
                    }
                    return response.json();
                })
                .then(anime => {
                    // Set page title
                    document.title = `${anime.title} - AnimeStream`;
                    
                    // Populate anime details
                    document.getElementById('anime-title').textContent = anime.title;
                    document.getElementById('episode-count').textContent = `${anime.episodeCount} Episodes`;
                    document.getElementById('anime-rating').textContent = `${anime.rating.toFixed(1)}/10`;
                    document.getElementById('episode-duration').textContent = `${anime.duration} min`;
                    document.getElementById('anime-year').textContent = anime.startDate ? new Date(anime.startDate).getFullYear() : 'Unknown';
                    document.getElementById('anime-status').textContent = anime.status;
                    document.getElementById('anime-description').textContent = anime.description || 'No description available.';
                    
                    // Show Tagalog badge if applicable
                    if (anime.hasTagalogDub) {
                        document.getElementById('tagalog-badge').classList.remove('hidden');
                    }
                    
                    // Add genres
                    const genresContainer = document.getElementById('anime-genres');
                    genresContainer.innerHTML = '';
                    
                    anime.genres.forEach(genre => {
                        const genreTag = document.createElement('div');
                        genreTag.className = 'genre-tag';
                        genreTag.textContent = genre;
                        genresContainer.appendChild(genreTag);
                    });
                    
                    // Set poster for media player
                    document.getElementById('media-poster').setAttribute('src', anime.thumbnail);
                    
                    // Hide loader and show content
                    animeInfoLoader.classList.add('hidden');
                    animeInfoContent.classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error fetching anime details:', error);
                    animeInfoLoader.innerHTML = `
                        <div class="text-center">
                            <p class="mb-4">Failed to load anime details: ${error.message}</p>
                            <a href="/" class="btn btn-primary">Go Back Home</a>
                        </div>
                    `;
                });
        }
        
        // Fetch anime episodes
        function fetchAnimeEpisodes(animeId, selectedEpisodeId = null) {
            const episodeListLoader = document.getElementById('episode-list-loader');
            const episodeList = document.getElementById('episode-list');
            
            fetch(`/api/anime/${animeId}/episodes`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch episodes');
                    }
                    return response.json();
                })
                .then(episodes => {
                    // Sort episodes by number
                    episodes.sort((a, b) => a.number - b.number);
                    
                    if (episodes.length === 0) {
                        episodeList.innerHTML = `<p class="text-center p-4">No episodes available yet.</p>`;
                        episodeListLoader.classList.add('hidden');
                        return;
                    }
                    
                    // Populate episode list
                    episodeList.innerHTML = '';
                    
                    episodes.forEach(episode => {
                        const episodeItem = document.createElement('div');
                        episodeItem.className = 'episode-item';
                        episodeItem.dataset.id = episode.id;
                        episodeItem.dataset.iframeSrc = episode.iframeSrc || '';
                        episodeItem.dataset.server2Url = episode.server2Url || '';
                        
                        // Format date
                        const date = new Date(episode.dateAdded);
                        const formattedDate = date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        
                        episodeItem.innerHTML = `
                            <div class="episode-number">${episode.number}</div>
                            <div class="episode-info">
                                <div class="episode-title">${episode.title || `Episode ${episode.number}`}</div>
                                <div class="episode-date">Added ${formattedDate}</div>
                            </div>
                            ${episode.hasTagalogDub ? '<div class="episode-tag tagalog">Tagalog</div>' : ''}
                        `;
                        
                        // Add click event
                        episodeItem.addEventListener('click', function() {
                            playEpisode(episode);
                            
                            // Update URL without reloading
                            const url = new URL(window.location);
                            url.searchParams.set('ep', episode.id);
                            window.history.pushState({}, '', url);
                            
                            // Mark as active
                            document.querySelectorAll('.episode-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            this.classList.add('active');
                        });
                        
                        episodeList.appendChild(episodeItem);
                    });
                    
                    // Hide loader
                    episodeListLoader.classList.add('hidden');
                    
                    // Play selected episode or first episode
                    if (selectedEpisodeId) {
                        const selectedEpisode = episodes.find(ep => ep.id === selectedEpisodeId);
                        if (selectedEpisode) {
                            playEpisode(selectedEpisode);
                            const episodeItem = document.querySelector(`.episode-item[data-id="${selectedEpisodeId}"]`);
                            if (episodeItem) episodeItem.classList.add('active');
                        } else {
                            playEpisode(episodes[0]);
                            const firstEpisodeItem = document.querySelector('.episode-item');
                            if (firstEpisodeItem) firstEpisodeItem.classList.add('active');
                        }
                    } else {
                        playEpisode(episodes[0]);
                        const firstEpisodeItem = document.querySelector('.episode-item');
                        if (firstEpisodeItem) firstEpisodeItem.classList.add('active');
                    }
                })
                .catch(error => {
                    console.error('Error fetching episodes:', error);
                    episodeListLoader.innerHTML = `
                        <div class="text-center p-4">
                            <p>Failed to load episodes: ${error.message}</p>
                        </div>
                    `;
                });
        }
        
        // Play episode
        function playEpisode(episode) {
            const videoLoader = document.getElementById('video-loader');
            const videoContainer = document.getElementById('video-container');
            const mediaPlayer = document.getElementById('media-player');
            const videoSource = document.getElementById('video-source');
            const embedIframe = document.getElementById('embed-iframe');
            const server1Btn = document.getElementById('server1-btn');
            const server2Btn = document.getElementById('server2-btn');
            const debugMessage = document.getElementById('debug-message');
            
            // Show loader
            videoLoader.classList.remove('hidden');
            videoContainer.classList.add('hidden');
            debugMessage.textContent = 'Loading video...';
            
            // Update server buttons visibility/state
            if (!episode.server2Url) {
                server2Btn.disabled = true;
                server2Btn.style.opacity = '0.5';
            } else {
                server2Btn.disabled = false;
                server2Btn.style.opacity = '1';
            }
            
            if (!episode.iframeSrc) {
                server1Btn.disabled = true;
                server1Btn.style.opacity = '0.5';
            } else {
                server1Btn.disabled = false;
                server1Btn.style.opacity = '1';
            }
            
            // Check which server to use
            const useServer1 = server1Btn.classList.contains('active');
            
            // Server 1 is for iFrame embed, Server 2 is for direct MP4 link
            if (useServer1 && episode.iframeSrc) {
                // Use iframe for embedded players
                debugMessage.textContent = 'Loading embedded player...';
                mediaPlayer.classList.add('hidden');
                embedIframe.classList.remove('hidden');
                embedIframe.src = episode.iframeSrc;
                
                // Wait a bit for iframe to load
                setTimeout(() => {
                    videoLoader.classList.add('hidden');
                    videoContainer.classList.remove('hidden');
                }, 1500);
            } else if (!useServer1 && episode.server2Url) {
                // Use direct MP4 link for Server 2 through our proxy
                debugMessage.textContent = 'Loading video stream...';
                mediaPlayer.classList.remove('hidden');
                embedIframe.classList.add('hidden');
                
                // Use our proxy for the video URL
                const proxyUrl = `/api/proxy/video?url=${encodeURIComponent(episode.server2Url)}`;
                
                // Get media provider and reset it to force video reload
                const mediaProvider = mediaPlayer.querySelector('media-provider');
                if (mediaProvider) {
                    // Clear and recreate the video element to ensure proper loading
                    mediaProvider.innerHTML = `
                        <media-poster class="vds-poster" src="${episode.thumbnail || ''}"></media-poster>
                        <source src="${proxyUrl}" type="video/mp4" />
                    `;
                } else {
                    // Fallback if we can't find the media provider
                    videoSource.setAttribute('src', proxyUrl);
                }
                
                // Force reload the media player
                try {
                    mediaPlayer.load();
                } catch (e) {
                    console.error('Error loading media player:', e);
                    debugMessage.textContent = 'Error loading player. Attempting to recover...';
                }
                
                // Listen for errors
                mediaPlayer.addEventListener('error', (event) => {
                    console.error('Media player error:', event);
                    debugMessage.textContent = 'Error loading video. Trying a different approach...';
                    
                    // Try a fallback approach - sometimes direct MP4 URLs need specific headers
                    const originalUrl = episode.server2Url;
                    debugMessage.textContent = `Trying direct URL...`;
                    
                    // Get media provider and reset it
                    const mediaProvider = mediaPlayer.querySelector('media-provider');
                    if (mediaProvider) {
                        mediaProvider.innerHTML = `
                            <media-poster class="vds-poster" src="${episode.thumbnail || ''}"></media-poster>
                            <source src="${originalUrl}" type="video/mp4" />
                        `;
                    } else {
                        videoSource.setAttribute('src', originalUrl);
                    }
                    
                    // Try reloading
                    try {
                        mediaPlayer.load();
                    } catch (e) {
                        console.error('Error reloading media player:', e);
                    }
                    
                    // Show the player after a delay
                    setTimeout(() => {
                        videoLoader.classList.add('hidden');
                        videoContainer.classList.remove('hidden');
                    }, 2000);
                }, { once: true });
                
                // Listen for successful loading
                mediaPlayer.addEventListener('can-play', () => {
                    videoLoader.classList.add('hidden');
                    videoContainer.classList.remove('hidden');
                    
                    try {
                        mediaPlayer.play().catch(e => console.log('Autoplay prevented:', e));
                    } catch (e) {
                        console.error('Error playing media:', e);
                    }
                }, { once: true });
                
                // Fallback timeout in case can-play event doesn't fire
                setTimeout(() => {
                    if (videoLoader.classList.contains('hidden')) return; // Already hidden
                    videoLoader.classList.add('hidden');
                    videoContainer.classList.remove('hidden');
                }, 5000);
            } else {
                // No valid sources available - show a demo video
                debugMessage.textContent = 'No video sources available. Loading demo...';
                mediaPlayer.classList.remove('hidden');
                embedIframe.classList.add('hidden');
                
                const demoUrl = "https://files.vidstack.io/sprite-fight/720p.mp4";
                
                // Get media provider and reset it
                const mediaProvider = mediaPlayer.querySelector('media-provider');
                if (mediaProvider) {
                    mediaProvider.innerHTML = `
                        <media-poster class="vds-poster" src="https://files.vidstack.io/sprite-fight/poster.webp"></media-poster>
                        <source src="${demoUrl}" type="video/mp4" />
                    `;
                } else {
                    videoSource.setAttribute('src', demoUrl);
                }
                
                // Force reload the media player
                try {
                    mediaPlayer.load();
                } catch (e) {
                    console.error('Error loading demo video:', e);
                }
                
                // Listen for errors with demo video
                mediaPlayer.addEventListener('error', (event) => {
                    console.error('Media player error with demo video:', event);
                    videoLoader.classList.add('hidden');
                    videoContainer.classList.remove('hidden');
                    
                    // Show a message about missing video
                    alert('No video source available for this episode. Please try another episode or server.');
                }, { once: true });
                
                // Listen for successful loading
                mediaPlayer.addEventListener('can-play', () => {
                    videoLoader.classList.add('hidden');
                    videoContainer.classList.remove('hidden');
                    
                    try {
                        mediaPlayer.play().catch(e => console.log('Autoplay prevented:', e));
                    } catch (e) {
                        console.error('Error playing demo media:', e);
                    }
                }, { once: true });
                
                // Fallback timeout
                setTimeout(() => {
                    if (videoLoader.classList.contains('hidden')) return; // Already hidden
                    videoLoader.classList.add('hidden');
                    videoContainer.classList.remove('hidden');
                }, 4000);
            }
            
            // Update episode title in player
            mediaPlayer.setAttribute('title', episode.title || `Episode ${episode.number}`);
            document.title = `${episode.title || `Episode ${episode.number}`} - AnimeStream`;
        }
        
        // Setup theme toggle
        function setupThemeToggle() {
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                if (savedTheme === 'light') {
                    html.classList.remove('dark');
                    themeToggle.innerHTML = '<i class="ph ph-moon"></i>';
                } else {
                    html.classList.add('dark');
                    themeToggle.innerHTML = '<i class="ph ph-sun"></i>';
                }
            }
            
            // Toggle theme
            themeToggle.addEventListener('click', function() {
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                    this.innerHTML = '<i class="ph ph-moon"></i>';
                } else {
                    html.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                    this.innerHTML = '<i class="ph ph-sun"></i>';
                }
            });
        }
        
        // Setup mobile navigation
        function setupMobileNav() {
            const mobileNavToggle = document.getElementById('mobile-nav-toggle');
            const mobileNav = document.getElementById('mobile-nav');
            const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
            
            mobileNavToggle.addEventListener('click', function() {
                mobileNav.classList.toggle('show');
                
                // Toggle icon
                if (mobileNav.classList.contains('show')) {
                    this.innerHTML = '<i class="ph ph-x"></i>';
                } else {
                    this.innerHTML = '<i class="ph ph-list"></i>';
                }
            });
            
            // Close mobile nav when clicking a link
            mobileNavLinks.forEach(link => {
                link.addEventListener('click', function() {
                    mobileNav.classList.remove('show');
                    mobileNavToggle.innerHTML = '<i class="ph ph-list"></i>';
                });
            });
        }
        
        // Setup server switching
        function setupServerSwitching() {
            const server1Btn = document.getElementById('server1-btn');
            const server2Btn = document.getElementById('server2-btn');
            
            server1Btn.addEventListener('click', function() {
                if (this.classList.contains('active') || this.disabled) return;
                
                // Update active state
                server1Btn.classList.add('active');
                server2Btn.classList.remove('active');
                
                // Get active episode
                const activeEpisode = document.querySelector('.episode-item.active');
                if (activeEpisode) {
                    const episodeId = activeEpisode.dataset.id;
                    
                    // Re-fetch episode details to switch server
                    fetch(`/api/episodes/${episodeId}`)
                        .then(response => response.json())
                        .then(episode => {
                            playEpisode(episode);
                        })
                        .catch(error => {
                            console.error('Error fetching episode:', error);
                            alert('Failed to switch server. Please try again.');
                        });
                }
            });
            
            server2Btn.addEventListener('click', function() {
                if (this.classList.contains('active') || this.disabled) return;
                
                // Update active state
                server2Btn.classList.add('active');
                server1Btn.classList.remove('active');
                
                // Get active episode
                const activeEpisode = document.querySelector('.episode-item.active');
                if (activeEpisode) {
                    const episodeId = activeEpisode.dataset.id;
                    
                    // Re-fetch episode details to switch server
                    fetch(`/api/episodes/${episodeId}`)
                        .then(response => response.json())
                        .then(episode => {
                            playEpisode(episode);
                        })
                        .catch(error => {
                            console.error('Error fetching episode:', error);
                            alert('Failed to switch server. Please try again.');
                        });
                }
            });
        }
        
        // Setup share button
        function setupShareButton() {
            const shareBtn = document.getElementById('share-btn');
            
            if (shareBtn) {
                shareBtn.addEventListener('click', function() {
                    // Get current URL
                    const url = window.location.href;
                    
                    // Check if Web Share API is available
                    if (navigator.share) {
                        navigator.share({
                            title: document.title,
                            url: url
                        })
                        .catch(error => {
                            console.error('Error sharing:', error);
                            fallbackShare(url);
                        });
                    } else {
                        fallbackShare(url);
                    }
                });
            }
            
            // Fallback sharing method
            function fallbackShare(url) {
                try {
                    // Try to copy to clipboard
                    navigator.clipboard.writeText(url)
                        .then(() => {
                            alert('Link copied to clipboard!');
                        })
                        .catch(err => {
                            console.error('Could not copy text: ', err);
                            
                            // Create temporary input for copying
                            const tempInput = document.createElement('input');
                            document.body.appendChild(tempInput);
                            tempInput.value = url;
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            
                            alert('Link copied to clipboard!');
                        });
                } catch (err) {
                    console.error('Sharing failed:', err);
                    prompt('Copy this link to share:', url);
                }
            }
        }
    </script>
</body>
</html>
