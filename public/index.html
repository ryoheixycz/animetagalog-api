<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Tagalog Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f8fafc;
        }
        
        /* Modern sidebar styling */
        .sidebar {
            background: linear-gradient(135deg, #4f46e5 0%, #7e22ce 100%);
            min-height: 100vh;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            z-index: 100;
            transition: all 0.3s;
        }
        
        /* Sidebar mobile handling */
        @media (max-width: 991.98px) {
            .sidebar {
                transform: translateX(-250px);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
            }
        }
        
        .main-content {
            margin-left: 250px;
            width: calc(100% - 250px);
            transition: all 0.3s;
        }
        
        .mobile-menu-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 101;
            background-color: rgba(79, 70, 229, 0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 991.98px) {
            .mobile-menu-toggle {
                display: flex;
            }
        }
        
        .sidebar-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.85rem 1.5rem;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            border-radius: 8px;
            margin: 0.25rem 0.75rem;
            text-decoration: none;
            font-weight: 500;
        }
        
        .sidebar-link:hover, .sidebar-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: #fff;
            transform: translateX(5px);
        }
        
        .sidebar-link i {
            margin-right: 12px;
            font-size: 1.2rem;
        }
        
        .sidebar-brand {
            color: #fff;
            font-weight: 600;
            font-size: 1.3rem;
            padding: 1.75rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }
        
        /* Modern card styling */
        .content {
            padding: 2rem 1.5rem;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }
        
        .card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }
        
        .stat-card {
            border-left: none !important;
            overflow: hidden;
            position: relative;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            border-radius: 6px 0 0 6px;
        }
        
        .stat-card.primary-card::before {
            background: linear-gradient(to bottom, #4f46e5, #7e22ce);
        }
        
        .stat-card.success-card::before {
            background: linear-gradient(to bottom, #10b981, #059669);
        }
        
        .stat-card.info-card::before {
            background: linear-gradient(to bottom, #0ea5e9, #0284c7);
        }
        
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: 600;
            padding: 1.25rem 1.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7e22ce 100%);
            border: none;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
        }
        
        .anime-card {
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            height: 100%;
        }
        
        .anime-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .anime-thumbnail {
            height: 250px;
            object-fit: cover;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            width: 100%;
            transition: opacity 0.3s;
        }
        
        .episode-item {
            background-color: #f9fafb;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            padding: 1rem;
            transition: all 0.3s;
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        
        .episode-item:hover {
            background-color: #f0f5ff;
            border-color: rgba(79, 70, 229, 0.1);
            transform: translateX(5px);
        }
        
        /* Loading spinner & overlay */
        #loadingSpinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        
        /* Search dropdown styling */
        .search-results {
            position: absolute;
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: none;
            padding: 0.5rem 0;
        }
        
        .search-result-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-item:hover {
            background-color: #f0f5ff;
        }
        
        /* Status indicator styling */
        #serverStatus {
            position: fixed;
            bottom: 15px;
            right: 15px;
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 13px;
            z-index: 999;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }
        
        .status-online {
            background-color: #10b981;
            color: white;
        }
        
        .status-offline {
            background-color: #ef4444;
            color: white;
        }
        
        #serverStatus::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            background-color: currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                opacity: 0.5;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
            100% {
                opacity: 0.5;
                transform: scale(0.8);
            }
        }
        
        /* Form controls */
        .form-control, .form-select {
            border-radius: 8px;
            padding: 0.6rem 1rem;
            border: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #a5b4fc;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        /* Badges and tags */
        .badge {
            font-weight: 500;
            padding: 0.35em 0.65em;
            border-radius: 6px;
        }
        
        /* Table styling */
        .table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }
        
        .table th {
            background-color: #f9fafb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
        }
        
        .table th, .table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table-responsive {
            border-radius: 12px;
            overflow: hidden;
        }
        
        /* Modal styling */
        .modal-content {
            border: none;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .modal-header {
            border-bottom: 1px solid #f3f4f6;
            padding: 1.25rem 1.5rem;
        }
        
        .modal-footer {
            border-top: 1px solid #f3f4f6;
            padding: 1.25rem 1.5rem;
        }
        
        /* Toast notification */
        .toast {
            border: none;
            border-radius: 12px;
            background-color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        .toast-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .toast-body {
            padding: 1rem;
        }
        
        /* Page header section */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .page-title {
            font-weight: 600;
            font-size: 1.5rem;
            color: #111827;
            margin-bottom: 0;
        }
        
        /* Custom indicators for stats */
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .stat-primary {
            background-color: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
        }
        
        .stat-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .stat-info {
            background-color: rgba(14, 165, 233, 0.1);
            color: #0ea5e9;
        }
        
        /* Badge for bulk episodes count */
        .badge-count {
            position: relative;
            top: -1px;
            background-color: #f3f4f6;
            color: #4b5563;
            font-weight: 600;
        }

        /* Style for the schedule timeline */
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 50px;
            margin-bottom: 30px;
        }
        
        .timeline-item:before {
            content: '';
            position: absolute;
            top: 0;
            left: 15px;
            height: 100%;
            width: 2px;
            background: #e2e8f0;
        }
        
        .timeline-item:last-child:before {
            height: 50%;
        }
        
        .timeline-point {
            position: absolute;
            left: 0;
            top: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5 0%, #7e22ce 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            z-index: 2;
        }
        
        .timeline-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }
        
        .schedule-card {
            transition: all 0.3s;
            border: none;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .schedule-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .schedule-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            transition: opacity 0.3s;
        }
        
        .countdown {
            font-weight: 600;
        }
        
        .timer-section {
            display: inline-block;
            text-align: center;
            margin: 0 5px;
            font-weight: 700;
            min-width: 40px;
        }
        
        .timer-value {
            background-color: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
            padding: 5px 10px;
            border-radius: 6px;
            display: block;
            margin-bottom: 3px;
        }
        
        .timer-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #6b7280;
            font-weight: 500;
        }
        
        .airing-soon {
            border-left: 5px solid #f97316 !important;
        }
        
        .airing-today {
            border-left: 5px solid #10b981 !important;
        }
        
        .empty-schedule {
            text-align: center;
            padding: 50px 20px;
            background-color: #f9fafb;
            border-radius: 12px;
            border: 2px dashed #e5e7eb;
        }

        /* Image loading states */
        .anime-thumbnail, .schedule-thumbnail {
            opacity: 0;
        }
        
        .anime-thumbnail.loaded, .schedule-thumbnail.loaded {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loadingSpinner">
        <div class="d-flex flex-column align-items-center">
            <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="text-white">Loading...</p>
        </div>
    </div>

    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="sidebarToggle">
        <i class="bi bi-list"></i>
    </button>

    <!-- Server Status Indicator -->
    <div id="serverStatus" class="status-offline">Connecting...</div>

    <div class="container-fluid p-0 d-flex">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <i class="bi bi-film me-2"></i> Anime Tagalog
            </div>
            <div class="mt-2">
                <a href="#" class="sidebar-link active" id="dashboard-link">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a href="#" class="sidebar-link" id="anime-link">
                    <i class="bi bi-film"></i> Anime Library
                </a>
                <a href="#" class="sidebar-link" id="add-anime-link">
                    <i class="bi bi-plus-circle"></i> Add Anime
                </a>
                <a href="#" class="sidebar-link" id="episodes-link">
                    <i class="bi bi-collection-play"></i> Episodes
                </a>
                <a href="#" class="sidebar-link" id="schedule-link">
                    <i class="bi bi-calendar3"></i> Schedule
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content">
                <!-- Dashboard View -->
                <div id="dashboard-view">
                    <div class="page-header">
                        <h1 class="page-title">Dashboard</h1>
                        <button type="button" class="btn btn-light" id="refresh-dashboard">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-xl-4 col-md-6 mb-4">
                            <div class="card stat-card primary-card h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-uppercase text-muted mb-2 small">Total Anime</h6>
                                            <h2 class="mb-0 fs-3 fw-semibold" id="total-anime">0</h2>
                                        </div>
                                        <div class="stat-icon stat-primary">
                                            <i class="bi bi-film"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-4 col-md-6 mb-4">
                            <div class="card stat-card success-card h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-uppercase text-muted mb-2 small">Total Episodes</h6>
                                            <h2 class="mb-0 fs-3 fw-semibold" id="total-episodes">0</h2>
                                        </div>
                                        <div class="stat-icon stat-success">
                                            <i class="bi bi-collection-play"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-4 col-md-6 mb-4">
                            <div class="card stat-card info-card h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-uppercase text-muted mb-2 small">Recent Updates</h6>
                                            <h2 class="mb-0 fs-3 fw-semibold" id="recent-updates">0</h2>
                                        </div>
                                        <div class="stat-icon stat-info">
                                            <i class="bi bi-clock-history"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upcoming Episodes Card -->
                    <div class="card mb-4">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <div>
                                <i class="bi bi-calendar3 me-2"></i>
                                <span>Upcoming Episodes</span>
                            </div>
                            <a href="#" id="view-all-schedule-btn" class="btn btn-sm btn-outline-primary">
                                View Schedule
                            </a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table mb-0">
                                    <thead>
                                        <tr>
                                            <th width="40%">Anime</th>
                                            <th width="15%">Episode</th>
                                            <th width="25%">Airing</th>
                                            <th width="20%">Countdown</th>
                                        </tr>
                                    </thead>
                                    <tbody id="upcoming-episodes-table">
                                        <!-- Upcoming episodes will be populated here -->
                                        <tr>
                                            <td colspan="4" class="text-center py-4">
                                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                                Loading upcoming episodes...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header d-flex align-items-center">
                            <i class="bi bi-table me-2"></i>
                            <span>Latest Updates</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table mb-0">
                                    <thead>
                                        <tr>
                                            <th width="10%">Type</th>
                                            <th>Title</th>
                                            <th width="15%">Added</th>
                                            <th width="10%">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="latest-updates-table">
                                        <!-- Latest updates will be populated here -->
                                        <tr>
                                            <td colspan="4" class="text-center py-4">
                                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                                Loading latest updates...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Anime Library View -->
                <div id="anime-view" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Anime Library</h1>
                        <button type="button" class="btn btn-primary" id="add-anime-btn">
                            <i class="bi bi-plus-lg me-1"></i> Add New Anime
                        </button>
                    </div>
                    
                    <div class="row" id="anime-list">
                        <!-- Anime cards will be populated here -->
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-3 text-muted">Loading anime library...</p>
                        </div>
                    </div>
                </div>

                <!-- Add Anime View -->
                <div id="add-anime-view" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Add New Anime</h1>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-search me-2"></i>
                            Search Anime on AniList
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <label for="animeSearch" class="form-label">Search by Title</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="animeSearch" placeholder="Enter anime title and press enter...">
                                    <div class="search-results" id="searchResults">
                                        <!-- Search results will be populated here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div id="selectedAnimeDetails" style="display: none;" class="mt-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-lg-3 col-md-4 mb-4 mb-md-0">
                                                <img id="selectedAnimeThumbnail" src="" alt="Anime Cover" class="img-fluid rounded shadow-sm">
                                            </div>
                                            <div class="col-lg-9 col-md-8">
                                                <h3 id="selectedAnimeTitle" class="mb-3 fw-bold"></h3>
                                                <p id="selectedAnimeDescription" class="text-muted"></p>
                                                <div class="d-flex flex-wrap gap-2 mb-3" id="selectedAnimeGenres">
                                                    <!-- Genres will be populated here -->
                                                </div>
                                                <div class="row g-3 mb-3">
                                                    <div class="col-sm-6 col-lg-3">
                                                        <div class="fw-medium">Episodes</div>
                                                        <span id="selectedAnimeEpisodes">-</span>
                                                    </div>
                                                    <div class="col-sm-6 col-lg-3">
                                                        <div class="fw-medium">Status</div>
                                                        <span id="selectedAnimeStatus">-</span>
                                                    </div>
                                                    <div class="col-sm-6 col-lg-3">
                                                        <div class="fw-medium">Season</div>
                                                        <span id="selectedAnimeSeason">-</span>
                                                    </div>
                                                    <div class="col-sm-6 col-lg-3">
                                                        <div class="fw-medium">Rating</div>
                                                        <span id="selectedAnimeRating">-</span>
                                                    </div>
                                                </div>
                                                <button class="btn btn-primary" id="addSelectedAnime">
                                                    <i class="bi bi-plus-circle me-1"></i> Add to Library
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Episodes View -->
                <div id="episodes-view" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Manage Episodes</h1>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <h5 class="mb-0">Select Anime</h5>
                                </div>
                                <div class="col-md-8">
                                    <select class="form-select" id="episodeAnimeSelector">
                                        <option value="">Choose an anime...</option>
                                        <!-- Anime options will be populated here -->
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="episodeManagementArea" style="display: none;">
                        <div class="row g-4">
                            <div class="col-lg-4">
                                <div class="card mb-4">
                                   <img id="episodeAnimeThumbnail" src="" class="card-img-top anime-thumbnail" alt="Anime Cover">
                                    <div class="card-body">
                                        <h5 id="episodeAnimeTitle" class="card-title fw-bold"></h5>
                                        <p id="episodeAnimeEpisodeCount" class="card-text text-muted"></p>
                                    </div>
                                </div>
                                
                                <!-- Simplified Episode Form -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <i class="bi bi-plus-circle me-2"></i>
                                        Add New Episode
                                    </div>
                                    <div class="card-body">
                                        <form id="addEpisodeForm">
                                            <div class="mb-3">
                                                <label for="iframeSrc" class="form-label">iFrame Source (optional)</label>
                                                <input type="text" class="form-control" id="iframeSrc" placeholder="Enter iframe embed URL">
                                            </div>
                                            <div class="mb-3">
                                                <label for="server2Url" class="form-label">Server 2 URL</label>
                                                <input type="text" class="form-control" id="server2Url" required placeholder="Enter direct video URL">
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="bi bi-plus-lg me-1"></i> Add Episode
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                
                                <!-- Bulk Episode Uploader -->
                                <div class="card">
                                    <div class="card-header">
                                        <i class="bi bi-cloud-upload me-2"></i>
                                        Bulk Add Episodes
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="bulkEpisodeHtml" class="form-label">Paste HTML Select with Episodes</label>
                                            <textarea class="form-control" id="bulkEpisodeHtml" rows="5" placeholder="<select id='episode-select'>...</select>"></textarea>
                                            <div class="form-text">Paste the HTML select element containing episode options with server2Url attributes.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="server1DefaultValue" class="form-label">Default Server 1 Value (optional)</label>
                                            <input type="text" class="form-control" id="server1DefaultValue" placeholder="Default value for data-server1">
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="replaceExisting">
                                            <label class="form-check-label" for="replaceExisting">Replace existing episodes</label>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-primary flex-grow-1" id="parseBulkEpisodesBtn">
                                                <i class="bi bi-code-slash me-1"></i> Parse 
                                                <span class="badge bg-light text-dark ms-1 badge-count" id="episodeCount">0</span>
                                            </button>
                                            <button type="button" class="btn btn-success flex-grow-1" id="uploadBulkEpisodesBtn" disabled>
                                                <i class="bi bi-cloud-upload me-1"></i> Upload
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <i class="bi bi-collection-play me-2"></i>
                                                Episodes List
                                            </div>
                                            <div class="text-muted small" id="episodes-count-display"></div>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="episodesList" class="p-3">
                                            <!-- Episodes will be populated here -->
                                            <div class="text-center py-5">
                                                <p class="text-muted">Select an anime to manage episodes</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule View -->
                <div id="schedule-view" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Anime Schedule</h1>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" id="add-schedule-btn">
                                <i class="bi bi-plus-lg me-1"></i> Add Schedule
                            </button>
                            <button type="button" class="btn btn-light" id="refresh-schedule-btn">
                                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="row g-4 mb-4">
                        <div class="col-xl-3 col-md-6">
                            <div class="card stat-card primary-card h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-uppercase text-muted mb-2 small">Upcoming</h6>
                                            <h2 class="mb-0 fs-3 fw-semibold" id="upcoming-count">0</h2>
                                        </div>
                                        <div class="stat-icon stat-primary">
                                            <i class="bi bi-calendar-event"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6">
                            <div class="card stat-card success-card h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-uppercase text-muted mb-2 small">Today</h6>
                                            <h2 class="mb-0 fs-3 fw-semibold" id="today-count">0</h2>
                                        </div>
                                        <div class="stat-icon stat-success">
                                            <i class="bi bi-calendar-check"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6">
                            <div class="card stat-card info-card h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-uppercase text-muted mb-2 small">This Week</h6>
                                            <h2 class="mb-0 fs-3 fw-semibold" id="week-count">0</h2>
                                        </div>
                                        <div class="stat-icon stat-info">
                                            <i class="bi bi-calendar-week"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6">
                            <div class="card stat-card h-100" style="border-left: 5px solid #f59e0b;">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-uppercase text-muted mb-2 small">Scheduled Series</h6>
                                            <h2 class="mb-0 fs-3 fw-semibold" id="series-count">0</h2>
                                        </div>
                                        <div class="stat-icon" style="background-color: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                                            <i class="bi bi-collection"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-calendar3 me-2"></i> Upcoming Episodes</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="show-compact-view" checked>
                                <label class="form-check-label" for="show-compact-view">Timeline View</label>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Timeline View for schedules -->
                            <div id="timeline-view">
                                <div class="timeline" id="schedule-timeline">
                                    <!-- Schedule items will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Grid View for schedules -->
                            <div id="grid-view" style="display: none;">
                                <div class="row g-4" id="schedule-grid">
                                    <!-- Schedule cards will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Episode Modal -->
    <div class="modal fade" id="editEpisodeModal" tabindex="-1" aria-labelledby="editEpisodeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editEpisodeModalLabel">Edit Episode</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editEpisodeForm">
                        <input type="hidden" id="editEpisodeId">
                        <!-- Simplified Edit Form -->
                        <div class="mb-3">
                            <label for="editIframeSrc" class="form-label">iFrame Source (optional)</label>
                            <input type="text" class="form-control" id="editIframeSrc">
                        </div>
                        <div class="mb-3">
                            <label for="editServer2Url" class="form-label">Server 2 URL</label>
                            <input type="text" class="form-control" id="editServer2Url" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditEpisodeBtn">
                        <i class="bi bi-check-lg me-1"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Episode Confirmation Modal -->
    <div class="modal fade" id="deleteEpisodeModal" tabindex="-1" aria-labelledby="deleteEpisodeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteEpisodeModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i> Are you sure you want to delete this episode?
                    </div>
                    <p class="fw-medium" id="deleteEpisodeInfo"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteEpisodeBtn">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Schedule Modal -->
    <div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addScheduleModalLabel">Add New Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addScheduleForm">
                        <div class="mb-3">
                            <label for="scheduleAnimeSelector" class="form-label">Select Anime</label>
                            <select class="form-select" id="scheduleAnimeSelector" required>
                                <option value="">Choose an anime...</option>
                                <!-- Anime options will be populated here -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="scheduleEpisodeNumber" class="form-label">Episode Number</label>
                            <input type="number" class="form-control" id="scheduleEpisodeNumber" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="scheduleAiringDate" class="form-label">Airing Date & Time</label>
                            <input type="datetime-local" class="form-control" id="scheduleAiringDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveScheduleBtn">
                        <i class="bi bi-calendar-plus me-1"></i> Add Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Schedule Modal -->
    <div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editScheduleModalLabel">Edit Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editScheduleForm">
                        <input type="hidden" id="editScheduleId">
                        <div class="mb-3">
                            <label for="editScheduleAnime" class="form-label">Anime</label>
                            <input type="text" class="form-control" id="editScheduleAnime" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="editScheduleEpisodeNumber" class="form-label">Episode Number</label>
                            <input type="number" class="form-control" id="editScheduleEpisodeNumber" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="editScheduleAiringDate" class="form-label">Airing Date & Time</label>
                            <input type="datetime-local" class="form-control" id="editScheduleAiringDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditScheduleBtn">
                        <i class="bi bi-check-lg me-1"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Schedule Confirmation Modal -->
    <div class="modal fade" id="deleteScheduleModal" tabindex="-1" aria-labelledby="deleteScheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteScheduleModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i> Are you sure you want to delete this schedule?
                    </div>
                    <p class="fw-medium" id="deleteScheduleInfo"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteScheduleBtn">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Preview Modal -->
    <div class="modal fade" id="bulkUploadPreviewModal" tabindex="-1" aria-labelledby="bulkUploadPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkUploadPreviewModalLabel">Episode Upload Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i> Review the episodes below before confirming upload.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Episode #</th>
                                    <th>Title</th>
                                    <th>Server 1</th>
                                    <th>Server 2</th>
                                </tr>
                            </thead>
                            <tbody id="bulkEpisodePreviewTable">
                                <!-- Episodes will be listed here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmBulkUploadBtn">
                        <i class="bi bi-cloud-upload me-1"></i> Confirm Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <i class="bi bi-exclamation-circle me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="errorToastBody">
                Something went wrong.
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <i class="bi bi-check-circle me-2"></i>
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="successToastBody">
                Operation successful.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // Backend API URL - automatically detect whether we're on localhost or deployed
        const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : '/api';
        
        // Initialize the sidebar toggle for mobile
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('show');
        });
        
        // Toast instances
        const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));
        const successToast = new bootstrap.Toast(document.getElementById('successToast'));
        
        // Utility function to show loading spinner
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'flex';
        }
        
        // Utility function to hide loading spinner
        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }
        
        // Utility function to show error notification
        function showError(message) {
            document.getElementById('errorToastBody').textContent = message;
            errorToast.show();
        }

        // Utility function to show success notification
        function showSuccess(message) {
            document.getElementById('successToastBody').textContent = message;
            successToast.show();
        }

        // Utility function for optimized images
        function getOptimizedImageUrl(originalUrl) {
            if (!originalUrl) return 'https://via.placeholder.com/350x500?text=No+Image';
            
            // For external images, use our proxy
            if (originalUrl.startsWith('http')) {
                return `${API_URL}/image/${encodeURIComponent(originalUrl)}`;
            }
            
            // For local images, return as-is
            return originalUrl;
        }
        
        // Server status check
        function checkServerStatus() {
            const statusElement = document.getElementById('serverStatus');
            
            fetch(`${window.location.origin}/health`)
                .then(response => {
                    if (response.ok) {
                        statusElement.className = 'status-online';
                        statusElement.textContent = 'Server Online';
                        return response.json();
                    } else {
                        throw new Error('Server Error');
                    }
                })
                .catch(error => {
                    statusElement.className = 'status-offline';
                    statusElement.textContent = 'Server Offline';
                });
        }
        
        // Check server status every 30 seconds
        setInterval(checkServerStatus, 30000);
        
        // Navigation logic
        document.getElementById('dashboard-link').addEventListener('click', function(e) {
            e.preventDefault();
            showView('dashboard-view');
            activateNavLink(this);
            loadDashboardData();
        });
        
        document.getElementById('anime-link').addEventListener('click', function(e) {
            e.preventDefault();
            showView('anime-view');
            activateNavLink(this);
            loadAnimeList();
        });
        
        document.getElementById('add-anime-link').addEventListener('click', function(e) {
            e.preventDefault();
            showView('add-anime-view');
            activateNavLink(this);
        });
        
        document.getElementById('episodes-link').addEventListener('click', function(e) {
            e.preventDefault();
            showView('episodes-view');
            activateNavLink(this);
            loadAnimeForEpisodes();
        });

        document.getElementById('schedule-link').addEventListener('click', function(e) {
            e.preventDefault();
            showView('schedule-view');
            activateNavLink(this);
            loadScheduleData();
        });
        
        document.getElementById('add-anime-btn').addEventListener('click', function() {
            showView('add-anime-view');
            activateNavLink(document.getElementById('add-anime-link'));
        });
        
        // Helper function to activate the correct nav link
        function activateNavLink(link) {
            // Remove active class from all links
            document.querySelectorAll('.sidebar-link').forEach(el => {
                el.classList.remove('active');
            });
            
            // Add active class to the clicked link
            link.classList.add('active');
            
            // On mobile, hide the sidebar after selection
            if (window.innerWidth < 992) {
                document.getElementById('sidebar').classList.remove('show');
            }
        }
        
        // Refresh dashboard
        document.getElementById('refresh-dashboard').addEventListener('click', function() {
            loadDashboardData();
        });
        
        // Function to show a specific view and hide others
        function showView(viewId) {
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('anime-view').style.display = 'none';
            document.getElementById('add-anime-view').style.display = 'none';
            document.getElementById('episodes-view').style.display = 'none';
            document.getElementById('schedule-view').style.display = 'none';
            
            document.getElementById(viewId).style.display = 'block';
        }
        
        // Load dashboard data with fixed episode counting
        function loadDashboardData() {
            showLoading();
            
            // Fetch anime list
            fetch(`${API_URL}/anime`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch anime list');
                    }
                    return response.json();
                })
                .then(animeList => {
                    document.getElementById('total-anime').textContent = animeList.length;
                    
                    // Fetch episodes - use a direct call to get all episodes
                    return fetch(`${API_URL}/episodes`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to fetch episodes');
                            }
                            return response.json();
                        });
                })
                .then(episodes => {
                    // Ensure episodes are unique by ID to avoid duplication
                    const uniqueEpisodes = Array.from(new Map(episodes.map(item => 
                        [item.id, item])).values());
                        
                    document.getElementById('total-episodes').textContent = uniqueEpisodes.length;
                    
                    // Sort episodes by date added (descending)
                    uniqueEpisodes.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
                    
                    // Display recent updates - use the unique episodes
                    document.getElementById('recent-updates').textContent = uniqueEpisodes.length > 0 ? 
                        Math.min(uniqueEpisodes.length, 5) : 0;
                    
                    // Populate latest updates table
                    const updatesTableBody = document.getElementById('latest-updates-table');
                    updatesTableBody.innerHTML = '';
                    
                    if (uniqueEpisodes.length === 0) {
                        updatesTableBody.innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <i class="bi bi-info-circle me-2 text-muted"></i>
                                    No updates found
                                </td>
                            </tr>
                        `;
                    } else {
                        // Get anime data for each episode - only show the most recent 5
                        const recentEpisodes = uniqueEpisodes.slice(0, 5);
                        const animePromises = recentEpisodes.map(episode => 
                            fetch(`${API_URL}/anime/${episode.animeId}`)
                                .then(response => {
                                    if (!response.ok) {
                                        return null;
                                    }
                                    return response.json();
                                })
                                .then(anime => {
                                    if (!anime) {
                                        return {
                                            episode: episode,
                                            anime: { title: 'Unknown Anime' }
                                        };
                                    }
                                    return {
                                        episode: episode,
                                        anime: anime
                                    };
                                })
                        );
                        
                        Promise.all(animePromises)
                            .then(results => {
                                results.forEach(result => {
                                    const dateAdded = new Date(result.episode.dateAdded);
                                    const formattedDate = dateAdded.toLocaleDateString(undefined, {
                                        year: 'numeric',
                                        month: 'short',
                                        day: 'numeric'
                                    });
                                    
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>
                                            <span class="badge bg-primary">Episode</span>
                                        </td>
                                        <td>
                                            <div class="fw-medium">${result.anime.title}</div>
                                            <small class="text-muted">Ep ${result.episode.number}: ${result.episode.title || 'Untitled'}</small>
                                        </td>
                                        <td>${formattedDate}</td>
                                        <td>
                                           <button class="btn btn-sm btn-outline-primary view-episode-btn" 
                                                data-anime-id="${result.episode.animeId}" 
                                                data-episode-id="${result.episode.id}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </td>
                                    `;
                                    updatesTableBody.appendChild(row);
                                });
                                
                                // Add event listeners to view buttons
                                document.querySelectorAll('.view-episode-btn').forEach(button => {
                                    button.addEventListener('click', function() {
                                        const animeId = this.getAttribute('data-anime-id');
                                        
                                        // Switch to episodes view
                                        showView('episodes-view');
                                        activateNavLink(document.getElementById('episodes-link'));
                                        
                                        // Load anime for episodes
                                        loadAnimeForEpisodes(animeId);
                                    });
                                });
                            })
                            .catch(error => {
                                console.error('Error loading episode details:', error);
                                updatesTableBody.innerHTML = `
                                    <tr>
                                        <td colspan="4" class="text-center text-danger py-4">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            Error loading episode details
                                        </td>
                                    </tr>
                                `;
                            });
                    }

                    // Load upcoming episodes for dashboard
                    loadUpcomingEpisodes();
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading dashboard data:', error);
                    showError('Failed to load dashboard data: ' + error.message);
                    hideLoading();
                });
        }

        // Load upcoming episodes in dashboard
        function loadUpcomingEpisodes() {
            fetch(`${API_URL}/schedule`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch schedule');
                    }
                    return response.json();
                })
                .then(scheduleList => {
                    const tableBody = document.getElementById('upcoming-episodes-table');
                    tableBody.innerHTML = '';
                    
                    if (scheduleList.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <i class="bi bi-info-circle me-2 text-muted"></i>
                                    No upcoming episodes scheduled
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // Sort by airing date
                    scheduleList.sort((a, b) => {
                        return new Date(a.airingAt) - new Date(b.airingAt);
                    });
                    
                    // Only show the next 5
                    scheduleList.slice(0, 5).forEach(schedule => {
                        const airingDate = new Date(schedule.airingAt);
                        const now = new Date();
                        const timeUntil = airingDate - now;
                        
                        const formattedDate = airingDate.toLocaleDateString(undefined, {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric'
                        });
                        
                        const formattedTime = airingDate.toLocaleTimeString(undefined, {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        // Format countdown
                        let countdownText = '';
                        if (timeUntil < 0) {
                            countdownText = '<span class="badge bg-success">Now Airing</span>';
                        } else {
                            const days = Math.floor(timeUntil / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((timeUntil % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            
                            if (days > 0) {
                                countdownText = `${days}d ${hours}h`;
                            } else {
                                const minutes = Math.floor((timeUntil % (1000 * 60 * 60)) / (1000 * 60));
                                countdownText = `${hours}h ${minutes}m`;
                            }
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="${getOptimizedImageUrl(schedule.thumbnail)}" alt="${schedule.animeTitle}" 
                                        class="me-2 rounded" style="width: 40px; height: 40px; object-fit: cover;">
                                    <div class="fw-medium">${schedule.animeTitle}</div>
                                </div>
                            </td>
                            <td>Ep ${schedule.episodeNumber}</td>
                            <td>${formattedDate} at ${formattedTime}</td>
                            <td>${countdownText}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Add event listener to view all button
                    document.getElementById('view-all-schedule-btn').addEventListener('click', function(e) {
                        e.preventDefault();
                        showView('schedule-view');
                        activateNavLink(document.getElementById('schedule-link'));
                    });
                })
                .catch(error => {
                    console.error('Error loading upcoming episodes:', error);
                    document.getElementById('upcoming-episodes-table').innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-danger py-4">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Error loading upcoming episodes
                            </td>
                        </tr>
                    `;
                });
        }
        
        // Load anime list for the library view
        function loadAnimeList() {
            showLoading();
            
            fetch(`${API_URL}/anime`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch anime list');
                    }
                    return response.json();
                })
                .then(animeList => {
                    const animeListContainer = document.getElementById('anime-list');
                    animeListContainer.innerHTML = '';
                    
                    if (animeList.length === 0) {
                        animeListContainer.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <i class="bi bi-collection fs-1 text-muted mb-3"></i>
                                <p class="text-muted">No anime found. Add some to get started!</p>
                                <button class="btn btn-primary mt-3" id="no-anime-add-btn">
                                    <i class="bi bi-plus-lg me-1"></i> Add Anime
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('no-anime-add-btn').addEventListener('click', function() {
                            showView('add-anime-view');
                            activateNavLink(document.getElementById('add-anime-link'));
                        });
                    } else {
                        animeList.forEach(anime => {
                            const card = document.createElement('div');
                            card.className = 'col-xl-3 col-lg-4 col-md-6 mb-4';
                            card.innerHTML = `
                                <div class="card h-100 anime-card" data-anime-id="${anime.id}">
                                    <img src="${getOptimizedImageUrl(anime.thumbnail)}" class="card-img-top anime-thumbnail" alt="${anime.title}" loading="lazy">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title fw-bold text-truncate">${anime.title}</h5>
                                        <div class="d-flex flex-wrap gap-1 mb-2">
                                            ${anime.genres.slice(0, 3).map(genre => 
                                                `<span class="badge bg-light text-dark">${genre}</span>`
                                            ).join('')}
                                            ${anime.genres.length > 3 ? `<span class="badge bg-light text-dark">+${anime.genres.length - 3}</span>` : ''}
                                        </div>
                                        <p class="card-text small mb-4">${anime.description ? anime.description.substring(0, 100) + '...' : 'No description available'}</p>
                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-light text-dark">
                                                    <i class="bi bi-collection-play me-1"></i> ${anime.episodeCount} episodes
                                                </span>
                                                <button class="btn btn-sm btn-primary manage-episodes-btn" data-anime-id="${anime.id}">
                                                    <i class="bi bi-pencil me-1"></i> Manage
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            animeListContainer.appendChild(card);
                        });
                        
                        // Add event listeners to manage episodes buttons
                        document.querySelectorAll('.manage-episodes-btn').forEach(button => {
                            button.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const animeId = this.getAttribute('data-anime-id');
                                
                                // Switch to episodes view
                                showView('episodes-view');
                                activateNavLink(document.getElementById('episodes-link'));
                                
                                // Load anime for episodes
                                loadAnimeForEpisodes(animeId);
                            });
                        });

                        // Handle image loading
                        document.querySelectorAll('.anime-thumbnail').forEach(img => {
                            if (img.complete) {
                                img.classList.add('loaded');
                            } else {
                                img.addEventListener('load', function() {
                                    this.classList.add('loaded');
                                });
                            }
                            
                            img.addEventListener('error', function() {
                                this.src = 'https://via.placeholder.com/350x500?text=No+Image';
                                this.classList.add('loaded');
                            });
                        });
                    }
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading anime list:', error);
                    showError('Failed to load anime list: ' + error.message);
                    hideLoading();
                });
        }
        
        // Search functionality for AniList
        const animeSearchInput = document.getElementById('animeSearch');
        const searchResultsContainer = document.getElementById('searchResults');
        
        animeSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            
            if (searchTerm.length < 3) {
                searchResultsContainer.style.display = 'none';
                return;
            }
            
            showLoading();
            // Search AniList API
            fetch(`${API_URL}/search?query=${encodeURIComponent(searchTerm)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Search failed');
                    }
                    return response.json();
                })
                .then(results => {
                    searchResultsContainer.innerHTML = '';
                    
                    if (results.length === 0) {
                        searchResultsContainer.innerHTML = `
                            <div class="search-result-item text-center">
                                <i class="bi bi-search me-1"></i>
                                No results found for "${searchTerm}"
                            </div>
                        `;
                    } else {
                        results.forEach(anime => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            resultItem.setAttribute('data-anime-id', anime.id);
                            resultItem.innerHTML = `
                                <div class="d-flex align-items-center">
                                    <img src="${getOptimizedImageUrl(anime.thumbnail)}" alt="${anime.title}" class="me-3 rounded" style="width: 50px; height: 70px; object-fit: cover;">
                                    <div>
                                        <div class="fw-medium">${anime.title}</div>
                                        <div class="d-flex align-items-center text-muted small">
                                            <span class="me-2">${anime.episodeCount} eps</span>
                                            <span class="badge ${getStatusBadgeClass(anime.status)}">${anime.status}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                            searchResultsContainer.appendChild(resultItem);
                            
                            resultItem.addEventListener('click', function() {
                                displaySelectedAnime(anime);
                                searchResultsContainer.style.display = 'none';
                                animeSearchInput.value = anime.title;
                            });
                        });
                    }
                    
                    searchResultsContainer.style.display = 'block';
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error searching anime:', error);
                    searchResultsContainer.innerHTML = `
                        <div class="search-result-item text-center text-danger">
                            <i class="bi bi-exclamation-circle me-1"></i>
                            Error searching. Please try again.
                        </div>
                    `;
                    searchResultsContainer.style.display = 'block';
                    hideLoading();
                });
        });
        
        // Helper function to get status badge class
        function getStatusBadgeClass(status) {
            status = status.toUpperCase();
            switch(status) {
                case 'FINISHED':
                case 'COMPLETED':
                    return 'bg-success text-white';
                case 'RELEASING':
                case 'AIRING':
                    return 'bg-primary text-white';
                case 'NOT_YET_RELEASED':
                case 'UPCOMING':
                    return 'bg-info text-white';
                case 'CANCELLED':
                    return 'bg-danger text-white';
                default:
                    return 'bg-secondary text-white';
            }
        }
        
        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!animeSearchInput.contains(e.target) && !searchResultsContainer.contains(e.target)) {
                searchResultsContainer.style.display = 'none';
            }
        });
        
        // Display selected anime details
        function displaySelectedAnime(anime) {
            const detailsContainer = document.getElementById('selectedAnimeDetails');
            const thumbnailElement = document.getElementById('selectedAnimeThumbnail');
            const titleElement = document.getElementById('selectedAnimeTitle');
            const descriptionElement = document.getElementById('selectedAnimeDescription');
            const genresContainer = document.getElementById('selectedAnimeGenres');
            const episodesElement = document.getElementById('selectedAnimeEpisodes');
            const statusElement = document.getElementById('selectedAnimeStatus');
            const seasonElement = document.getElementById('selectedAnimeSeason');
            const ratingElement = document.getElementById('selectedAnimeRating');
            
            thumbnailElement.src = getOptimizedImageUrl(anime.thumbnail);
            thumbnailElement.onerror = function() {
                this.src = 'https://via.placeholder.com/350x500?text=No+Image';
            };
            
            titleElement.textContent = anime.title;
            descriptionElement.textContent = anime.description || 'No description available';
            
            genresContainer.innerHTML = '';
            anime.genres.forEach(genre => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-light text-dark';
                badge.textContent = genre;
                genresContainer.appendChild(badge);
            });
            
            episodesElement.textContent = anime.episodeCount || 'Unknown';
            
            statusElement.innerHTML = `<span class="badge ${getStatusBadgeClass(anime.status)}">${anime.status || 'Unknown'}</span>`;
            
            seasonElement.textContent = anime.season ? `${anime.season} ${anime.startDate?.split('-')[0] || ''}` : 'Unknown';
            
            if (anime.rating) {
                const rating = parseFloat(anime.rating);
                ratingElement.innerHTML = `<div class="d-inline-flex align-items-center">
                    ${rating.toFixed(1)} 
                    <i class="bi bi-star-fill ms-1 text-warning"></i>
                </div>`;
            } else {
                ratingElement.textContent = 'N/A';
            }
            
            detailsContainer.style.display = 'block';
            
            // Add event listener to add anime button
            document.getElementById('addSelectedAnime').setAttribute('data-anime-id', anime.id);
        }
        
        // Add selected anime to library
        document.getElementById('addSelectedAnime').addEventListener('click', function() {
            const animeId = this.getAttribute('data-anime-id');
            
            if (!animeId) {
                showError('No anime selected');
                return;
            }
            
            showLoading();
            fetch(`${API_URL}/anime`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ anilistId: animeId })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => Promise.reject(error));
                }
                return response.json();
            })
            .then(newAnime => {
                showSuccess(`Successfully added "${newAnime.title}" to your library`);
                
                // Switch to episodes view to add episodes
                showView('episodes-view');
                activateNavLink(document.getElementById('episodes-link'));
                
                // Load anime for episodes and select the newly added one
                loadAnimeForEpisodes(animeId);
                
                // Clear search
                document.getElementById('animeSearch').value = '';
                document.getElementById('selectedAnimeDetails').style.display = 'none';
                hideLoading();
            })
            .catch(error => {
                console.error('Error adding anime:', error);
                showError(error.error || 'Failed to add anime');
                hideLoading();
            });
        });
        
        // Load anime list for episodes view
        function loadAnimeForEpisodes(selectedAnimeId = null) {
            showLoading();
            fetch(`${API_URL}/anime`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch anime list');
                    }
                    return response.json();
                })
                .then(animeList => {
                    const animeSelector = document.getElementById('episodeAnimeSelector');
                    animeSelector.innerHTML = '<option value="">Choose an anime...</option>';
                    
                    animeList.forEach(anime => {
                        const option = document.createElement('option');
                        option.value = anime.id;
                        option.textContent = anime.title;
                        
                        if (selectedAnimeId && anime.id === selectedAnimeId) {
                            option.selected = true;
                        }
                        
                        animeSelector.appendChild(option);
                    });
                    
                    if (selectedAnimeId) {
                        // Trigger change event to load episodes
                        const event = new Event('change');
                        animeSelector.dispatchEvent(event);
                    }
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading anime for episodes:', error);
                    showError('Failed to load anime list: ' + error.message);
                    hideLoading();
                });
        }
        
        // Handle anime selection for episodes
        document.getElementById('episodeAnimeSelector').addEventListener('change', function() {
            const animeId = this.value;
            const episodeManagementArea = document.getElementById('episodeManagementArea');
            
            if (!animeId) {
                episodeManagementArea.style.display = 'none';
                return;
            }
            
            showLoading();
            fetch(`${API_URL}/anime/${animeId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch anime details');
                    }
                    return response.json();
                })
                .then(anime => {
                    // Display anime details
                    const thumbnailElement = document.getElementById('episodeAnimeThumbnail');
                    thumbnailElement.src = getOptimizedImageUrl(anime.thumbnail);
                    thumbnailElement.onerror = function() {
                        this.src = 'https://via.placeholder.com/350x500?text=No+Image';
                    };
                    
                    document.getElementById('episodeAnimeTitle').textContent = anime.title;
                    document.getElementById('episodeAnimeEpisodeCount').textContent = `${anime.episodeCount} episodes`;
                    
                    // Load episodes for this anime
                    return fetch(`${API_URL}/anime/${animeId}/episodes`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to fetch episodes');
                            }
                            return response.json();
                        })
                        .then(episodes => {
                            displayEpisodes(episodes, anime);
                            
                            // Update episode count in UI
                            document.getElementById('episodes-count-display').textContent = 
                                `${episodes.length} episode${episodes.length !== 1 ? 's' : ''}`;
                                
                            episodeManagementArea.style.display = 'block';
                            hideLoading();

                            // Apply image loading class
                            if (thumbnailElement.complete) {
                                thumbnailElement.classList.add('loaded');
                            } else {
                                thumbnailElement.addEventListener('load', function() {
                                    this.classList.add('loaded');
                                });
                            }
                        });
                })
                .catch(error => {
                    console.error('Error loading anime details:', error);
                    showError('Failed to load anime details: ' + error.message);
                    hideLoading();
                });
        });
        
        // Display episodes list
        function displayEpisodes(episodes, anime) {
            const episodesContainer = document.getElementById('episodesList');
            episodesContainer.innerHTML = '';
            
            if (episodes.length === 0) {
                episodesContainer.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-collection fs-1 text-muted mb-3"></i>
                        <p class="text-muted">No episodes added yet. Add your first episode!</p>
                    </div>
                `;
                return;
            }
            
            // Sort episodes by number
            episodes.sort((a, b) => a.number - b.number);
            
            episodes.forEach(episode => {
                const dateAdded = new Date(episode.dateAdded);
                const formattedDate = dateAdded.toLocaleDateString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const episodeItem = document.createElement('div');
                episodeItem.className = 'episode-item';
                episodeItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-primary me-2">${episode.number}</span>
                                <span class="fw-medium">${episode.title || 'Untitled'}</span>
                            </div>
                            <div class="text-muted small mt-1">Added: ${formattedDate}</div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary edit-episode-btn me-1" data-episode-id="${episode.id}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-episode-btn" 
                                data-episode-id="${episode.id}" 
                                data-episode-number="${episode.number}" 
                                data-episode-title="${episode.title || 'Untitled'}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted d-block text-truncate">
                            <i class="bi bi-link-45deg me-1"></i> 
                            ${episode.server2Url || 'No server URL'}
                        </small>
                    </div>
                `;
                episodesContainer.appendChild(episodeItem);
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-episode-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const episodeId = this.getAttribute('data-episode-id');
                    openEditEpisodeModal(episodeId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-episode-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const episodeId = this.getAttribute('data-episode-id');
                    const episodeNumber = this.getAttribute('data-episode-number');
                    const episodeTitle = this.getAttribute('data-episode-title');
                    
                    // Set modal info
                    document.getElementById('deleteEpisodeInfo').textContent = 
                        `${anime.title} - Episode ${episodeNumber}: ${episodeTitle}`;
                    
                    // Set delete button data
                    document.getElementById('confirmDeleteEpisodeBtn').setAttribute('data-episode-id', episodeId);
                    
                    // Show modal
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteEpisodeModal'));
                    deleteModal.show();
                });
            });
        }
        
        // Load schedule data
        function loadScheduleData() {
            showLoading();
            fetch(`${API_URL}/schedule`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch schedule');
                    }
                    return response.json();
                })
                .then(scheduleList => {
                    updateScheduleStats(scheduleList);
                    displayScheduleTimeline(scheduleList);
                    displayScheduleGrid(scheduleList);
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading schedule:', error);
                    showError('Failed to load schedule: ' + error.message);
                    hideLoading();
                });
        }
        
        // Update schedule statistics
        function updateScheduleStats(scheduleList) {
            const now = new Date();
            const todayEnd = new Date(now);
            todayEnd.setHours(23, 59, 59, 999);
            
            const weekEnd = new Date(now);
            weekEnd.setDate(now.getDate() + 7);
            
            const todayCount = scheduleList.filter(item => {
                const airingDate = new Date(item.airingAt);
                return airingDate >= now && airingDate <= todayEnd;
            }).length;
            
            const weekCount = scheduleList.filter(item => {
                const airingDate = new Date(item.airingAt);
                return airingDate >= now && airingDate <= weekEnd;
            }).length;
            
            const uniqueAnime = new Set(scheduleList.map(item => item.animeId)).size;
            
            document.getElementById('upcoming-count').textContent = scheduleList.length;
            document.getElementById('today-count').textContent = todayCount;
            document.getElementById('week-count').textContent = weekCount;
            document.getElementById('series-count').textContent = uniqueAnime;
        }
        
        // Display schedule in timeline format
        function displayScheduleTimeline(scheduleList) {
            const timelineContainer = document.getElementById('schedule-timeline');
            timelineContainer.innerHTML = '';
            
            if (scheduleList.length === 0) {
                timelineContainer.innerHTML = `
                    <div class="empty-schedule">
                        <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
                        <h5>No Upcoming Episodes</h5>
                        <p class="text-muted">No scheduled episodes found. Add some or refresh from AniList.</p>
                    </div>
                `;
                return;
            }
            
            // Group by day
            const schedulesByDay = {};
            const now = new Date();
            
            scheduleList.forEach(schedule => {
                const airingDate = new Date(schedule.airingAt);
                const dateStr = airingDate.toDateString();
                
                if (!schedulesByDay[dateStr]) {
                    schedulesByDay[dateStr] = [];
                }
                
                schedulesByDay[dateStr].push(schedule);
            });
            
            // Sort days
            const sortedDays = Object.keys(schedulesByDay).sort((a, b) => {
                return new Date(a) - new Date(b);
            });
            
            // Display each day's schedules
            sortedDays.forEach(day => {
                const dayDate = new Date(day);
                const isToday = dayDate.toDateString() === now.toDateString();
                const isTomorrow = dayDate.toDateString() === new Date(now.getTime() + 86400000).toDateString();
                
                let dayLabel = dayDate.toLocaleDateString(undefined, {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric'
                });
                
                if (isToday) {
                    dayLabel = `Today - ${dayLabel}`;
                } else if (isTomorrow) {
                    dayLabel = `Tomorrow - ${dayLabel}`;
                }
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'mb-4';
                dayHeader.innerHTML = `
                    <h5 class="fw-bold">
                        <i class="bi bi-calendar-date me-2"></i>
                        ${dayLabel}
                    </h5>
                `;
                timelineContainer.appendChild(dayHeader);
                
                // Sort schedules within the day by time
                schedulesByDay[day].sort((a, b) => {
                    return new Date(a.airingAt) - new Date(b.airingAt);
                });
                
                // Create timeline items for each schedule
                schedulesByDay[day].forEach(schedule => {
                    const airingDate = new Date(schedule.airingAt);
                    const timeUntil = airingDate - now;
                    const isAiringSoon = timeUntil < 86400000; // 24 hours
                    
                    const formattedTime = airingDate.toLocaleTimeString(undefined, {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const timelineItem = document.createElement('div');
                    timelineItem.className = `timeline-item ${isAiringSoon ? 'airing-soon' : ''} ${isToday ? 'airing-today' : ''}`;
                    timelineItem.innerHTML = `
                        <div class="timeline-point">
                            ${schedule.episodeNumber}
                        </div>
                        <div class="card schedule-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="me-auto">
                                        <h5 class="card-title mb-1">${schedule.animeTitle}</h5>
                                        <div class="text-muted small">Episode ${schedule.episodeNumber}</div>
                                    </div>
                                    <span class="badge bg-primary timeline-badge">
                                        <i class="bi bi-clock me-1"></i> ${formattedTime}
                                    </span>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <img src="${getOptimizedImageUrl(schedule.thumbnail)}" class="schedule-thumbnail" alt="${schedule.animeTitle}" loading="lazy">
                                    </div>
                                    <div class="col-md-8">
                                        <div class="mb-3 countdown" data-airing-at="${schedule.airingAt}">
                                            <div class="mb-2">Airing in:</div>
                                            <div class="d-flex align-items-center countdown-timer">
                                                <div class="timer-section">
                                                    <span class="timer-value days">00</span>
                                                    <span class="timer-label">days</span>
                                                </div>
                                                <div class="timer-section">
                                                    <span class="timer-value hours">00</span>
                                                    <span class="timer-label">hours</span>
                                                </div>
                                                <div class="timer-section">
                                                    <span class="timer-value minutes">00</span>
                                                    <span class="timer-label">mins</span>
                                                </div>
                                                <div class="timer-section">
                                                    <span class="timer-value seconds">00</span>
                                                    <span class="timer-label">secs</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-end gap-2">
                                            <button class="btn btn-sm btn-outline-primary edit-schedule-btn" data-schedule-id="${schedule.id}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-schedule-btn" 
                                                data-schedule-id="${schedule.id}" 
                                                data-anime-title="${schedule.animeTitle}" 
                                                data-episode-number="${schedule.episodeNumber}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    timelineContainer.appendChild(timelineItem);
                });
            });
            
            // Start countdown timers
            startCountdowns();
            
            // Add event listeners to edit and delete buttons
            addScheduleEventListeners();

            // Handle image loading
            document.querySelectorAll('.schedule-thumbnail').forEach(img => {
                if (img.complete) {
                    img.classList.add('loaded');
                } else {
                    img.addEventListener('load', function() {
                        this.classList.add('loaded');
                    });
                }
                
                img.addEventListener('error', function() {
                    this.src = 'https://via.placeholder.com/350x500?text=No+Image';
                    this.classList.add('loaded');
                });
            });
        }
        
        // Display schedule in grid format
        function displayScheduleGrid(scheduleList) {
            const gridContainer = document.getElementById('schedule-grid');
            gridContainer.innerHTML = '';
            
            if (scheduleList.length === 0) {
                gridContainer.innerHTML = `
                    <div class="col-12">
                        <div class="empty-schedule">
                            <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
                            <h5>No Upcoming Episodes</h5>
                            <p class="text-muted">No scheduled episodes found. Add some or refresh from AniList.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Sort schedules by airing date
            scheduleList.sort((a, b) => {
                return new Date(a.airingAt) - new Date(b.airingAt);
            });
            
            const now = new Date();
            
            scheduleList.forEach(schedule => {
                const airingDate = new Date(schedule.airingAt);
                const timeUntil = airingDate - now;
                const isAiringSoon = timeUntil < 86400000; // 24 hours
                const isToday = airingDate.toDateString() === now.toDateString();
                
                const formattedDate = airingDate.toLocaleDateString(undefined, {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
                
                const formattedTime = airingDate.toLocaleTimeString(undefined, {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const scheduleCard = document.createElement('div');
                scheduleCard.className = 'col-xl-3 col-lg-4 col-md-6';
                scheduleCard.innerHTML = `
                    <div class="card h-100 schedule-card ${isAiringSoon ? 'airing-soon' : ''} ${isToday ? 'airing-today' : ''}">
                        <img src="${getOptimizedImageUrl(schedule.thumbnail)}" class="card-img-top schedule-thumbnail" alt="${schedule.animeTitle}" 
                            style="height: 200px; object-fit: cover;" loading="lazy">
                        <div class="card-body">
                            <h5 class="card-title">${schedule.animeTitle}</h5>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge bg-primary">Episode ${schedule.episodeNumber}</span>
                                <small class="text-muted">${formattedDate} at ${formattedTime}</small>
                            </div>
                            <div class="countdown mb-3" data-airing-at="${schedule.airingAt}">
                                <div class="mb-2">Airing in:</div>
                                <div class="d-flex align-items-center countdown-timer">
                                    <div class="timer-section">
                                        <span class="timer-value days">00</span>
                                        <span class="timer-label">days</span>
                                    </div>
                                    <div class="timer-section">
                                        <span class="timer-value hours">00</span>
                                        <span class="timer-label">hours</span>
                                    </div>
                                    <div class="timer-section">
                                        <span class="timer-value minutes">00</span>
                                        <span class="timer-label">mins</span>
                                    </div>
                                    <div class="timer-section">
                                        <span class="timer-value seconds">00</span>
                                        <span class="timer-label">secs</span>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <button class="btn btn-sm btn-outline-primary edit-schedule-btn" data-schedule-id="${schedule.id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-schedule-btn" 
                                    data-schedule-id="${schedule.id}" 
                                    data-anime-title="${schedule.animeTitle}" 
                                    data-episode-number="${schedule.episodeNumber}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                gridContainer.appendChild(scheduleCard);
            });
            
            // Start countdown timers
            startCountdowns();
            
            // Add event listeners to edit and delete buttons
            addScheduleEventListeners();

            // Handle image loading
            document.querySelectorAll('.schedule-thumbnail').forEach(img => {
                if (img.complete) {
                    img.classList.add('loaded');
                } else {
                    img.addEventListener('load', function() {
                        this.classList.add('loaded');
                    });
                }
                
                img.addEventListener('error', function() {
                    this.src = 'https://via.placeholder.com/350x500?text=No+Image';
                    this.classList.add('loaded');
                });
            });
        }
        
        // Start countdown timers for all schedule items
        function startCountdowns() {
            const countdowns = document.querySelectorAll('.countdown');
            
            // Update all countdowns immediately
            updateCountdowns();
            
            // Then update every second
            setInterval(updateCountdowns, 1000);
            
            function updateCountdowns() {
                const now = new Date().getTime();
                
                countdowns.forEach(countdown => {
                    const airingAt = new Date(countdown.getAttribute('data-airing-at')).getTime();
                    const distance = airingAt - now;
                    
                    if (distance < 0) {
                        countdown.innerHTML = '<div class="alert alert-success mb-0">Now Airing!</div>';
                        return;
                    }
                    
                    // Time calculations
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    // Update the countdown display
                    const daysElement = countdown.querySelector('.days');
                    const hoursElement = countdown.querySelector('.hours');
                    const minutesElement = countdown.querySelector('.minutes');
                    const secondsElement = countdown.querySelector('.seconds');
                    
                    if (daysElement) daysElement.textContent = days.toString().padStart(2, '0');
                    if (hoursElement) hoursElement.textContent = hours.toString().padStart(2, '0');
                    if (minutesElement) minutesElement.textContent = minutes.toString().padStart(2, '0');
                    if (secondsElement) secondsElement.textContent = seconds.toString().padStart(2, '0');
                });
            }
        }
        
        // Add event listeners to schedule edit and delete buttons
        function addScheduleEventListeners() {
            // Edit schedule buttons
            document.querySelectorAll('.edit-schedule-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const scheduleId = this.getAttribute('data-schedule-id');
                    openEditScheduleModal(scheduleId);
                });
            });
            
            // Delete schedule buttons
            document.querySelectorAll('.delete-schedule-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const scheduleId = this.getAttribute('data-schedule-id');
                    const animeTitle = this.getAttribute('data-anime-title');
                    const episodeNumber = this.getAttribute('data-episode-number');
                    
                    // Set modal info
                    document.getElementById('deleteScheduleInfo').textContent = 
                        `${animeTitle} - Episode ${episodeNumber}`;
                    
                    // Set delete button data
                    document.getElementById('confirmDeleteScheduleBtn').setAttribute('data-schedule-id', scheduleId);
                    
                    // Show modal
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteScheduleModal'));
                    deleteModal.show();
                });
            });
        }
        
        // Toggle between timeline and grid view
        document.getElementById('show-compact-view').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('timeline-view').style.display = 'block';
                document.getElementById('grid-view').style.display = 'none';
            } else {
                document.getElementById('timeline-view').style.display = 'none';
                document.getElementById('grid-view').style.display = 'block';
            }
        });
        
        // Add Schedule button
        document.getElementById('add-schedule-btn').addEventListener('click', function() {
            // Load anime list for the selector
            loadAnimeForScheduleSelector();
            // Clear form
            document.getElementById('addScheduleForm').reset();
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
            modal.show();
        });
        
        // Refresh Schedule button
        document.getElementById('refresh-schedule-btn').addEventListener('click', function() {
            showLoading();
            // Call refresh endpoint
            fetch(`${API_URL}/schedule/refresh`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to refresh schedule');
                }
                return response.json();
            })
            .then(result => {
                showSuccess(`Schedule refreshed successfully. Found ${result.count} upcoming episodes.`);
                loadScheduleData();
            })
            .catch(error => {
                console.error('Error refreshing schedule:', error);
                showError('Failed to refresh schedule: ' + error.message);
            })
            .finally(() => {
                hideLoading();
            });
        });
        
        // Save new schedule
        document.getElementById('saveScheduleBtn').addEventListener('click', function() {
            const animeId = document.getElementById('scheduleAnimeSelector').value;
            const episodeNumber = document.getElementById('scheduleEpisodeNumber').value;
            const airingDate = document.getElementById('scheduleAiringDate').value;
            
            if (!animeId || !episodeNumber || !airingDate) {
                showError('Please fill all required fields');
                return;
            }
            
            const scheduleData = {
                animeId,
                episodeNumber,
                airingDate: new Date(airingDate).toISOString()
            };
            
            showLoading();
            fetch(`${API_URL}/schedule`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(scheduleData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to add schedule');
                }
                return response.json();
            })
            .then(newSchedule => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addScheduleModal'));
                modal.hide();
                
                showSuccess('Schedule added successfully');
                loadScheduleData();
            })
            .catch(error => {
                console.error('Error adding schedule:', error);
                showError('Failed to add schedule: ' + error.message);
            })
            .finally(() => {
                hideLoading();
            });
        });
        
        // Load anime options for schedule selector
        function loadAnimeForScheduleSelector() {
            showLoading();
            fetch(`${API_URL}/anime`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch anime list');
                    }
                    return response.json();
                })
                .then(animeList => {
                    const animeSelector = document.getElementById('scheduleAnimeSelector');
                    animeSelector.innerHTML = '<option value="">Choose an anime...</option>';
                    
                    animeList.forEach(anime => {
                        const option = document.createElement('option');
                        option.value = anime.id;
                        option.textContent = anime.title;
                        animeSelector.appendChild(option);
                    });
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading anime for schedule:', error);
                    showError('Failed to load anime list: ' + error.message);
                    hideLoading();
                });
        }
        
        // Open edit schedule modal
        function openEditScheduleModal(scheduleId) {
            showLoading();
            fetch(`${API_URL}/schedule/${scheduleId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch schedule details');
                    }
                    return response.json();
                })
                .then(schedule => {
                    // Populate form
                    document.getElementById('editScheduleId').value = schedule.id;
                    document.getElementById('editScheduleAnime').value = schedule.animeTitle;
                    document.getElementById('editScheduleEpisodeNumber').value = schedule.episodeNumber;
                    
                    // Format the date for datetime-local input
                    const airingDate = new Date(schedule.airingAt);
                    const formattedDate = airingDate.toISOString().slice(0, 16);
                    document.getElementById('editScheduleAiringDate').value = formattedDate;
                    
                    // Show modal
                    const editModal = new bootstrap.Modal(document.getElementById('editScheduleModal'));
                    editModal.show();
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error fetching schedule details:', error);
                    showError('Failed to load schedule details: ' + error.message);
                    hideLoading();
                });
        }
        
        // Save edited schedule
        document.getElementById('saveEditScheduleBtn').addEventListener('click', function() {
            const scheduleId = document.getElementById('editScheduleId').value;
            const episodeNumber = document.getElementById('editScheduleEpisodeNumber').value;
            const airingDate = document.getElementById('editScheduleAiringDate').value;
            
            if (!episodeNumber || !airingDate) {
                showError('Please fill all required fields');
                return;
            }
            
            const scheduleData = {
                episodeNumber: parseInt(episodeNumber),
                airingAt: new Date(airingDate).getTime()
            };
            
            showLoading();
            fetch(`${API_URL}/schedule/${scheduleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(scheduleData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update schedule');
                }
                return response.json();
            })
            .then(updatedSchedule => {
                // Close modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editScheduleModal'));
                editModal.hide();
                
                showSuccess('Schedule updated successfully');
                loadScheduleData();
            })
            .catch(error => {
                console.error('Error updating schedule:', error);
                showError('Failed to update schedule: ' + error.message);
            })
            .finally(() => {
                hideLoading();
            });
        });
        
        // Delete schedule
        document.getElementById('confirmDeleteScheduleBtn').addEventListener('click', function() {
            const scheduleId = this.getAttribute('data-schedule-id');
            
            showLoading();
            fetch(`${API_URL}/schedule/${scheduleId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete schedule');
                }
                return response.json();
            })
            .then(result => {
                // Close modal
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteScheduleModal'));
                deleteModal.hide();
                
                showSuccess('Schedule deleted successfully');
                loadScheduleData();
            })
            .catch(error => {
                console.error('Error deleting schedule:', error);
                showError('Failed to delete schedule: ' + error.message);
            })
            .finally(() => {
                hideLoading();
            });
        });

        // Add episode form submission - simplified
        document.getElementById('addEpisodeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const animeId = document.getElementById('episodeAnimeSelector').value;
            const iframeSrc = document.getElementById('iframeSrc').value;
            const server2Url = document.getElementById('server2Url').value;
            
            if (!animeId) {
                showError('Please select an anime');
                return;
            }
            
            if (!server2Url) {
                showError('Server 2 URL is required');
                return;
            }
            
            const episodeData = {
                animeId: animeId,
                iframeSrc: iframeSrc || '',
                server2Url: server2Url
            };
            
            showLoading();
            fetch(`${API_URL}/episodes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(episodeData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => Promise.reject(error));
                }
                return response.json();
            })
            .then(newEpisode => {
                // Reset form
                document.getElementById('addEpisodeForm').reset();
                
                // Show success message
                showSuccess(`Episode ${newEpisode.number} added successfully`);
                
                // Reload episodes
                return fetch(`${API_URL}/anime/${animeId}/episodes`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch episodes');
                        }
                        return response.json();
                    })
                    .then(episodes => {
                        return fetch(`${API_URL}/anime/${animeId}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Failed to fetch anime details');
                                }
                                return response.json();
                            })
                            .then(anime => {
                                displayEpisodes(episodes, anime);
                                
                                // Update episode count
                                document.getElementById('episodes-count-display').textContent = 
                                    `${episodes.length} episode${episodes.length !== 1 ? 's' : ''}`;
                                
                                hideLoading();
                            });
                    });
            })
            .catch(error => {
                console.error('Error adding episode:', error);
                showError(error.error || 'Failed to add episode');
                hideLoading();
            });
        });
        
        // Open edit episode modal
        function openEditEpisodeModal(episodeId) {
            showLoading();
            fetch(`${API_URL}/episodes/${episodeId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch episode details');
                    }
                    return response.json();
                })
                .then(episode => {
                    // Populate form - simplified for just iframeSrc and server2Url
                    document.getElementById('editEpisodeId').value = episode.id;
                    document.getElementById('editIframeSrc').value = episode.iframeSrc || '';
                    document.getElementById('editServer2Url').value = episode.server2Url || '';
                    
                    // Show modal
                    const editModal = new bootstrap.Modal(document.getElementById('editEpisodeModal'));
                    editModal.show();
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error fetching episode details:', error);
                    showError('Failed to load episode details: ' + error.message);
                    hideLoading();
                });
        }
        
        // Save edited episode - simplified to only update URLs
        document.getElementById('saveEditEpisodeBtn').addEventListener('click', function() {
            const episodeId = document.getElementById('editEpisodeId').value;
            const iframeSrc = document.getElementById('editIframeSrc').value;
            const server2Url = document.getElementById('editServer2Url').value;
            
            if (!server2Url) {
                showError('Server 2 URL is required');
                return;
            }
            
            const episodeData = {
                iframeSrc: iframeSrc || '',
                server2Url: server2Url
            };
            
            showLoading();
            fetch(`${API_URL}/episodes/${episodeId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(episodeData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => Promise.reject(error));
                }
                return response.json();
            })
            .then(updatedEpisode => {
                // Close modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editEpisodeModal'));
                editModal.hide();
                
                // Show success message
                showSuccess(`Episode ${updatedEpisode.number} updated successfully`);
                
                // Reload episodes
                const animeId = document.getElementById('episodeAnimeSelector').value;
                return fetch(`${API_URL}/anime/${animeId}/episodes`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch episodes');
                        }
                        return response.json();
                    })
                    .then(episodes => {
                        return fetch(`${API_URL}/anime/${animeId}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Failed to fetch anime details');
                                }
                                return response.json();
                            })
                            .then(anime => {
                                displayEpisodes(episodes, anime);
                                hideLoading();
                            });
                    });
            })
            .catch(error => {
                console.error('Error updating episode:', error);
                showError(error.error || 'Failed to update episode');
                hideLoading();
            });
        });
        
        // Delete episode
        document.getElementById('confirmDeleteEpisodeBtn').addEventListener('click', function() {
            const episodeId = this.getAttribute('data-episode-id');
            
            showLoading();
            fetch(`${API_URL}/episodes/${episodeId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => Promise.reject(error));
                }
                return response.json();
            })
            .then(result => {
                // Close modal
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteEpisodeModal'));
                deleteModal.hide();
                
                // Show success message
                showSuccess('Episode deleted successfully');
                
                // Reload episodes
                const animeId = document.getElementById('episodeAnimeSelector').value;
                return fetch(`${API_URL}/anime/${animeId}/episodes`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch episodes');
                        }
                        return response.json();
                    })
                    .then(episodes => {
                        return fetch(`${API_URL}/anime/${animeId}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Failed to fetch anime details');
                                }
                                return response.json();
                            })
                            .then(anime => {
                                displayEpisodes(episodes, anime);
                                
                                // Update episode count
                                document.getElementById('episodes-count-display').textContent = 
                                    `${episodes.length} episode${episodes.length !== 1 ? 's' : ''}`;
                                
                                hideLoading();
                            });
                    });
            })
            .catch(error => {
                console.error('Error deleting episode:', error);
                showError(error.error || 'Failed to delete episode');
                hideLoading();
            });
        });

        // Bulk episode uploader functionality
        function initBulkUploader() {
            let parsedEpisodes = [];
            
            // Parse the episodes button
            document.getElementById('parseBulkEpisodesBtn').addEventListener('click', function() {
                const bulkHtml = document.getElementById('bulkEpisodeHtml').value;
                const server1Default = document.getElementById('server1DefaultValue').value;
                
                if (!bulkHtml.trim()) {
                    showError('Please paste the HTML with episode options');
                    return;
                }
                
                // Create a temporary container to parse the HTML
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = bulkHtml;
                
                // Find the select element
                const selectElement = tempContainer.querySelector('select');
                
                if (!selectElement) {
                    showError('Could not find a select element in the provided HTML');
                    return;
                }
                
                // Get all option elements
                const options = selectElement.querySelectorAll('option');
                
                if (options.length === 0) {
                    showError('No episode options found in the select element');
                    return;
                }
                
                // Parse the episodes
                parsedEpisodes = Array.from(options).map(option => {
                    return {
                        number: parseInt(option.value, 10),
                        title: option.textContent.trim() || `Episode ${option.value}`,
                        iframeSrc: option.getAttribute('data-server1') || server1Default || "",
                        server2Url: option.getAttribute('data-server2') || ""
                    };
                });
                
                // Update the episode count badge
                document.getElementById('episodeCount').textContent = parsedEpisodes.length;
                
                // Enable the upload button
                document.getElementById('uploadBulkEpisodesBtn').disabled = false;
                
                // Show a success message
                showSuccess(`Successfully parsed ${parsedEpisodes.length} episodes`);
            });
            
            // Upload button click handler
            document.getElementById('uploadBulkEpisodesBtn').addEventListener('click', function() {
                if (parsedEpisodes.length === 0) {
                    showError('No episodes to upload. Parse HTML first.');
                    return;
                }
                
                // Show preview modal
                const previewTable = document.getElementById('bulkEpisodePreviewTable');
                previewTable.innerHTML = '';
                
                // Populate the preview table
                parsedEpisodes.forEach(episode => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${episode.number}</td>
                        <td>${episode.title}</td>
                        <td>${episode.iframeSrc || '<em>None</em>'}</td>
                        <td>${episode.server2Url || '<em>None</em>'}</td>
                    `;
                    previewTable.appendChild(row);
                });
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('bulkUploadPreviewModal'));
                modal.show();
            });
            
            // Confirm upload button click handler
            document.getElementById('confirmBulkUploadBtn').addEventListener('click', function() {
                const animeId = document.getElementById('episodeAnimeSelector').value;
                const replaceExisting = document.getElementById('replaceExisting').checked;
                
                if (!animeId) {
                    showError('Please select an anime first');
                    return;
                }
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('bulkUploadPreviewModal'));
                modal.hide();
                
                // Show loading spinner
                showLoading();
                
                // If replacing existing episodes, delete them first
                const uploadEpisodes = () => {
                    // Upload episodes sequentially with a small delay to prevent overwhelming the server
                    let uploaded = 0;
                    let failed = 0;
                    
                    const uploadNextEpisode = (index) => {
                        if (index >= parsedEpisodes.length) {
                            // All done
                            hideLoading();
                            showSuccess(`Upload complete: ${uploaded} episodes uploaded, ${failed} failed`);
                            
                            // Reload episodes
                            loadEpisodesForAnime(animeId);
                            return;
                        }
                        
                        const episode = parsedEpisodes[index];
                        const episodeData = {
                            animeId: animeId,
                            number: episode.number,
                            title: episode.title,
                            iframeSrc: episode.iframeSrc || '',
                            server2Url: episode.server2Url || ''
                        };
                        
                        fetch(`${API_URL}/episodes`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(episodeData)
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Episode ${episode.number} failed to upload`);
                            }
                            return response.json();
                        })
                        .then(() => {
                            uploaded++;
                            // Update progress in loading spinner message
                            document.querySelector('#loadingSpinner').innerHTML = `
                                <div class="text-center text-white">
                                    <div class="spinner-border text-light mb-3" role="status"></div>
                                    <div>Uploading episodes: ${uploaded + failed}/${parsedEpisodes.length}</div>
                                    <div class="small mt-2">${uploaded} uploaded, ${failed} failed</div>
                                    <div class="progress mt-3" style="height: 8px; width: 250px; margin: 0 auto;">
                                        <div class="progress-bar bg-success" style="width: ${((uploaded + failed) / parsedEpisodes.length) * 100}%"></div>
                                    </div>
                                </div>
                            `;
                            // Process next episode after a small delay
                            setTimeout(() => uploadNextEpisode(index + 1), 100);
                        })
                        .catch(error => {
                            console.error('Error uploading episode:', error);
                            failed++;
                            // Continue with next episode
                            setTimeout(() => uploadNextEpisode(index + 1), 100);
                        });
                    };
                    
                    // Start uploading from first episode
                    uploadNextEpisode(0);
                };
                
                if (replaceExisting) {
                    // First, get all existing episodes
                    fetch(`${API_URL}/anime/${animeId}/episodes`)
                        .then(response => response.json())
                        .then(episodes => {
                            // Delete each episode sequentially
                            let deletedCount = 0;
                            const totalToDelete = episodes.length;
                            
                            const deleteNextEpisode = (index) => {
                                if (index >= episodes.length) {
                                    // All deleted, now upload new ones
                                    uploadEpisodes();
                                    return;
                                }
                                
                                fetch(`${API_URL}/episodes/${episodes[index].id}`, {
                                    method: 'DELETE'
                                })
                                .then(() => {
                                    deletedCount++;
                                    // Update the loading spinner with delete progress
                                    document.querySelector('#loadingSpinner').innerHTML = `
                                        <div class="text-center text-white">
                                            <div class="spinner-border text-light mb-3" role="status"></div>
                                            <div>Deleting existing episodes: ${deletedCount}/${totalToDelete}</div>
                                            <div class="progress mt-3" style="height: 8px; width: 250px; margin: 0 auto;">
                                                <div class="progress-bar bg-danger" style="width: ${(deletedCount / totalToDelete) * 100}%"></div>
                                            </div>
                                        </div>
                                    `;
                                    // Delete next episode
                                    setTimeout(() => deleteNextEpisode(index + 1), 100);
                                })
                                .catch(error => {
                                    console.error('Error deleting episode:', error);
                                    // Continue with next episode anyway
                                    setTimeout(() => deleteNextEpisode(index + 1), 100);
                                });
                            };
                            
                            if (episodes.length > 0) {
                                deleteNextEpisode(0);
                            } else {
                                // No episodes to delete, proceed to upload
                                uploadEpisodes();
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching episodes for deletion:', error);
                            showError('Failed to fetch existing episodes');
                            hideLoading();
                        });
                } else {
                    // Just upload new episodes without deleting
                    uploadEpisodes();
                }
            });
        }

        // Helper function to reload episodes after bulk upload
        function loadEpisodesForAnime(animeId) {
            fetch(`${API_URL}/anime/${animeId}/episodes`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch episodes');
                    }
                    return response.json();
                })
                .then(episodes => {
                    return fetch(`${API_URL}/anime/${animeId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to fetch anime details');
                            }
                            return response.json();
                        })
                        .then(anime => {
                            displayEpisodes(episodes, anime);
                            
                            // Update episode count
                            document.getElementById('episodes-count-display').textContent = 
                                `${episodes.length} episode${episodes.length !== 1 ? 's' : ''}`;
                        });
                })
                .catch(error => {
                    console.error('Error reloading episodes:', error);
                    showError('Failed to reload episodes: ' + error.message);
                });
        }
        
        // Initialize the bulk uploader when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initBulkUploader();
            loadDashboardData();
            checkServerStatus();
            
            // Handle image loading for all images
            const observeImages = () => {
                const images = document.querySelectorAll('.anime-thumbnail, .schedule-thumbnail');
                
                images.forEach(img => {
                    if (img.complete) {
                        img.classList.add('loaded');
                    } else {
                        img.addEventListener('load', function() {
                            this.classList.add('loaded');
                        });
                    }
                    
                    img.addEventListener('error', function() {
                        this.src = 'https://via.placeholder.com/350x500?text=No+Image';
                        this.classList.add('loaded');
                    });
                });
            };
            
            // Run initially
            observeImages();
            
            // Set up a MutationObserver to watch for new images
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (mutation.addedNodes) {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) { // Element node
                                const images = node.querySelectorAll('.anime-thumbnail, .schedule-thumbnail');
                                if (images.length > 0) {
                                    images.forEach(img => {
                                        if (img.complete) {
                                            img.classList.add('loaded');
                                        } else {
                                            img.addEventListener('load', function() {
                                                this.classList.add('loaded');
                                            });
                                        }
                                        
                                        img.addEventListener('error', function() {
                                            this.src = 'https://via.placeholder.com/350x500?text=No+Image';
                                            this.classList.add('loaded');
                                        });
                                    });
                                }
                            }
                        });
                    }
                });
            });
            
            // Start observing the document
            observer.observe(document.body, { 
                childList: true,
                subtree: true
            });
        });
    </script>
</body>
</html>
