<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Stream - Watch Anime Online</title>
    <meta http-equiv="refresh" content="1800"> <!-- Refresh every 30 minutes to keep connection -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --text-color: #2d3436;
            --light-bg: #f5f6fa;
            --dark-bg: #2f3640;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 10px;
            color: var(--accent-color);
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 0.8rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        nav a:hover, nav a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .search-container {
            display: flex;
            align-items: center;
            flex: 1;
            max-width: 400px;
            margin: 0 2rem;
        }

        .search-input {
            flex: 1;
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 20px 0 0 20px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.8);
        }

        .search-btn {
            background-color: rgba(255, 255, 255, 0.3);
            border: none;
            padding: 0.6rem 1rem;
            color: white;
            cursor: pointer;
            border-radius: 0 20px 20px 0;
            transition: background-color 0.3s;
        }

        .search-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 0.5rem;
        }

        .anime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .anime-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s;
            position: relative;
        }

        .anime-card:hover {
            transform: translateY(-5px);
        }

        .anime-thumb {
            position: relative;
            padding-top: 140%; /* Aspect ratio */
            overflow: hidden;
        }

        .anime-thumb img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .anime-card:hover .anime-thumb img {
            transform: scale(1.05);
        }

        .anime-details {
            padding: 1rem;
        }

        .anime-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .anime-info {
            font-size: 0.85rem;
            color: #7a7a7a;
            display: flex;
            justify-content: space-between;
        }

        .tagalog-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--accent-color);
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .rating {
            display: flex;
            align-items: center;
        }

        .rating i {
            color: gold;
            margin-right: 0.2rem;
        }

        .featured-section {
            position: relative;
            margin-bottom: 3rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .featured-content {
            position: relative;
            height: 400px;
            color: white;
        }

        .featured-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 2rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
        }

        .featured-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .featured-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .featured-details {
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .watch-btn {
            display: inline-block;
            background-color: var(--accent-color);
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 4px;
            text-decoration: none;
            margin-right: 1rem;
            transition: background-color 0.3s;
        }

        .watch-btn:hover {
            background-color: #e84393;
        }

        .info-btn {
            display: inline-block;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 4px;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .info-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .upcoming-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .upcoming-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
        }

        .upcoming-thumb {
            flex: 0 0 100px;
            height: 100px;
        }

        .upcoming-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upcoming-details {
            flex: 1;
            padding: 1rem;
        }

        .upcoming-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .release-date {
            font-size: 0.85rem;
            color: var(--accent-color);
            font-weight: 600;
        }

        .upcoming-notes {
            font-size: 0.8rem;
            color: #7a7a7a;
            margin-top: 0.5rem;
        }

        .player-wrapper {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .player-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .anime-info-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .episode-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .episode-selector select, .server-selector select {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .player-container {
            position: relative;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
        }

        .player-container iframe, .player-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .episode-list {
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .episode-btn {
            padding: 0.5rem 1rem;
            background-color: #f1f1f1;
            border-radius: 4px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.3s;
        }

        .episode-btn.active, .episode-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        footer {
            background-color: var(--dark-bg);
            color: white;
            padding: 2rem 1rem;
            margin-top: 2rem;
        }

        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .footer-section h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

        .footer-links a {
            display: block;
            color: #ddd;
            text-decoration: none;
            margin-bottom: 0.5rem;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: var(--accent-color);
        }

        .footer-social {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .footer-social a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .footer-social a:hover {
            background-color: var(--accent-color);
        }

        .copyright {
            text-align: center;
            padding-top: 2rem;
            margin-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        /* Backup UI styles */
        .backup-panel {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            margin: 2rem 0;
        }

        .backup-panel h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .backup-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .backup-btn:hover {
            background-color: var(--secondary-color);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .search-container {
                width: 100%;
                max-width: none;
                margin: 1rem 0;
            }
            
            nav ul {
                gap: 0.5rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .featured-content {
                height: 300px;
            }
            
            .featured-title {
                font-size: 1.5rem;
            }
            
            .episode-selector {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        /* Loading spinner */
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }

        /* Popup elements */
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1010;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .popup-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .popup-close:hover {
            color: var(--accent-color);
        }

        /* Admin section styles */
        .admin-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: transform 0.3s;
            z-index: 900;
        }

        .admin-link:hover {
            transform: scale(1.1);
        }

        /* Keepalive hidden iframe */
        .keepalive-frame {
            width: 0;
            height: 0;
            border: 0;
            visibility: hidden;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-play-circle"></i>
                <span>Anime Stream</span>
            </div>
            
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Search anime...">
                <button class="search-btn" id="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <nav>
                <ul>
                    <li><a href="#" class="active">Home</a></li>
                    <li><a href="#popular-section">Popular</a></li>
                    <li><a href="#latest-section">Latest</a></li>
                    <li><a href="#tagalog-section">Tagalog Dub</a></li>
                    <li><a href="#upcoming-section">Upcoming</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <main>
        <!-- Featured Anime Section -->
        <section class="featured-section" id="featured-anime">
            <div class="loader-container">
                <div class="loader"></div>
            </div>
            <div class="featured-content hidden">
                <img src="" alt="Featured Anime" class="featured-img">
                <div class="featured-overlay">
                    <h2 class="featured-title"></h2>
                    <div class="featured-details">
                        <span class="featured-episodes"></span> | 
                        <span class="featured-rating"></span> | 
                        <span class="featured-genres"></span>
                    </div>
                    <a href="#" class="watch-btn">Watch Now</a>
                    <a href="#" class="info-btn">More Info</a>
                </div>
            </div>
        </section>
        
        <!-- Popular Anime Section -->
        <section id="popular-section">
            <h2 class="section-title">
                <i class="fas fa-fire"></i> Popular Anime
            </h2>
            <div class="anime-grid" id="popular-anime">
                <div class="loader-container">
                    <div class="loader"></div>
                </div>
            </div>
        </section>
        
        <!-- Latest Episodes Section -->
        <section id="latest-section">
            <h2 class="section-title">
                <i class="fas fa-clock"></i> Latest Episodes
            </h2>
            <div class="anime-grid" id="latest-episodes">
                <div class="loader-container">
                    <div class="loader"></div>
                </div>
            </div>
        </section>
        
        <!-- Tagalog Dubbed Anime Section -->
        <section id="tagalog-section">
            <h2 class="section-title">
                <i class="fas fa-microphone-alt"></i> Tagalog Dubbed Anime
            </h2>
            <div class="anime-grid" id="tagalog-anime">
                <div class="loader-container">
                    <div class="loader"></div>
                </div>
            </div>
        </section>
        
        <!-- Upcoming Releases Section -->
        <section id="upcoming-section">
            <h2 class="section-title">
                <i class="fas fa-calendar-alt"></i> Upcoming Releases
            </h2>
            <div class="upcoming-grid" id="upcoming-releases">
                <div class="loader-container">
                    <div class="loader"></div>
                </div>
            </div>
        </section>
        
        <!-- Player Section (Hidden initially) -->
        <section id="player-section" class="hidden">
            <div class="player-wrapper">
                <div class="player-header">
                    <h2 class="anime-info-title" id="player-anime-title"></h2>
                    <div class="episode-selector">
                        <div class="server-selector">
                            <select id="server-select">
                                <option value="1">Server 1</option>
                                <option value="2">Server 2</option>
                            </select>
                        </div>
                        <select id="episode-select"></select>
                    </div>
                </div>
                <div class="player-container" id="player-container">
                    <!-- Player will be inserted here -->
                </div>
                <div class="episode-list" id="episode-list">
                    <!-- Episode buttons will be inserted here -->
                </div>
            </div>
        </section>
        
        <!-- Backup UI Container -->
        <div id="backup-container"></div>
    </main>
    
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h3>Anime Stream</h3>
                <p>Your ultimate destination for anime streaming with Tagalog dubbed content.</p>
                <div class="footer-social">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-discord"></i></a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Quick Links</h3>
                <div class="footer-links">
                    <a href="#">Home</a>
                    <a href="#popular-section">Popular Anime</a>
                    <a href="#latest-section">Latest Episodes</a>
                    <a href="#tagalog-section">Tagalog Dub</a>
                    <a href="#upcoming-section">Upcoming Releases</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Genres</h3>
                <div class="footer-links">
                    <a href="#">Action</a>
                    <a href="#">Romance</a>
                    <a href="#">Comedy</a>
                    <a href="#">Drama</a>
                    <a href="#">Fantasy</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Legal</h3>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">DMCA</a>
                    <a href="#">Contact Us</a>
                </div>
            </div>
        </div>
        
        <div class="copyright">
            <p>&copy; 2025 Anime Stream. All rights reserved.</p>
        </div>
    </footer>
    
    <!-- Admin link -->
    <a href="/animestream.html" class="admin-link" title="Admin Panel">
        <i class="fas fa-cog"></i>
    </a>
    
    <!-- Popup elements -->
    <div class="popup-backdrop hidden" id="popup-backdrop"></div>
    <div class="popup hidden" id="anime-details-popup">
        <span class="popup-close" id="popup-close">&times;</span>
        <div id="popup-content">
            <!-- Anime details will be inserted here -->
        </div>
    </div>
    
    <!-- Keepalive hidden iframe -->
    <iframe src="/keepalive" class="keepalive-frame" title="keepalive"></iframe>
    
    <!-- Load JavaScript -->
    <script src="/js/persistence.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize persistence manager
            const persistenceManager = new AnimePersistenceManager('');
            persistenceManager.createBackupUI('backup-container');
            persistenceManager.startKeepAlive();
            
            // Check for server data on page load
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    if (data.dataStats.customAnimeCount === 0 && 
                        data.dataStats.episodesCount === 0 &&
                        persistenceManager.hasLocalBackup()) {
                        
                        if (confirm('The server appears to have no data, but a local backup was found. Would you like to restore it?')) {
                            persistenceManager.sendBackupToServer()
                                .then(result => {
                                    if (result) {
                                        alert('Data successfully restored from local backup!');
                                        window.location.reload();
                                    }
                                });
                        }
                    }
                })
                .catch(error => console.error('Error checking server health:', error));
            
            // Fetch and display anime data
            fetchAndDisplayAnime();
            
            // Setup event listeners
            setupEventListeners();
        });
        
        // Fetch and display all anime data
        function fetchAndDisplayAnime() {
            // Fetch all anime
            fetch('/api/anime')
                .then(response => response.json())
                .then(animeList => {
                    displayFeaturedAnime(animeList);
                    displayPopularAnime(animeList);
                    displayLatestEpisodes();
                })
                .catch(error => console.error('Error fetching anime:', error));
            
            // Fetch tagalog dubbed anime
            fetch('/api/anime/tagalog')
                .then(response => response.json())
                .then(tagalogAnime => {
                    displayTagalogAnime(tagalogAnime);
                })
                .catch(error => console.error('Error fetching tagalog anime:', error));
            
            // Fetch upcoming releases
            fetch('/api/upcoming')
                .then(response => response.json())
                .then(upcomingReleases => {
                    displayUpcomingReleases(upcomingReleases);
                })
                .catch(error => console.error('Error fetching upcoming releases:', error));
        }
        
        // Display featured anime
        function displayFeaturedAnime(animeList) {
            if (!animeList || animeList.length === 0) return;
            
            // Sort by popularity and take the most popular one
            const sortedAnime = [...animeList].sort((a, b) => b.popularity - a.popularity);
            const featuredAnime = sortedAnime[0];
            
            const featuredSection = document.getElementById('featured-anime');
            const loader = featuredSection.querySelector('.loader-container');
            const content = featuredSection.querySelector('.featured-content');
            
            if (featuredAnime) {
                content.querySelector('.featured-img').src = featuredAnime.banner || featuredAnime.thumbnail;
                content.querySelector('.featured-title').textContent = featuredAnime.title;
                content.querySelector('.featured-episodes').textContent = `${featuredAnime.episodeCount} Episodes`;
                content.querySelector('.featured-rating').textContent = `${featuredAnime.rating}/10`;
                content.querySelector('.featured-genres').textContent = featuredAnime.genres.slice(0, 3).join(', ');
                
                // Set watch link
                const watchBtn = content.querySelector('.watch-btn');
                watchBtn.href = `#anime-${featuredAnime.id}`;
                watchBtn.dataset.animeId = featuredAnime.id;
                watchBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadAnimePlayer(featuredAnime.id);
                });
                
                // Set info link
                const infoBtn = content.querySelector('.info-btn');
                infoBtn.href = `#info-${featuredAnime.id}`;
                infoBtn.dataset.animeId = featuredAnime.id;
                infoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showAnimeDetails(featuredAnime.id);
                });
                
                // Hide loader and show content
                loader.classList.add('hidden');
                content.classList.remove('hidden');
            }
        }
        
        // Display popular anime
        function displayPopularAnime(animeList) {
            if (!animeList || animeList.length === 0) return;
            
            const popularSection = document.getElementById('popular-anime');
            popularSection.innerHTML = ''; // Clear loader
            
            // Sort by popularity and take top 12
            const popularAnime = [...animeList]
                .sort((a, b) => b.popularity - a.popularity)
                .slice(0, 12);
            
            popularAnime.forEach(anime => {
                const animeCard = createAnimeCard(anime);
                popularSection.appendChild(animeCard);
            });
        }
        
        // Display latest episodes
        function displayLatestEpisodes() {
            // Fetch all episodes
            fetch('/api/episodes')
                .then(response => response.json())
                .then(episodes => {
                    if (!episodes || episodes.length === 0) return;
                    
                    const latestSection = document.getElementById('latest-episodes');
                    latestSection.innerHTML = ''; // Clear loader
                    
                    // Sort by date added (newest first) and take latest 12
                    const latestEpisodes = [...episodes]
                        .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded))
                        .slice(0, 12);
                    
                    // Create a map to avoid duplicates
                    const animeMap = new Map();
                    
                    // Process episodes and fetch anime details
                    Promise.all(latestEpisodes.map(episode => 
                        fetch(`/api/anime/${episode.animeId}`)
                            .then(response => response.json())
                            .then(anime => {
                                // Only add if not already in map
                                if (!animeMap.has(anime.id)) {
                                    animeMap.set(anime.id, {
                                        ...anime,
                                        latestEpisode: episode.number
                                    });
                                }
                            })
                    ))
                    .then(() => {
                        // Convert map to array and display
                        const latestAnime = Array.from(animeMap.values());
                        
                        latestAnime.forEach(anime => {
                            const animeCard = createAnimeCard(anime, `Ep ${anime.latestEpisode}`);
                            latestSection.appendChild(animeCard);
                        });
                    });
                })
                .catch(error => console.error('Error fetching episodes:', error));
        }
        
        // Display tagalog dubbed anime
        function displayTagalogAnime(tagalogAnime) {
            if (!tagalogAnime || tagalogAnime.length === 0) return;
            
            const tagalogSection = document.getElementById('tagalog-anime');
            tagalogSection.innerHTML = ''; // Clear loader
            
            // Take up to 12 tagalog dubbed anime
            const displayedAnime = tagalogAnime.slice(0, 12);
            
            displayedAnime.forEach(anime => {
                const animeCard = createAnimeCard(anime, 'Tagalog');
                tagalogSection.appendChild(animeCard);
            });
        }
        
        // Display upcoming releases
        function displayUpcomingReleases(upcomingReleases) {
            if (!upcomingReleases || upcomingReleases.length === 0) return;
            
            const upcomingSection = document.getElementById('upcoming-releases');
            upcomingSection.innerHTML = ''; // Clear loader
            
            // Sort by release date (soonest first)
            const sortedReleases = [...upcomingReleases]
                .sort((a, b) => new Date(a.releaseDate) - new Date(b.releaseDate));
            
            sortedReleases.forEach(release => {
                const releaseCard = document.createElement('div');
                releaseCard.className = 'upcoming-card';
                
                const releaseDate = new Date(release.releaseDate);
                const formattedDate = releaseDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                releaseCard.innerHTML = `
                    <div class="upcoming-thumb">
                        <img src="${release.thumbnail}" alt="${release.title}">
                    </div>
                    <div class="upcoming-details">
                        <h3 class="upcoming-title">${release.title}</h3>
                        <div class="release-date">
                            <i class="far fa-calendar-alt"></i> ${formattedDate}
                        </div>
                        ${release.hasTagalogDub ? '<div class="tagalog-badge">Tagalog Dub</div>' : ''}
                        ${release.notes ? `<div class="upcoming-notes">${release.notes}</div>` : ''}
                    </div>
                `;
                
                upcomingSection.appendChild(releaseCard);
            });
        }
        
        // Create anime card element
        function createAnimeCard(anime, badge = null) {
            const animeCard = document.createElement('div');
            animeCard.className = 'anime-card';
            animeCard.dataset.animeId = anime.id;
            
            animeCard.innerHTML = `
                <div class="anime-thumb">
                    <img src="${anime.thumbnail}" alt="${anime.title}">
                    ${anime.hasTagalogDub ? '<div class="tagalog-badge">Tagalog Dub</div>' : ''}
                    ${badge && !anime.hasTagalogDub ? `<div class="tagalog-badge">${badge}</div>` : ''}
                </div>
                <div class="anime-details">
                    <h3 class="anime-title">${anime.title}</h3>
                    <div class="anime-info">
                        <span>${anime.episodeCount} eps</span>
                        <span class="rating">
                            <i class="fas fa-star"></i> ${anime.rating.toFixed(1)}
                        </span>
                    </div>
                </div>
            `;
            
            // Add click event to load player
            animeCard.addEventListener('click', function() {
                loadAnimePlayer(anime.id);
            });
            
            return animeCard;
        }
        
        // Load anime player
        function loadAnimePlayer(animeId) {
            // Fetch anime details
            fetch(`/api/anime/${animeId}`)
                .then(response => response.json())
                .then(anime => {
                    // Fetch episodes
                    fetch(`/api/anime/${animeId}/episodes`)
                        .then(response => response.json())
                        .then(episodes => {
                            if (episodes.length === 0) {
                                alert('No episodes available for this anime');
                                return;
                            }
                            
                            // Setup player
                            setupAnimePlayer(anime, episodes);
                            
                            // Scroll to player section
                            document.getElementById('player-section').scrollIntoView({
                                behavior: 'smooth'
                            });
                        })
                        .catch(error => console.error('Error fetching episodes:', error));
                })
                .catch(error => console.error('Error fetching anime details:', error));
        }
        
        // Setup anime player
        function setupAnimePlayer(anime, episodes) {
            // Set anime title
            document.getElementById('player-anime-title').textContent = anime.title;
            
            // Sort episodes by number
            const sortedEpisodes = [...episodes].sort((a, b) => a.number - b.number);
            
            // Populate episode select
            const episodeSelect = document.getElementById('episode-select');
            episodeSelect.innerHTML = '';
            
            sortedEpisodes.forEach(episode => {
                const option = document.createElement('option');
                option.value = episode.id;
                option.textContent = `Episode ${episode.number}`;
                option.dataset.number = episode.number;
                option.dataset.server1 = episode.iframeSrc || '';
                option.dataset.server2 = episode.server2Url || '';
                episodeSelect.appendChild(option);
            });
            
            // Populate episode list
            const episodeList = document.getElementById('episode-list');
            episodeList.innerHTML = '';
            
            sortedEpisodes.forEach(episode => {
                const episodeBtn = document.createElement('a');
                episodeBtn.href = '#';
                episodeBtn.className = 'episode-btn';
                episodeBtn.textContent = `Ep ${episode.number}`;
                episodeBtn.dataset.episodeId = episode.id;
                
                episodeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update selected episode
                    episodeSelect.value = episode.id;
                    
                    // Update active button
                    document.querySelectorAll('.episode-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Change video
                    changeVideo();
                });
                
                episodeList.appendChild(episodeBtn);
            });
            
            // Set first episode as active
            if (episodeList.firstChild) {
                episodeList.firstChild.classList.add('active');
            }
            
            // Add event listeners
            episodeSelect.addEventListener('change', changeVideo);
            document.getElementById('server-select').addEventListener('change', changeVideo);
            
            // Load first episode
            changeVideo();
            
            // Show player section
            document.getElementById('player-section').classList.remove('hidden');
        }
        
        // Change video source
        function changeVideo() {
            const episodeSelect = document.getElementById('episode-select');
            const serverSelect = document.getElementById('server-select');
            const playerContainer = document.getElementById('player-container');
            
            const selectedOption = episodeSelect.options[episodeSelect.selectedIndex];
            const selectedServer = serverSelect.value;
            
            // Update active button in episode list
            document.querySelectorAll('.episode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.episodeId === episodeSelect.value) {
                    btn.classList.add('active');
                }
            });
            
            // Clear player container
            playerContainer.innerHTML = '';
            
            if (selectedServer === '1' && selectedOption.dataset.server1) {
                // Server 1 - iframe embed
                const iframe = document.createElement('iframe');
                iframe.src = selectedOption.dataset.server1;
                iframe.setAttribute('allowfullscreen', 'true');
                iframe.setAttribute('frameborder', '0');
                playerContainer.appendChild(iframe);
            } else if (selectedOption.dataset.server2) {
                // Server 2 - direct video
                const video = document.createElement('video');
                video.src = selectedOption.dataset.server2;
                video.controls = true;
                video.autoplay = true;
                video.setAttribute('playsinline', 'true');
                playerContainer.appendChild(video);
            } else {
                playerContainer.innerHTML = `
                    <div style="display:flex;justify-content:center;align-items:center;height:100%;background:#000;color:#fff;">
                        <p>No video source available for this episode</p>
                    </div>
                `;
            }
        }
        
        // Show anime details popup
        function showAnimeDetails(animeId) {
            fetch(`/api/anime/${animeId}`)
                .then(response => response.json())
                .then(anime => {
                    const popupContent = document.getElementById('popup-content');
                    
                    // Format date
                    const formatDate = (dateStr) => {
                        if (!dateStr) return 'Unknown';
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    };
                    
                    // Create content
                    popupContent.innerHTML = `
                        <div style="display:flex;flex-direction:column;gap:1rem;">
                            <img src="${anime.banner || anime.thumbnail}" alt="${anime.title}" 
                                style="width:100%;height:200px;object-fit:cover;border-radius:8px;">
                            
                            <h2 style="font-size:1.8rem;color:var(--primary-color);">${anime.title}</h2>
                            
                            <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.5rem;">
                                ${anime.genres.map(genre => 
                                    `<span style="background:#f0f0f0;padding:0.3rem 0.8rem;border-radius:20px;font-size:0.8rem;">
                                        ${genre}
                                    </span>`
                                ).join('')}
                            </div>
                            
                            <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:1rem;margin-bottom:1rem;">
                                <div>
                                    <p><strong>Episodes:</strong> ${anime.episodeCount}</p>
                                    <p><strong>Rating:</strong> ${anime.rating}/10</p>
                                    <p><strong>Status:</strong> ${anime.status}</p>
                                </div>
                                <div>
                                    <p><strong>Season:</strong> ${anime.season}</p>
                                    <p><strong>Start Date:</strong> ${formatDate(anime.startDate)}</p>
                                    <p><strong>End Date:</strong> ${formatDate(anime.endDate)}</p>
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="margin-bottom:0.5rem;color:var(--primary-color);">Synopsis</h3>
                                <p style="line-height:1.6;">${anime.description}</p>
                            </div>
                            
                            <div style="display:flex;justify-content:center;margin-top:1rem;">
                                <button id="watch-now-btn" class="watch-btn" style="width:50%;">Watch Now</button>
                            </div>
                        </div>
                    `;
                    
                    // Add event listener to watch button
                    document.getElementById('watch-now-btn').addEventListener('click', function() {
                        // Close popup
                        document.getElementById('popup-backdrop').classList.add('hidden');
                        document.getElementById('anime-details-popup').classList.add('hidden');
                        
                        // Load player
                        loadAnimePlayer(animeId);
                    });
                    
                    // Show popup
                    document.getElementById('popup-backdrop').classList.remove('hidden');
                    document.getElementById('anime-details-popup').classList.remove('hidden');
                })
                .catch(error => console.error('Error fetching anime details:', error));
        }
        
        // Setup general event listeners
        function setupEventListeners() {
            // Close popup
            document.getElementById('popup-close').addEventListener('click', function() {
                document.getElementById('popup-backdrop').classList.add('hidden');
                document.getElementById('anime-details-popup').classList.add('hidden');
            });
            
            // Close popup when clicking backdrop
            document.getElementById('popup-backdrop').addEventListener('click', function() {
                document.getElementById('popup-backdrop').classList.add('hidden');
                document.getElementById('anime-details-popup').classList.add('hidden');
            });
            
            // Search functionality
            document.getElementById('search-btn').addEventListener('click', function() {
                const searchQuery = document.getElementById('search-input').value.trim();
                if (searchQuery.length === 0) return;
                
                performSearch(searchQuery);
            });
            
            // Search on Enter key
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const searchQuery = this.value.trim();
                    if (searchQuery.length === 0) return;
                    
                    performSearch(searchQuery);
                }
            });
        }
        
        // Perform search
        function performSearch(query) {
            fetch(`/api/library/search?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(results => {
                    // Create content for popup
                    const popupContent = document.getElementById('popup-content');
                    
                    if (results.length === 0) {
                        popupContent.innerHTML = `
                            <h2 style="text-align:center;margin-bottom:1rem;">Search Results</h2>
                            <p style="text-align:center;">No results found for "${query}"</p>
                        `;
                    } else {
                        popupContent.innerHTML = `
                            <h2 style="text-align:center;margin-bottom:1rem;">Search Results</h2>
                            <div class="anime-grid" style="grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));" id="search-results"></div>
                        `;
                        
                        const searchResults = document.getElementById('search-results');
                        
                        results.forEach(anime => {
                            const animeCard = createAnimeCard(anime);
                            searchResults.appendChild(animeCard);
                        });
                    }
                    
                    // Show popup
                    document.getElementById('popup-backdrop').classList.remove('hidden');
                    document.getElementById('anime-details-popup').classList.remove('hidden');
                })
                .catch(error => console.error('Error searching:', error));
        }
    </script>
</body>
</html>
