<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Tagalog</title>
    <!-- Outfit Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        outfit: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            DEFAULT: '#111827',
                            lighter: '#1f2937',
                            card: '#374151',
                        },
                        accent: {
                            DEFAULT: '#3b82f6',
                            hover: '#2563eb',
                        }
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #111827;
            color: #f9fafb;
        }
        
        .anime-card {
            transition: all 0.3s ease;
        }
        
        .anime-card:hover {
            transform: translateY(-5px);
        }
        
        .anime-cover {
            aspect-ratio: 3/4;
            object-fit: cover;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .animate-pulse-slow {
            animation: pulse 3s infinite;
        }
        
        @keyframes slideIn {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease-in-out;
        }
        
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        .poster-overlay {
            background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
        }

        .active-nav {
            color: white;
            background-color: rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center backdrop-blur-sm transition-all duration-300">
        <div class="flex flex-col items-center">
            <div class="rounded-full w-16 h-16 border-4 border-accent border-t-transparent animate-spin"></div>
            <p class="mt-4 text-lg font-medium">Loading...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Main Container -->
    <div class="flex flex-col sm:flex-row min-h-screen">
        <!-- Mobile Navigation Bar -->
        <div class="sm:hidden fixed bottom-0 left-0 right-0 bg-dark-lighter border-t border-gray-700 z-30">
            <div class="flex justify-around py-2">
                <button class="flex flex-col items-center py-2 px-3 rounded-lg transition-all duration-200 text-white active-nav" data-view="home">
                    <i class="ph ph-house text-xl"></i>
                    <span class="text-xs mt-1">Home</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 rounded-lg transition-all duration-200 text-gray-400 hover:text-white" data-view="trending">
                    <i class="ph ph-trend-up text-xl"></i>
                    <span class="text-xs mt-1">Trending</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 rounded-lg transition-all duration-200 text-gray-400 hover:text-white" data-view="search">
                    <i class="ph ph-magnifying-glass text-xl"></i>
                    <span class="text-xs mt-1">Search</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 rounded-lg transition-all duration-200 text-gray-400 hover:text-white" data-view="library">
                    <i class="ph ph-books text-xl"></i>
                    <span class="text-xs mt-1">Library</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 rounded-lg transition-all duration-200 text-gray-400 hover:text-white" data-view="schedule">
                    <i class="ph ph-calendar text-xl"></i>
                    <span class="text-xs mt-1">Schedule</span>
                </button>
            </div>
        </div>

        <!-- Sidebar (Desktop) -->
        <aside class="hidden sm:flex flex-col w-64 bg-dark-lighter border-r border-gray-700 fixed h-full z-30">
            <!-- Logo -->
            <div class="flex items-center px-6 py-4 border-b border-gray-700">
                <i class="ph ph-film-strip text-accent text-2xl"></i>
                <h1 class="ml-2 text-xl font-bold">Anime Tagalog</h1>
            </div>
            
            <!-- Nav Links -->
            <nav class="flex-1 px-4 py-4">
                <div class="space-y-2">
                    <button class="flex items-center w-full text-left py-2 px-3 rounded-lg transition-all duration-200 text-white active-nav" data-view="home">
                        <i class="ph ph-house mr-2 text-lg"></i>
                        Home
                    </button>
                    <button class="flex items-center w-full text-left py-2 px-3 rounded-lg transition-all duration-200 text-gray-400 hover:text-white hover:bg-dark-card" data-view="trending">
                        <i class="ph ph-trend-up mr-2 text-lg"></i>
                        Trending
                    </button>
                    <button class="flex items-center w-full text-left py-2 px-3 rounded-lg transition-all duration-200 text-gray-400 hover:text-white hover:bg-dark-card" data-view="search">
                        <i class="ph ph-magnifying-glass mr-2 text-lg"></i>
                        Search
                    </button>
                    <button class="flex items-center w-full text-left py-2 px-3 rounded-lg transition-all duration-200 text-gray-400 hover:text-white hover:bg-dark-card" data-view="library">
                        <i class="ph ph-books mr-2 text-lg"></i>
                        My Library
                    </button>
                    <button class="flex items-center w-full text-left py-2 px-3 rounded-lg transition-all duration-200 text-gray-400 hover:text-white hover:bg-dark-card" data-view="schedule">
                        <i class="ph ph-calendar mr-2 text-lg"></i>
                        Schedule
                    </button>
                </div>
                
                <div class="mt-8">
                    <h3 class="px-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Genres</h3>
                    <div class="mt-2 space-y-1 max-h-60 overflow-y-auto scrollbar-hide" id="genresList">
                        <!-- Genres will be populated here -->
                        <div class="animate-pulse">
                            <div class="h-5 bg-gray-700 rounded my-1 w-24"></div>
                            <div class="h-5 bg-gray-700 rounded my-1 w-20"></div>
                            <div class="h-5 bg-gray-700 rounded my-1 w-28"></div>
                            <div class="h-5 bg-gray-700 rounded my-1 w-16"></div>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- Server Status -->
            <div class="px-4 py-3 bg-dark border-t border-gray-700">
                <div class="flex items-center text-sm">
                    <div id="serverStatus" class="flex items-center">
                        <span class="flex h-2 w-2 relative mr-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                        </span>
                        Connecting...
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 sm:ml-64 pb-16 sm:pb-0">
            <!-- Home View -->
            <section id="homeView" class="p-4 sm:p-6 animate-slide-in">
                <!-- Hero Banner -->
                <div class="relative rounded-xl overflow-hidden mb-8 h-64 sm:h-96">
                    <div id="heroBanner" class="w-full h-full bg-gradient-to-r from-dark-lighter to-dark-card flex items-center">
                        <div class="animate-pulse flex flex-col w-full h-full justify-end p-6">
                            <div class="h-8 bg-gray-700 rounded w-64 mb-2"></div>
                            <div class="h-4 bg-gray-700 rounded w-48 mb-4"></div>
                            <div class="h-10 bg-gray-700 rounded w-32"></div>
                        </div>
                    </div>
                </div>

                <!-- Featured Section -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold">Featured Anime</h2>
                        <button class="text-sm text-accent hover:text-accent-hover transition-colors">View All</button>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4" id="featuredAnime">
                        <!-- Anime cards will be populated here -->
                        <!-- Loading skeletons -->
                        <div class="animate-pulse bg-dark-card rounded-lg overflow-hidden">
                            <div class="bg-gray-700 h-56 w-full"></div>
                            <div class="p-3">
                                <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-700 rounded w-1/2"></div>
                            </div>
                        </div>
                        <div class="animate-pulse bg-dark-card rounded-lg overflow-hidden">
                            <div class="bg-gray-700 h-56 w-full"></div>
                            <div class="p-3">
                                <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-700 rounded w-1/2"></div>
                            </div>
                        </div>
                        <div class="animate-pulse bg-dark-card rounded-lg overflow-hidden hidden sm:block">
                            <div class="bg-gray-700 h-56 w-full"></div>
                            <div class="p-3">
                                <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-700 rounded w-1/2"></div>
                            </div>
                        </div>
                        <div class="animate-pulse bg-dark-card rounded-lg overflow-hidden hidden md:block">
                            <div class="bg-gray-700 h-56 w-full"></div>
                            <div class="p-3">
                                <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-700 rounded w-1/2"></div>
                            </div>
                        </div>
                        <div class="animate-pulse bg-dark-card rounded-lg overflow-hidden hidden lg:block">
                            <div class="bg-gray-700 h-56 w-full"></div>
                            <div class="p-3">
                                <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-700 rounded w-1/2"></div>
                            </div>
                        </div>
                        <div class="animate-pulse bg-dark-card rounded-lg overflow-hidden hidden xl:block">
                            <div class="bg-gray-700 h-56 w-full"></div>
                            <div class="p-3">
                                <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-700 rounded w-1/2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Updates -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold">Recent Updates</h2>
                        <button class="text-sm text-accent hover:text-accent-hover transition-colors">View All</button>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4" id="recentUpdates">
                        <!-- Anime cards will be populated here -->
                        <!-- Loading skeletons (same as above) -->
                        <div class="animate-pulse bg-dark-card rounded-lg overflow-hidden">
                            <div class="bg-gray-700 h-56 w-full"></div>
                            <div class="p-3">
                                <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-700 rounded w-1/2"></div>
                            </div>
                        </div>
                        <div class="animate-pulse bg-dark-card rounded-lg overflow-hidden">
                            <div class="bg-gray-700 h-56 w-full"></div>
                            <div class="p-3">
                                <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-700 rounded w-1/2"></div>
                            </div>
                        </div>
                        <div class="animate-pulse bg-dark-card rounded-lg overflow-hidden hidden sm:block">
                            <div class="bg-gray-700 h-56 w-full"></div>
                            <div class="p-3">
                                <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-700 rounded w-1/2"></div>
                            </div>
                        </div>
                        <div class="animate-pulse bg-dark-card rounded-lg overflow-hidden hidden md:block">
                            <div class="bg-gray-700 h-56 w-full"></div>
                            <div class="p-3">
                                <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-700 rounded w-1/2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Trending View -->
            <section id="trendingView" class="hidden p-4 sm:p-6 animate-slide-in">
                <h1 class="text-2xl font-bold mb-4">Trending Anime</h1>
                <div class="flex flex-wrap gap-2 mb-4">
                    <button class="px-3 py-1 bg-accent text-white rounded-full text-sm">All</button>
                    <button class="px-3 py-1 bg-dark-card text-gray-300 hover:bg-accent hover:text-white transition-colors rounded-full text-sm">This Season</button>
                    <button class="px-3 py-1 bg-dark-card text-gray-300 hover:bg-accent hover:text-white transition-colors rounded-full text-sm">Upcoming</button>
                    <button class="px-3 py-1 bg-dark-card text-gray-300 hover:bg-accent hover:text-white transition-colors rounded-full text-sm">Popular</button>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4" id="trendingAnime">
                    <!-- Anime cards will be populated here -->
                    <!-- Loading skeletons (similar to home view) -->
                </div>
            </section>

            <!-- Search View -->
            <section id="searchView" class="hidden p-4 sm:p-6 animate-slide-in">
                <h1 class="text-2xl font-bold mb-4">Search Anime</h1>
                <div class="relative mb-6">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchInput" class="w-full bg-dark-card border border-gray-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-accent" placeholder="Search by title...">
                </div>

                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2">Filters</h3>
                    <div class="flex flex-wrap gap-2">
                        <select id="genreFilter" class="bg-dark-card border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="">Genre (All)</option>
                            <!-- Will be populated dynamically -->
                        </select>
                        <select id="seasonFilter" class="bg-dark-card border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="">Season (All)</option>
                            <option value="WINTER">Winter</option>
                            <option value="SPRING">Spring</option>
                            <option value="SUMMER">Summer</option>
                            <option value="FALL">Fall</option>
                        </select>
                        <select id="yearFilter" class="bg-dark-card border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="">Year (All)</option>
                            <!-- Will be populated dynamically with years -->
                        </select>
                        <select id="statusFilter" class="bg-dark-card border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="">Status (All)</option>
                            <option value="RELEASING">Currently Airing</option>
                            <option value="FINISHED">Finished</option>
                            <option value="NOT_YET_RELEASED">Upcoming</option>
                            <option value="CANCELLED">Cancelled</option>
                        </select>
                    </div>
                </div>

                <div id="searchResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <div class="col-span-full text-center py-12 text-gray-400">
                        <i class="ph ph-magnifying-glass text-5xl mb-3"></i>
                        <p>Search for anime to get started</p>
                    </div>
                </div>

                <div id="searchPagination" class="hidden mt-6 flex justify-center">
                    <div class="flex space-x-2">
                        <button id="prevPage" class="px-4 py-2 rounded-lg bg-dark-card text-white hover:bg-accent transition-colors">
                            <i class="ph ph-caret-left"></i> Prev
                        </button>
                        <div id="pageIndicator" class="px-4 py-2 rounded-lg bg-dark-card text-white">
                            Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                        </div>
                        <button id="nextPage" class="px-4 py-2 rounded-lg bg-dark-card text-white hover:bg-accent transition-colors">
                            Next <i class="ph ph-caret-right"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Library View -->
            <section id="libraryView" class="hidden p-4 sm:p-6 animate-slide-in">
                <h1 class="text-2xl font-bold mb-4">My Library</h1>
                <div id="libraryEmptyState" class="hidden text-center py-12">
                    <i class="ph ph-books text-5xl mb-3 text-gray-400"></i>
                    <p class="text-gray-400 mb-4">Your library is empty</p>
                    <button id="exploreAnimeBtn" class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-accent-hover transition-colors">
                        Explore Anime
                    </button>
                </div>
                <div id="libraryContent" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <!-- Library items will be populated here -->
                </div>
            </section>

            <!-- Schedule View -->
            <section id="scheduleView" class="hidden p-4 sm:p-6 animate-slide-in">
                <h1 class="text-2xl font-bold mb-4">Schedule</h1>
                
                <div class="flex justify-between items-center mb-4">
                    <button id="addToScheduleBtn" class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-accent-hover transition-colors">
                        <i class="ph ph-plus mr-1"></i> Add to Schedule
                    </button>
                    <div>
                        <select id="scheduleFilter" class="bg-dark-card border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="all">All Scheduled</option>
                            <option value="upcoming">Upcoming</option>
                            <option value="today">Today</option>
                            <option value="past">Past</option>
                        </select>
                    </div>
                </div>
                
                <div id="scheduleEmptyState" class="hidden text-center py-12">
                    <i class="ph ph-calendar text-5xl mb-3 text-gray-400"></i>
                    <p class="text-gray-400 mb-4">No scheduled anime</p>
                    <button id="addFirstScheduleBtn" class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-accent-hover transition-colors">
                        Schedule Your First Anime
                    </button>
                </div>
                
                <div id="scheduleContent">
                    <!-- Schedule items will be populated here -->
                </div>
            </section>

            <!-- Anime Detail View -->
            <section id="animeDetailView" class="hidden animate-slide-in">
                <div id="animeDetailContent">
                    <!-- Anime details will be populated here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Add to Schedule Modal -->
    <div id="scheduleModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-dark-lighter rounded-xl w-full max-w-md mx-4 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-lg font-medium">Schedule Anime</h3>
                <button id="closeScheduleModal" class="text-gray-400 hover:text-white">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label for="scheduleAnimeSearch" class="block text-sm font-medium mb-1">Search Anime</label>
                    <input type="text" id="scheduleAnimeSearch" class="w-full bg-dark-card border border-gray-700 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-accent" placeholder="Type to search...">
                    <div id="scheduleSearchResults" class="mt-2 bg-dark-card rounded-lg max-h-48 overflow-y-auto hidden">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
                <div id="selectedAnimeForSchedule" class="mb-4 hidden">
                    <div class="flex items-center bg-dark-card p-2 rounded-lg">
                        <img id="selectedAnimeImage" src="" alt="" class="w-14 h-20 object-cover rounded mr-3">
                        <div>
                            <h4 id="selectedAnimeTitle" class="font-medium"></h4>
                            <p id="selectedAnimeInfo" class="text-sm text-gray-400"></p>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="scheduleDate" class="block text-sm font-medium mb-1">Schedule Date</label>
                    <input type="date" id="scheduleDate" class="w-full bg-dark-card border border-gray-700 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-accent">
                </div>
                <div class="mb-4">
                    <label for="scheduleNotes" class="block text-sm font-medium mb-1">Notes (Optional)</label>
                    <textarea id="scheduleNotes" class="w-full bg-dark-card border border-gray-700 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-accent h-24 resize-none" placeholder="Add notes..."></textarea>
                </div>
                <button id="saveScheduleBtn" class="w-full py-2 bg-accent text-white rounded-lg hover:bg-accent-hover transition-colors">
                    Save to Schedule
                </button>
            </div>
        </div>
    </div>

    <script>
        // API URL - automatically detect whether we're on localhost or deployed
        const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : '/api';
        
        // Elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const toastContainer = document.getElementById('toastContainer');
        const serverStatus = document.getElementById('serverStatus');
        
        // Views
        const homeView = document.getElementById('homeView');
        const trendingView = document.getElementById('trendingView');
        const searchView = document.getElementById('searchView');
        const libraryView = document.getElementById('libraryView');
        const scheduleView = document.getElementById('scheduleView');
        const animeDetailView = document.getElementById('animeDetailView');
        
        // Navigation buttons
        const navButtons = document.querySelectorAll('[data-view]');
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Check server status
            checkServerStatus();
            setInterval(checkServerStatus, 30000);
            
            // Load initial data
            loadInitialData();
            
            // Setup navigation
            setupNavigation();
            
            // Setup search functionality
            setupSearch();
            
            // Setup schedule modal
            setupScheduleModal();
        });
        
        // Helper function to show/hide loading overlay
        function toggleLoading(show) {
            if (show) {
                loadingOverlay.style.display = 'flex';
            } else {
                loadingOverlay.style.display = 'none';
            }
        }
        
        // Show a toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.classList.add('bg-dark-card', 'text-white', 'rounded-lg', 'shadow-lg', 'px-4', 'py-3', 'flex', 'items-center');
            
            let icon = '';
            if (type === 'success') {
                icon = '<i class="ph ph-check-circle text-green-500 mr-2 text-lg"></i>';
            } else if (type === 'error') {
                icon = '<i class="ph ph-x-circle text-red-500 mr-2 text-lg"></i>';
            } else if (type === 'info') {
                icon = '<i class="ph ph-info text-blue-500 mr-2 text-lg"></i>';
            }
            
            toast.innerHTML = `${icon} <span>${message}</span>`;
            toastContainer.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                setTimeout(() => {
                    toast.remove();
                }, 500);
            }, 3000);
        }
        
        // Check server status
        function checkServerStatus() {
            fetch(`${window.location.origin}/health`)
                .then(response => {
                    if (response.ok) {
                        serverStatus.innerHTML = `
                            <span class="flex h-2 w-2 relative mr-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                            Server Online
                        `;
                        return response.json();
                    } else {
                        throw new Error('Server Error');
                    }
                })
                .catch(error => {
                    serverStatus.innerHTML = `
                        <span class="flex h-2 w-2 relative mr-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                        </span>
                        Server Offline
                    `;
                });
        }
        
        // Setup navigation
        function setupNavigation() {
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const view = button.getAttribute('data-view');
                    
                    // Hide all views
                    homeView.classList.add('hidden');
                    trendingView.classList.add('hidden');
                    searchView.classList.add('hidden');
                    libraryView.classList.add('hidden');
                    scheduleView.classList.add('hidden');
                    animeDetailView.classList.add('hidden');
                    
                    // Remove active class from all nav buttons
                    navButtons.forEach(btn => {
                        btn.classList.remove('active-nav');
                        btn.classList.add('text-gray-400');
                        btn.classList.remove('text-white');
                    });
                    
                    // Add active class to clicked button
                    button.classList.add('active-nav');
                    button.classList.add('text-white');
                    button.classList.remove('text-gray-400');
                    
                    // Show selected view
                    if (view === 'home') {
                        homeView.classList.remove('hidden');
                        if (homeView.querySelector('#featuredAnime').children.length <= 6) {
                            loadHomeData();
                        }
                    } else if (view === 'trending') {
                        trendingView.classList.remove('hidden');
                        if (trendingView.querySelector('#trendingAnime').children.length <= 6) {
                            loadTrendingData();
                        }
                    } else if (view === 'search') {
                        searchView.classList.remove('hidden');
                        // Load genres if not already loaded
                        if (!document.querySelector('#genreFilter').children.length > 1) {
                            loadGenres();
                        }
                    } else if (view === 'library') {
                        libraryView.classList.remove('hidden');
                        loadLibraryData();
                    } else if (view === 'schedule') {
                        scheduleView.classList.remove('hidden');
                        loadScheduleData();
                    }
                });
            });
            
            // Handler for explore anime button
            document.getElementById('exploreAnimeBtn').addEventListener('click', () => {
                document.querySelector('[data-view="trending"]').click();
            });
            
            // Handler for add first schedule button
            document.getElementById('addFirstScheduleBtn').addEventListener('click', () => {
                openScheduleModal();
            });
        }
        
        // Load initial data
        function loadInitialData() {
            // Load home data
            loadHomeData();
            
            // Load genres for sidebar
            loadGenresList();
        }
        
        // Load home data
        function loadHomeData() {
            toggleLoading(true);
            
            // Load hero banner
            loadHeroBanner();
            
            // Load featured anime
            Promise.all([
                fetch(`${API_URL}/trending`).then(res => res.json()),
                fetch(`${API_URL}/anime`).then(res => res.json())
            ])
            .then(([trendingData, libraryData]) => {
                renderFeaturedAnime(trendingData.slice(0, 6));
                renderRecentUpdates(libraryData.slice(0, 6));
                toggleLoading(false);
            })
            .catch(error => {
                console.error('Error loading home data:', error);
                showToast('Failed to load home data', 'error');
                toggleLoading(false);
            });
        }
        
        // Load a random popular anime for the hero banner
        function loadHeroBanner() {
            fetch(`${API_URL}/trending`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.length > 0) {
                        // Pick a random anime from top 5
                        const randomIndex = Math.floor(Math.random() * Math.min(5, data.length));
                        const featuredAnime = data[randomIndex];
                        
                        // Create hero banner
                        const heroBanner = document.getElementById('heroBanner');
                        heroBanner.style.backgroundImage = `linear-gradient(to bottom, rgba(17, 24, 39, 0.2), rgba(17, 24, 39, 0.8)), url(${featuredAnime.imageBanner || featuredAnime.thumbnail})`;
                        heroBanner.style.backgroundSize = 'cover';
                        heroBanner.style.backgroundPosition = 'center';
                        
                        // Add content
                        heroBanner.innerHTML = `
                            <div class="w-full h-full flex flex-col justify-end p-6">
                                <h2 class="text-2xl sm:text-3xl font-bold mb-2">${featuredAnime.title}</h2>
                                <p class="text-gray-300 mb-4 line-clamp-2">${featuredAnime.description?.substring(0, 150)}...</p>
                                <button class="bg-accent hover:bg-accent-hover text-white px-4 py-2 rounded-lg transition-colors inline-flex items-center w-fit" onclick="showAnimeDetails('${featuredAnime.id}')">
                                    <i class="ph ph-play-circle mr-2"></i> Details
                                </button>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading hero banner:', error);
                });
        }
        
        // Render featured anime
        function renderFeaturedAnime(animeList) {
            const container = document.getElementById('featuredAnime');
            container.innerHTML = '';
            
            animeList.forEach(anime => {
                const card = createAnimeCard(anime);
                container.appendChild(card);
            });
        }
        
        // Render recent updates
        function renderRecentUpdates(animeList) {
            const container = document.getElementById('recentUpdates');
            container.innerHTML = '';
            
            if (animeList.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i class="ph ph-clock-counter-clockwise text-4xl text-gray-500 mb-2"></i>
                        <p class="text-gray-400">No recent updates</p>
                    </div>
                `;
                return;
            }
            
            animeList.forEach(anime => {
                const card = createAnimeCard(anime);
                container.appendChild(card);
            });
        }
        
        // Create an anime card element
        function createAnimeCard(anime) {
            const card = document.createElement('div');
            card.className = 'anime-card bg-dark-card rounded-lg overflow-hidden';
            card.setAttribute('data-anime-id', anime.id);
            
            // Determine status badge
            let statusBadge = '';
            if (anime.status) {
                let badgeClass = '';
                let statusText = '';
                
                switch(anime.status) {
                    case 'RELEASING':
                    case 'CURRENTLY':
                        badgeClass = 'bg-green-500';
                        statusText = 'Airing';
                        break;
                    case 'FINISHED':
                    case 'COMPLETED':
                        badgeClass = 'bg-blue-500';
                        statusText = 'Completed';
                        break;
                    case 'NOT_YET_RELEASED':
                    case 'UPCOMING':
                        badgeClass = 'bg-yellow-500';
                        statusText = 'Upcoming';
                        break;
                    case 'CANCELLED':
                        badgeClass = 'bg-red-500';
                        statusText = 'Cancelled';
                        break;
                    default:
                        badgeClass = 'bg-gray-500';
                        statusText = anime.status;
                }
                
                statusBadge = `<span class="status-indicator ${badgeClass} text-xs py-1 px-2 rounded-full">${statusText}</span>`;
            }
            
            // Use the next airing episode info if available
            let airingInfo = '';
            if (anime.nextAiring) {
                const nextEpisode = anime.nextAiring.episode;
                const airingDate = new Date(anime.nextAiring.airingAt);
                const timeUntil = getTimeUntilAiring(anime.nextAiring.timeUntilAiring);
                
                airingInfo = `<div class="text-xs text-gray-400 mt-1">Ep ${nextEpisode} in ${timeUntil}</div>`;
            }
            
            card.innerHTML = `
                <div class="relative">
                    <img src="${anime.thumbnail}" alt="${anime.title}" class="anime-cover w-full">
                    ${statusBadge}
                </div>
                <div class="p-3">
                    <h3 class="font-medium text-sm line-clamp-2">${anime.title}</h3>
                    ${airingInfo}
                </div>
            `;
            
            // Add click event
            card.addEventListener('click', () => {
                showAnimeDetails(anime.id);
            });
            
            return card;
        }
        
        // Format time until airing
        function getTimeUntilAiring(seconds) {
            if (!seconds) return 'Unknown';
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) {
                return `${days}d ${hours}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
        
        // Load genres for sidebar
        function loadGenresList() {
            fetch(`${API_URL}/genres`)
                .then(res => res.json())
                .then(genres => {
                    const container = document.getElementById('genresList');
                    container.innerHTML = '';
                    
                    genres.forEach(genre => {
                        const button = document.createElement('button');
                        button.className = 'block w-full text-left px-2 py-1 text-gray-300 hover:text-white hover:bg-dark-card rounded transition-colors text-sm';
                        button.textContent = genre;
                        
                        button.addEventListener('click', () => {
                            // Set search filter and navigate to search view
                            document.getElementById('genreFilter').value = genre;
                            document.querySelector('[data-view="search"]').click();
                            // Trigger search with this genre
                            setTimeout(() => {
                                document.getElementById('searchInput').focus();
                                searchAnime(1);
                            }, 300);
                        });
                        
                        container.appendChild(button);
                    });
                })
                .catch(error => {
                    console.error('Error loading genres:', error);
                });
        }
        
        // Load trending data
        function loadTrendingData() {
            toggleLoading(true);
            
            fetch(`${API_URL}/trending`)
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('trendingAnime');
                    container.innerHTML = '';
                    
                    if (data.length === 0) {
                        container.innerHTML = `
                            <div class="col-span-full text-center py-12">
                                <i class="ph ph-trend-up text-5xl text-gray-500 mb-3"></i>
                                <p class="text-gray-400">No trending anime found</p>
                            </div>
                        `;
                    } else {
                        data.forEach(anime => {
                            const card = createAnimeCard(anime);
                            container.appendChild(card);
                        });
                    }
                    
                    toggleLoading(false);
                })
                .catch(error => {
                    console.error('Error loading trending data:', error);
                    showToast('Failed to load trending anime', 'error');
                    toggleLoading(false);
                });
        }
        
        // Load library data
        function loadLibraryData() {
            toggleLoading(true);
            
            fetch(`${API_URL}/anime`)
                .then(res => res.json())
                .then(data => {
                    const emptyState = document.getElementById('libraryEmptyState');
                    const content = document.getElementById('libraryContent');
                    
                    if (data.length === 0) {
                        emptyState.classList.remove('hidden');
                        content.innerHTML = '';
                    } else {
                        emptyState.classList.add('hidden');
                        content.innerHTML = '';
                        
                        data.forEach(anime => {
                            const card = createAnimeCard(anime);
                            content.appendChild(card);
                        });
                    }
                    
                    toggleLoading(false);
                })
                .catch(error => {
                    console.error('Error loading library data:', error);
                    showToast('Failed to load library', 'error');
                    toggleLoading(false);
                });
        }
        
        // Load schedule data
        function loadScheduleData() {
            toggleLoading(true);
            
            fetch(`${API_URL}/scheduled`)
                .then(res => res.json())
                .then(data => {
                    const emptyState = document.getElementById('scheduleEmptyState');
                    const content = document.getElementById('scheduleContent');
                    
                    if (data.length === 0) {
                        emptyState.classList.remove('hidden');
                        content.innerHTML = '';
                    } else {
                        emptyState.classList.add('hidden');
                        content.innerHTML = '';
                        
                        // Group by date
                        const grouped = groupSchedulesByDate(data);
                        
                        // Render each date group
                        Object.keys(grouped).sort().forEach(date => {
                            const dateItems = grouped[date];
                            const formattedDate = formatScheduleDate(date);
                            
                            const dateSection = document.createElement('div');
                            dateSection.className = 'mb-6';
                            dateSection.innerHTML = `
                                <h3 class="text-lg font-medium mb-3">${formattedDate}</h3>
                                <div class="space-y-3">
                                    ${dateItems.map(item => createScheduleItem(item)).join('')}
                                </div>
                            `;
                            
                            content.appendChild(dateSection);
                        });
                    }
                    
                    toggleLoading(false);
                })
                .catch(error => {
                    console.error('Error loading schedule data:', error);
                    showToast('Failed to load schedule', 'error');
                    toggleLoading(false);
                });
        }
        
        // Group schedules by date
        function groupSchedulesByDate(schedules) {
            const grouped = {};
            
            schedules.forEach(schedule => {
                const date = schedule.scheduledDate.split('T')[0];
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(schedule);
            });
            
            return grouped;
        }
        
        // Format schedule date
        function formatScheduleDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Format date as "Today", "Tomorrow", or date string
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return 'Tomorrow';
            } else {
                return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            }
        }
        
        // Create schedule item HTML
        function createScheduleItem(item) {
            return `
                <div class="bg-dark-card rounded-lg overflow-hidden flex" data-schedule-id="${item.id}" data-anime-id="${item.anilistId}">
                    <img src="${item.thumbnail}" alt="${item.title}" class="h-24 w-16 object-cover">
                    <div class="flex-1 p-3 flex flex-col">
                        <h4 class="font-medium">${item.title}</h4>
                        ${item.customNote ? `<p class="text-sm text-gray-400 mt-1">${item.customNote}</p>` : ''}
                        <div class="mt-auto flex justify-between items-center">
                            <button class="text-accent hover:text-accent-hover transition-colors text-sm" onclick="showAnimeDetails('${item.anilistId}')">
                                <i class="ph ph-info mr-1"></i> Details
                            </button>
                            <button class="text-red-500 hover:text-red-400 transition-colors" onclick="removeSchedule('${item.id}')">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Remove schedule item
        function removeSchedule(scheduleId) {
            if (confirm('Are you sure you want to remove this scheduled item?')) {
                toggleLoading(true);
                
                fetch(`${API_URL}/scheduled/${scheduleId}`, {
                    method: 'DELETE'
                })
                .then(res => res.json())
                .then(data => {
                    showToast('Schedule removed successfully', 'success');
                    loadScheduleData();
                })
                .catch(error => {
                    console.error('Error removing schedule:', error);
                    showToast('Failed to remove schedule', 'error');
                    toggleLoading(false);
                });
            }
        }
        
        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const genreFilter = document.getElementById('genreFilter');
            const seasonFilter = document.getElementById('seasonFilter');
            const yearFilter = document.getElementById('yearFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            // Populate year filter with last 20 years
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= currentYear - 20; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            }
            
            // Load genres for filter
            loadGenres();
            
            // Add event listeners for search and filters
            searchInput.addEventListener('keyup', event => {
                if (event.key === 'Enter') {
                    searchAnime(1);
                }
            });
            
            // Filters change event
            [genreFilter, seasonFilter, yearFilter, statusFilter].forEach(filter => {
                filter.addEventListener('change', () => searchAnime(1));
            });
            
            // Pagination
            document.getElementById('prevPage').addEventListener('click', () => {
                const currentPage = parseInt(document.getElementById('currentPage').textContent);
                if (currentPage > 1) {
                    searchAnime(currentPage - 1);
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', () => {
                const currentPage = parseInt(document.getElementById('currentPage').textContent);
                const totalPages = parseInt(document.getElementById('totalPages').textContent);
                if (currentPage < totalPages) {
                    searchAnime(currentPage + 1);
                }
            });
        }
        
        // Load genres for search filter
        function loadGenres() {
            fetch(`${API_URL}/genres`)
                .then(res => res.json())
                .then(genres => {
                    const genreFilter = document.getElementById('genreFilter');
                    
                    // Keep the first option and add genres
                    const firstOption = genreFilter.options[0];
                    genreFilter.innerHTML = '';
                    genreFilter.appendChild(firstOption);
                    
                    genres.forEach(genre => {
                        const option = document.createElement('option');
                        option.value = genre;
                        option.textContent = genre;
                        genreFilter.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading genres for filter:', error);
                });
        }
        
        // Search anime
        function searchAnime(page = 1) {
            const query = document.getElementById('searchInput').value;
            const genre = document.getElementById('genreFilter').value;
            const season = document.getElementById('seasonFilter').value;
            const year = document.getElementById('yearFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            // Build query string
            let queryParams = `page=${page}&perPage=12`;
            if (query) queryParams += `&query=${encodeURIComponent(query)}`;
            if (genre) queryParams += `&genre=${encodeURIComponent(genre)}`;
            if (season) queryParams += `&season=${encodeURIComponent(season)}`;
            if (year) queryParams += `&year=${encodeURIComponent(year)}`;
            if (status) queryParams += `&status=${encodeURIComponent(status)}`;
            
            toggleLoading(true);
            
            fetch(`${API_URL}/search?${queryParams}`)
                .then(res => res.json())
                .then(data => {
                    const resultsContainer = document.getElementById('searchResults');
                    const paginationContainer = document.getElementById('searchPagination');
                    
                    resultsContainer.innerHTML = '';
                    
                    if (!data.results || data.results.length === 0) {
                        resultsContainer.innerHTML = `
                            <div class="col-span-full text-center py-12">
                                <i class="ph ph-magnifying-glass-minus text-5xl mb-3 text-gray-500"></i>
                                <p class="text-gray-400">No results found</p>
                            </div>
                        `;
                        paginationContainer.classList.add('hidden');
                    } else {
                        data.results.forEach(anime => {
                            const card = createAnimeCard(anime);
                            resultsContainer.appendChild(card);
                        });
                        
                        // Update pagination
                        document.getElementById('currentPage').textContent = data.pageInfo.currentPage;
                        document.getElementById('totalPages').textContent = data.pageInfo.lastPage;
                        paginationContainer.classList.remove('hidden');
                        
                        // Disable/enable prev/next buttons
                        document.getElementById('prevPage').disabled = data.pageInfo.currentPage <= 1;
                        document.getElementById('nextPage').disabled = !data.pageInfo.hasNextPage;
                        
                        // Update button styles
                        if (data.pageInfo.currentPage <= 1) {
                            document.getElementById('prevPage').classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            document.getElementById('prevPage').classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                        
                        if (!data.pageInfo.hasNextPage) {
                            document.getElementById('nextPage').classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            document.getElementById('nextPage').classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                    
                    toggleLoading(false);
                })
                .catch(error => {
                    console.error('Error searching anime:', error);
                    showToast('Failed to search anime', 'error');
                    toggleLoading(false);
                });
        }
        
        // Show anime details
        function showAnimeDetails(animeId) {
            toggleLoading(true);
            
            // Hide all views
            homeView.classList.add('hidden');
            trendingView.classList.add('hidden');
            searchView.classList.add('hidden');
            libraryView.classList.add('hidden');
            scheduleView.classList.add('hidden');
            
            // Show detail view
            animeDetailView.classList.remove('hidden');
            
            // Load anime details
            fetch(`${API_URL}/anime/${animeId}`)
                .then(res => res.json())
                .then(anime => {
                    // Get episodes
                    return fetch(`${API_URL}/anime/${animeId}/episodes`)
                        .then(res => res.json())
                        .then(episodes => {
                            renderAnimeDetails(anime, episodes);
                            toggleLoading(false);
                        });
                })
                .catch(error => {
                    console.error('Error loading anime details:', error);
                    showToast('Failed to load anime details', 'error');
                    toggleLoading(false);
                });
        }
        
        // Render anime details
        function renderAnimeDetails(anime, episodes) {
            const container = document.getElementById('animeDetailContent');
            
            // Format episodes count
            let episodesInfo = anime.episodeCount;
            if (anime.episodeCount === "Unknown" && anime.status === "RELEASING") {
                episodesInfo = "Ongoing";
            }
            
            // Create genres badges
            const genresBadges = anime.genres.map(genre => 
                `<span class="bg-dark-card px-2 py-1 rounded text-xs mr-1 mb-1">${genre}</span>`
            ).join('');
            
            // Create related anime (if any)
            let relatedAnimeHTML = '';
            if (anime.relations && anime.relations.length > 0) {
                relatedAnimeHTML = `
                    <div class="mt-8">
                        <h3 class="text-lg font-medium mb-3">Related Anime</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                            ${anime.relations.slice(0, 5).map(relation => `
                                <div class="bg-dark-card rounded overflow-hidden">
                                    <div class="flex items-center p-2">
                                        <img src="${relation.thumbnail}" alt="${relation.title}" class="w-10 h-14 object-cover rounded mr-2">
                                        <div>
                                            <div class="text-sm font-medium line-clamp-1">${relation.title}</div>
                                            <div class="text-xs text-gray-400">${relation.type}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Sort episodes by number
            episodes.sort((a, b) => a.number - b.number);
            
            // Create episodes list
            let episodesHTML = '';
            if (episodes.length > 0) {
                episodesHTML = `
                    <div class="mt-8">
                        <h3 class="text-lg font-medium mb-3">Episodes</h3>
                        <div class="grid gap-3">
                            ${episodes.map(episode => `
                                <div class="bg-dark-card rounded-lg p-3">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <span class="bg-accent text-white text-xs px-2 py-1 rounded mr-2">EP ${episode.number}</span>
                                            <span>${episode.title || `Episode ${episode.number}`}</span>
                                        </div>
                                        <button class="bg-accent hover:bg-accent-hover text-white px-3 py-1 rounded transition-colors text-sm flex items-center">
                                            <i class="ph ph-play mr-1"></i> Play
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                episodesHTML = `
                    <div class="mt-8">
                        <h3 class="text-lg font-medium mb-3">Episodes</h3>
                        <div class="bg-dark-card rounded-lg p-4 text-center">
                            <i class="ph ph-film-slate text-3xl text-gray-500 mb-2"></i>
                            <p class="text-gray-400">No episodes available</p>
                        </div>
                    </div>
                `;
            }
            
            // Determine if in library
            fetch(`${API_URL}/anime`)
                .then(res => res.json())
                .then(libraryAnime => {
                    const isInLibrary = libraryAnime.some(a => a.id === anime.id);
                    
                    // Create the detail view
                    container.innerHTML = `
                        <div class="relative h-48 sm:h-64 md:h-80 bg-gradient-to-b from-dark-lighter to-dark">
                            ${anime.imageBanner ? 
                                `<img src="${anime.imageBanner}" alt="${anime.title}" class="w-full h-full object-cover opacity-40">` : 
                                ''}
                            <button class="absolute top-4 left-4 bg-dark-card bg-opacity-80 text-white rounded-full p-2 flex items-center justify-center hover:bg-opacity-100 transition-all" onclick="goBack()">
                                <i class="ph ph-arrow-left text-lg"></i>
                            </button>
                        </div>
                        
                        <div class="container mx-auto px-4 -mt-24 relative z-10">
                            <div class="flex flex-col sm:flex-row">
                                <div class="sm:w-48 sm:shrink-0 mb-4 sm:mb-0">
                                    <img src="${anime.thumbnail}" alt="${anime.title}" class="rounded-lg shadow-lg w-48 mx-auto">
                                </div>
                                <div class="sm:ml-6 sm:mt-24">
                                    <h1 class="text-2xl sm:text-3xl font-bold">${anime.title}</h1>
                                    <div class="flex flex-wrap mt-2">
                                        ${genresBadges}
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                                        <div>
                                            <p class="text-gray-400 text-sm">Status</p>
                                            <p>${anime.status || 'Unknown'}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-400 text-sm">Episodes</p>
                                            <p>${episodesInfo}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-400 text-sm">Season</p>
                                            <p>${anime.season} ${anime.seasonYear || ''}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-400 text-sm">Rating</p>
                                            <p class="flex items-center">
                                                ${anime.rating ? `${anime.rating} <i class="ph ph-star-fill text-yellow-500 ml-1"></i>` : 'N/A'}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2 mt-4">
                                        ${isInLibrary ? 
                                            `<button id="removeFromLibraryBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="removeFromLibrary('${anime.id}')">
                                                <i class="ph ph-x mr-1"></i> Remove from Library
                                            </button>` : 
                                            `<button id="addToLibraryBtn" class="bg-accent hover:bg-accent-hover text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="addToLibrary('${anime.id}')">
                                                <i class="ph ph-plus mr-1"></i> Add to Library
                                            </button>`
                                        }
                                        <button class="bg-dark-card hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="scheduleAnime('${anime.id}')">
                                            <i class="ph ph-calendar-plus mr-1"></i> Schedule
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-8">
                                <h3 class="text-lg font-medium mb-2">Synopsis</h3>
                                <p class="text-gray-300">${anime.description || 'No description available.'}</p>
                            </div>
                            
                            ${episodesHTML}
                            ${relatedAnimeHTML}
                        </div>
                    `;
                });
        }
        
        // Go back from anime details
        function goBack() {
            // This will go back to the previous view
            history.back();
            
            // As a fallback, go to home view if history.back() doesn't work
            setTimeout(() => {
                if (!animeDetailView.classList.contains('hidden')) {
                    document.querySelector('[data-view="home"]').click();
                }
            }, 100);
        }
        
        // Add anime to library
        function addToLibrary(animeId) {
            toggleLoading(true);
            
            fetch(`${API_URL}/anime`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ anilistId: animeId })
            })
            .then(res => res.json())
            .then(data => {
                showToast('Added to library', 'success');
                document.getElementById('addToLibraryBtn').outerHTML = `
                    <button id="removeFromLibraryBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="removeFromLibrary('${animeId}')">
                        <i class="ph ph-x mr-1"></i> Remove from Library
                    </button>
                `;
                toggleLoading(false);
            })
            .catch(error => {
                console.error('Error adding to library:', error);
                showToast('Failed to add to library', 'error');
                toggleLoading(false);
            });
        }
        
        // Remove anime from library
        function removeFromLibrary(animeId) {
            if (confirm('Are you sure you want to remove this anime from your library?')) {
                toggleLoading(true);
                
                fetch(`${API_URL}/anime/${animeId}`, {
                    method: 'DELETE'
                })
                .then(res => res.json())
                .then(data => {
                    showToast('Removed from library', 'success');
                    document.getElementById('removeFromLibraryBtn').outerHTML = `
                        <button id="addToLibraryBtn" class="bg-accent hover:bg-accent-hover text-white px-4 py-2 rounded-lg transition-colors flex items-center" onclick="addToLibrary('${animeId}')">
                            <i class="ph ph-plus mr-1"></i> Add to Library
                        </button>
                    `;
                    toggleLoading(false);
                })
                .catch(error => {
                    console.error('Error removing from library:', error);
                    showToast('Failed to remove from library', 'error');
                    toggleLoading(false);
                });
            }
        }
        
        // Schedule anime
        function scheduleAnime(animeId) {
            // Open schedule modal with this anime preselected
            fetch(`${API_URL}/anime/${animeId}`)
                .then(res => res.json())
                .then(anime => {
                    openScheduleModal(anime);
                })
                .catch(error => {
                    console.error('Error fetching anime for scheduling:', error);
                    showToast('Failed to load anime details', 'error');
                });
        }
        
        // Setup schedule modal
        function setupScheduleModal() {
            // Add to schedule button
            document.getElementById('addToScheduleBtn').addEventListener('click', () => {
                openScheduleModal();
            });
            
            // Close modal
            document.getElementById('closeScheduleModal').addEventListener('click', () => {
                closeScheduleModal();
            });
            
            // Schedule anime search
            const searchInput = document.getElementById('scheduleAnimeSearch');
            const searchResults = document.getElementById('scheduleSearchResults');
            
            searchInput.addEventListener('input', debounce(() => {
                const query = searchInput.value.trim();
                
                if (query.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                fetch(`${API_URL}/search?query=${encodeURIComponent(query)}&perPage=5`)
                    .then(res => res.json())
                    .then(data => {
                        searchResults.innerHTML = '';
                        
                        if (!data.results || data.results.length === 0) {
                            searchResults.innerHTML = `
                                <div class="p-3 text-gray-400 text-center">No results found</div>
                            `;
                        } else {
                            data.results.forEach(anime => {
                                const item = document.createElement('div');
                                item.className = 'flex items-center p-2 hover:bg-dark-lighter cursor-pointer';
                                item.innerHTML = `
                                    <img src="${anime.thumbnail}" alt="${anime.title}" class="w-10 h-14 object-cover rounded mr-2">
                                    <div>
                                        <div class="font-medium line-clamp-1">${anime.title}</div>
                                        <div class="text-xs text-gray-400">${anime.episodeCount} episodes  ${anime.status}</div>
                                    </div>
                                `;
                                
                                item.addEventListener('click', () => {
                                    selectAnimeForSchedule(anime);
                                    searchResults.classList.add('hidden');
                                    searchInput.value = anime.title;
                                });
                                
                                searchResults.appendChild(item);
                            });
                        }
                        
                        searchResults.classList.remove('hidden');
                    })
                    .catch(error => {
                        console.error('Error searching anime:', error);
                        searchResults.innerHTML = `
                            <div class="p-3 text-gray-400 text-center">Error searching anime</div>
                        `;
                        searchResults.classList.remove('hidden');
                    });
            }, 300));
            
            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
            
            // Save schedule button
            document.getElementById('saveScheduleBtn').addEventListener('click', saveSchedule);
        }
        
        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // Open schedule modal
        function openScheduleModal(preselectedAnime = null) {
            const modal = document.getElementById('scheduleModal');
            
            // Reset form
            document.getElementById('scheduleAnimeSearch').value = '';
            document.getElementById('scheduleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('scheduleNotes').value = '';
            document.getElementById('selectedAnimeForSchedule').classList.add('hidden');
            document.getElementById('scheduleSearchResults').classList.add('hidden');
            
            // If there's a preselected anime, set it
            if (preselectedAnime) {
                selectAnimeForSchedule(preselectedAnime);
                document.getElementById('scheduleAnimeSearch').value = preselectedAnime.title;
            }
            
            // Show modal
            modal.classList.remove('hidden');
        }
        
        // Close schedule modal
        function closeScheduleModal() {
            const modal = document.getElementById('scheduleModal');
            modal.classList.add('hidden');
        }
        
        // Select anime for schedule
        function selectAnimeForSchedule(anime) {
            const selectedAnimeContainer = document.getElementById('selectedAnimeForSchedule');
            document.getElementById('selectedAnimeImage').src = anime.thumbnail;
            document.getElementById('selectedAnimeTitle').textContent = anime.title;
            document.getElementById('selectedAnimeInfo').textContent = `${anime.episodeCount} episodes  ${anime.status}`;
            
            // Store anime ID as a data attribute
            selectedAnimeContainer.setAttribute('data-anime-id', anime.id);
            
            selectedAnimeContainer.classList.remove('hidden');
        }
        
        // Save schedule
        function saveSchedule() {
            const selectedAnimeContainer = document.getElementById('selectedAnimeForSchedule');
            const animeId = selectedAnimeContainer.getAttribute('data-anime-id');
            const scheduledDate = document.getElementById('scheduleDate').value;
            const notes = document.getElementById('scheduleNotes').value;
            
            if (!animeId) {
                showToast('Please select an anime', 'error');
                return;
            }
            
            if (!scheduledDate) {
                showToast('Please select a date', 'error');
                return;
            }
            
            toggleLoading(true);
            
            fetch(`${API_URL}/scheduled`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    anilistId: animeId,
                    scheduledDate: scheduledDate,
                    customNote: notes
                })
            })
            .then(res => res.json())
            .then(data => {
                showToast('Anime scheduled successfully', 'success');
                closeScheduleModal();
                
                // If we're in the schedule view, reload it
                if (!scheduleView.classList.contains('hidden')) {
                    loadScheduleData();
                }
                
                toggleLoading(false);
            })
            .catch(error => {
                console.error('Error scheduling anime:', error);
                showToast('Failed to schedule anime', 'error');
                toggleLoading(false);
            });
        }
    </script>
</body>
</html>
